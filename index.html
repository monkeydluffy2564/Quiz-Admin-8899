<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator By Kru Amorn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for Exporting & Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Libraries for File Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>

    <!-- MathJax for rendering math formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
		#message-modal { z-index: 60; } /* <-- ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ */
        .main-tab.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .generation-tab.active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Presentation Mode Styles */
        .presentation-option {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        #presentation-modal:fullscreen {
            background-color: #1f2937; /* bg-gray-800 */
        }
        /* Timer Bar */
        #timer-bar-container {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            background-color: #4f46e5;
            transition: width 1s linear;
        }
        [contenteditable="true"] {
            outline: 2px dashed #4f46e5;
            background-color: #eef2ff;
            padding: 2px;
        }
        .details-marker {
            transition: transform 0.2s;
        }
        details[open] .details-marker {
            transform: rotate(90deg);
        }
        .badge-icon {
            animation: popIn 0.5s ease-out forwards;
            transform: scale(0);
        }
        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .delete-svg-btn {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .delete-svg-btn:hover {
            opacity: 1;
        }
        /* Live Game Styles */
        .live-game-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .podium-step {
            transition: transform 0.5s ease-out;
        }
        .podium-step:hover {
            transform: translateY(-10px);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl relative">
        <!-- Admin Mode Toggle Button -->
        <button id="mode-switcher-btn" class="absolute top-4 right-4 text-gray-500 hover:text-indigo-600 transition-colors duration-300 z-10 p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°">
            <i class="fas fa-user-shield fa-lg"></i>
        </button>

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">
                <i class="fas fa-brain mr-2"></i>AI Quiz Generator
            </h1>
            <p class="text-lg text-gray-600 mt-1">By Kru Amorn</p>
            <p class="text-gray-500 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="bg-white p-6 rounded-2xl shadow-lg min-h-[400px]">
            <!-- Admin View -->
            <div id="admin-view" class="hidden fade-in">
                <!-- Project Dashboard (Default Admin View) -->
                <div id="project-dashboard-view">
                    <!-- NEW: Starred Quizzes Section -->
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-indigo-700">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                           <input type="text" id="project-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ..." class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                           <select id="project-sort-select" class="p-2 border border-gray-300 rounded-lg">
                               <option value="date_desc">‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                               <option value="date_asc">‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
                               <option value="name_asc">‡∏ä‡∏∑‡πà‡∏≠ (‡∏Å-‡∏Æ)</option>
                               <option value="name_desc">‡∏ä‡∏∑‡πà‡∏≠ (‡∏Æ-‡∏Å)</option>
                           </select>
                           <button id="create-project-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300 flex items-center shrink-0">
                               <i class="fas fa-plus-circle mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á
                           </button>
						   <button id="open-global-live-btn"
  class="bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-300 flex items-center shrink-0">
  <i class="fas fa-bolt mr-2"></i>Live Game
</button>
<button id="open-quiz-bank-btn"
  class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-300 flex items-center shrink-0">
  <i class="fas fa-book mr-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
</button>
                        </div>
                    </div>
                    <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Project cards will be inserted here -->
                        <p id="no-projects-msg" class="text-gray-500 col-span-full text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ... ‡∏Ñ‡∏•‡∏¥‡∏Å '‡∏™‡∏£‡πâ‡∏≤‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                    </div>
                </div>

                <!-- Project Detail View -->
                <div id="project-detail-view" class="hidden">
                    <button id="back-to-dashboard-btn" class="mb-4 text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard</button>
                    <h2 id="project-title" class="text-3xl font-bold text-indigo-700 mb-2"></h2>
                    <p class="text-sm text-gray-500 mb-6">Project ID: <span id="project-id-display" class="font-mono"></span></p>
                    
                    <!-- Project Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-6">
                            <button id="manage-tab" class="main-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                                <i class="fas fa-sliders-h mr-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                            </button>
                            <button id="results-tab" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-poll mr-2"></i>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                            </button>
                            <button id="leaderboard-tab" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-trophy mr-2"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥
                            </button>
                        </nav>
                    </div>

                    <!-- Manage Tab Content -->
                    <div id="manage-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column: Settings & Students -->
                            <div class="space-y-6">
                                <!-- Quiz Settings -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-3 border-b pb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)</h3>
                                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <label for="quiz-type-select" class="block text-sm font-medium text-gray-700">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</label>
                                            <select id="quiz-type-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <optgroup label="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">
                                                    <option value="multiple_choice">‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ö (‡∏Å, ‡∏Ç, ‡∏Ñ, ‡∏á)</option>
                                                    <option value="matching">‡πÅ‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠)</option>
                                                    <option value="true_false">‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î</option>
                                                </optgroup>
                                                <optgroup label="‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥">
                                                    <option value="fill_in_with_choices">‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥ (‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ)</option>
                                                    <option value="fill_in_no_choices">‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥ (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡πÄ‡∏≠‡∏á)</option>
                                                    <option value="mixed">‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥)</option>
                                                </optgroup>
                                            </select>
                                        </div>
										
										<div>
    <label for="difficulty-level-select" class="block text-sm font-medium text-gray-700">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
    <select id="difficulty-level-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
        <option value="auto" selected>‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)</option>
        
        <optgroup label="üßí ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏ê‡∏°‡∏ß‡∏±‡∏¢">
            <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1 (K1)</option>
            <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2 (K2)</option>
            <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3 (K3)</option>
        </optgroup>

        <optgroup label="üìó ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
            <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1 (‡∏õ.1)</option>
            <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2 (‡∏õ.2)</option>
            <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3 (‡∏õ.3)</option>
            <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4 (‡∏õ.4)</option>
            <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5 (‡∏õ.5)</option>
            <option value="‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6 (‡∏õ.6)</option>
        </optgroup>
        
        <optgroup label="üìò ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
            <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1 (‡∏°.1)</option>
            <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2 (‡∏°.2)</option>
            <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3 (‡∏°.3)</option>
            <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4 (‡∏°.4)</option>
            <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5 (‡∏°.5)</option>
            <option value="‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6 (‡∏°.6)</option>
        </optgroup>

        <optgroup label="üéì ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏∏‡∏î‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
            <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ</option>
            <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÇ‡∏ó">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÇ‡∏ó</option>
            <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÄ‡∏≠‡∏Å">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÄ‡∏≠‡∏Å</option>
        </optgroup>
    </select>
</div>

<div>
    <label for="question-complexity-select" class="block text-sm font-medium text-gray-700">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Bloom's Taxonomy):</label>
    <select id="question-complexity-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
        <option value="mixed" selected>‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏∞ (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</option>
        <option value="remembering">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≥ (Remembering)</option>
        <option value="understanding">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à (Understanding)</option>
        <option value="applying">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ (Applying)</option>
        <option value="analyzing">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Analyzing)</option>
        <option value="evaluating">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤ (Evaluating)</option>
        <option value="creating">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå (Creating)</option>
    </select>
</div>

<div>
    <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠):</label>
    <details class="mt-1 border border-gray-300 rounded-lg bg-white">
        <summary class="p-2 cursor-pointer text-gray-500">
            ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠... <span id="selected-topics-count" class="font-bold text-indigo-600"></span>
        </summary>
        
        <div class="sticky top-0 bg-white p-2 border-b border-gray-200 flex justify-between items-center gap-4">
            <input type="text" id="math-topic-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠..." class="w-full p-2 border border-gray-300 rounded-lg text-sm">
            <div class="flex items-center gap-3 shrink-0">
                <button id="select-all-topics-btn" class="text-xs font-semibold text-blue-600 hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button id="deselect-all-topics-btn" class="text-xs font-semibold text-gray-500 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
        <div id="math-topics-checkbox-container" class="p-3 max-h-60 overflow-y-auto">
            <p class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>
        </div>
    </details>
</div>

<div class="mt-3 p-3 bg-gray-100 rounded-lg">
    <label for="custom-math-topic-input" class="block text-sm font-medium text-gray-700 mb-1">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á:
    </label>
    <div class="flex items-center gap-2">
        <input type="text" id="custom-math-topic-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ö‡∏ó‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏•‡∏∑‡∏≠..." class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        <button id="add-custom-math-topic-btn" class="bg-blue-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-blue-700 text-sm shrink-0">
            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
        </button>
    </div>
</div>								
	
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label for="num-questions" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠:</label>
                                                <input type="number" id="num-questions" value="5" min="1" max="20" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                            </div>
                                            <div>
                                                <label for="passing-score-input" class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô:</label>
                                                <input type="number" id="passing-score-input" value="3" min="0" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                            </div>
                                        </div>
                                        <div id="num-choices-container">
                                            <label for="num-choices" class="block text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
                                            <input type="number" id="num-choices" value="4" min="2" max="6" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                        </div>
                                        <div>
                                            <label for="shuffle-setting-select" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
                                            <select id="shuffle-setting-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <option value="none">‡πÑ‡∏°‡πà‡∏™‡∏•‡∏±‡∏ö</option>
                                                <option value="questions_only">‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠</option>
                                                <option value="choices_only">‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                                <option value="both">‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                            </select>
                                        </div>
                                        <div>
    <label for="results-display-select" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
    <select id="results-display-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
        <option value="show_results_and_answers">‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</option>
        <option value="show_results_only">‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏•‡∏¢)</option>
        <option value="show_pass_fail_only">‡∏ó‡∏£‡∏≤‡∏ö‡∏ú‡∏•‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</option>
        <option value="manual_release">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•</option>
    </select>
</div>
                                        <!-- Adaptive Quiz Checkbox -->
                                        <div class="flex items-center mt-2">
                                            <input id="adaptive-quiz-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                            <label for="adaptive-quiz-checkbox" class="ml-2 block text-sm font-medium text-gray-900">
                                                ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                                            </label>
                                        </div>
                                        <div class="border-t pt-4 mt-2">
                                            <label for="timer-mode-select" class="block text-sm font-medium text-gray-700">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤:</label>
                                            <select id="timer-mode-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</option>
                                                <option value="whole_quiz">‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                                                <option value="per_question">‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                                            </select>
                                            <div id="timer-duration-container" class="mt-2 hidden">
                                                <label for="timer-duration-input" id="timer-duration-label" class="block text-sm font-medium text-gray-700">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</label>
                                                <input type="number" id="timer-duration-input" value="10" min="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                            </div>
                                        </div>
                                        <button id="save-settings-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-teal-700 transition-colors text-sm">
                                            <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                                        </button>
                                    </div>
                                </div>
                                <!-- Student Management -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-3 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <div class="flex flex-col gap-2 mb-3">
                                            <label for="student-name-input" class="text-sm font-medium text-gray-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î):</label>
                                            <textarea id="student-name-input" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ&#10;‡∏™‡∏°‡∏®‡∏£‡∏µ ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç"></textarea>
                                            <button id="add-student-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 self-end"><i class="fas fa-user-plus mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
                                        </div>
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-semibold text-sm">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</h4>
                                            <button id="delete-all-students-btn" class="text-red-600 hover:text-red-800 text-xs font-semibold py-1 px-2 rounded-md bg-red-100 hover:bg-red-200 transition-colors hidden"><i class="fas fa-trash-alt mr-1"></i>‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                        </div>
                                        <div id="student-list" class="max-h-40 overflow-y-auto space-y-1 text-sm p-2 bg-white border rounded-md">
                                            <!-- Student names will be here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Quiz Generation -->
                            <div>
                                <h3 class="text-xl font-semibold mb-3 border-b pb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
                                <div id="quiz-generation-container" class="p-4 bg-gray-50 rounded-lg">
                                    <!-- Generation Tabs -->
                                    <div class="flex border-b mb-4 flex-wrap">
                                        <button id="topic-tab" class="generation-tab py-2 px-4 font-semibold active"><i class="fas fa-lightbulb mr-2"></i>‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</button>
                                        <button id="text-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-file-alt mr-2"></i>‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
                                        <button id="file-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-file-upload mr-2"></i>‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
                                        <button id="link-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-link mr-2"></i>‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
										<button id="blueprint-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-map-marked-alt mr-2"></i>‡∏à‡∏≤‡∏Å Test Blueprint</button>
										<button id="parallel-test-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-clone mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô</button>
                                        <button id="worksheet-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-print mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</button>
                                    </div>

<div id="blueprint-input-area" class="hidden space-y-4">
    <label for="blueprint-upload-input" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Test Blueprint (.pdf):</label>
    <input type="file" id="blueprint-upload-input" class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept=".pdf">
    <p class="text-xs text-gray-500">AI ‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠, ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ï‡∏≤‡∏° Blueprint</p>

    <button id="generate-from-blueprint-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
        <i class="fas fa-cogs mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏° Blueprint
    </button>
</div>

<div id="parallel-test-input-area" class="hidden space-y-4">
    <label for="parallel-test-upload-input" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (.pdf):</label>
    <input type="file" id="parallel-test-upload-input" class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept=".pdf">
    <p class="text-xs text-gray-500">AI ‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ä‡∏∏‡∏î</p>

    <button id="generate-from-parallel-test-btn" class="w-full bg-teal-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-teal-700 flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
        <i class="fas fa-cogs mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô
    </button>
</div>

                                     <div class="flex items-center mb-4">
    <input id="force-math-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
    <label for="force-math-checkbox" class="ml-3 block text-sm font-medium text-gray-800">
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå)
    </label>
</div>
                                    <!-- NEW: Checkbox for including images -->
                                    <div class="flex items-center my-4">
                                        <input id="include-images-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="include-images-checkbox" class="ml-3 block text-sm font-medium text-gray-800">
                                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡∏Å‡∏£‡∏≤‡∏ü, ‡∏Ø‡∏•‡∏Ø)
                                        </label>
                                    </div>
                                    <!-- Topic Input -->
                                    <div id="topic-input-area" class="space-y-4">
                                        <input type="text" id="topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ö‡∏ó‡∏û‡∏µ‡∏ó‡∏≤‡πÇ‡∏Å‡∏£‡∏±‡∏™">
                                        <button id="generate-from-topic-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 flex items-center justify-center"><i class="fas fa-cogs mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                                    </div>
                                    <!-- Text Input -->
                                    <div id="text-input-area" class="hidden space-y-4">
                                        <textarea id="text-content-input" rows="6" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                                        <button id="generate-from-text-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 flex items-center justify-center"><i class="fas fa-cogs mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                                    </div>
                                    <!-- File Input -->
                                    <div id="file-input-area" class="hidden space-y-4">
    <label for="file-upload-input" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠ Word (.docx):</label>
    <input type="file" id="file-upload-input" class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept=".pdf,.docx">
    <input type="text" id="file-topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)...">
    <p class="text-xs text-gray-500">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</p>

    <button id="generate-from-file-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
        <i class="fas fa-cogs mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    </button>
</div>
                                    <!-- Link Input -->
                                    <div id="link-input-area" class="hidden space-y-4">
                                        <input type="url" id="link-url-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                                        <input type="text" id="link-topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥)...">
                                        <button id="generate-from-link-btn" class="w-full bg-cyan-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-cyan-700 flex items-center justify-center">
                                            <i class="fas fa-cogs mr-2"></i>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                                        </button>
                                    </div>
                                    <!-- Worksheet Input -->
                                    <div id="worksheet-input-area" class="hidden space-y-4">
                                        <input type="text" id="worksheet-topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡πÄ‡∏•‡∏Ç‡∏™‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å">
                                        <button id="generate-worksheet-btn" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-emerald-700 flex items-center justify-center"><i class="fas fa-file-alt mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                                    </div>
                                </div>
                                <!-- Generation Result Area -->
                                <div id="quiz-generation-area" class="mt-6 hidden">
                                    <div id="loader" class="flex flex-col items-center justify-center hidden">
                                        <div class="loader"></div>
                                        <p id="loader-text" class="mt-3 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...</p>
                                    </div>
                                    <div id="generated-quiz-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Tab Content -->
                    <div id="results-tab-content" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ</h3>
                             <input type="text" id="quiz-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö..." class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div id="project-quizzes-list" class="space-y-3">
                            <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...</p>
                        </div>
                    </div>

                    <!-- Leaderboard Tab Content -->
                    <div id="leaderboard-tab-content" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-center w-16">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="py-2 px-4 border-b text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Points)</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-table-body">
                                    <!-- Leaderboard rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quiz Detail/Results View -->
                <div id="quiz-results-view" class="hidden">
<div class="flex items-center gap-4 mb-4">
        <button id="back-to-project-btn" class="text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</button>

        <!-- --- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ --- -->
        <button id="back-to-dashboard-from-results-btn" class="text-gray-500 hover:underline text-sm"><i class="fas fa-th-large mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard</button>
    </div>

    <h2 id="results-quiz-title" class="text-3xl font-bold text-indigo-700 mb-2"></h2>
    <p class="text-sm text-gray-500 mb-4">Quiz ID: <span id="results-quiz-id-display" class="font-mono"></span></p>

                    

                       <!-- Quiz Detail Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-6">
                            <button id="analytics-tab-btn" class="main-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                                <i class="fas fa-chart-line mr-2"></i>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•
                            </button>
                            <button id="scores-tab-btn" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-users mr-2"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                            <!-- NEW: Quiz Leaderboard Tab Button -->
                            <button id="leaderboard-quiz-tab-btn" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-trophy mr-2"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥
                            </button>
                        </nav>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="analytics-tab-content">
                        <!-- Summary Cards -->
                        <div id="analytics-summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <!-- Cards will be injected here -->
                        </div>
                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h4>
                                <canvas id="submission-status-chart"></canvas>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2 text-center">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
                                <canvas id="score-distribution-chart"></canvas>
                            </div>
                        </div>

                        <!-- NEW: AI Strength/Weakness Analysis Section -->
                        <div class="mt-8">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2">AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                            <div class="flex justify-center">
                                <button id="analyze-strengths-btn" class="bg-indigo-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300 flex items-center gap-2">
                                    <i class="fas fa-magic"></i>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á-‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
                                </button>
                            </div>
                            <div id="strength-weakness-analysis-container" class="mt-4">
                                <!-- Analysis results will be displayed here -->
                            </div>
                        </div>

                        <!-- Per-Question Analysis -->
                        <div class="mt-8">
                             <h3 class="text-xl font-semibold mb-3 border-b pb-2">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠</h3>
                             <div id="question-analytics-container" class="space-y-4">
                                 <!-- Accordions will be injected here -->
                             </div>
                        </div>
                    </div>

                    <!-- Scores Tab -->
                    <div id="scores-tab-content" class="hidden">
                        <!-- Export Buttons -->
                        <div class="mb-4 flex flex-wrap gap-2">
                            <span class="self-center font-semibold mr-2">Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span>
                            <button id="export-image-btn" class="bg-gray-600 text-white py-1 px-3 rounded-md hover:bg-gray-700 text-sm flex items-center gap-2"><i class="fas fa-file-image"></i>Image</button>
                            <button id="export-pdf-btn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm flex items-center gap-2"><i class="fas fa-file-pdf"></i>PDF</button>
                            <button id="export-word-btn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm flex items-center gap-2"><i class="fas fa-file-word"></i>Word</button>
                            <button id="export-excel-btn" class="bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fas fa-file-excel"></i>Excel</button>
                        </div>
                        <div class="overflow-x-auto" id="results-table-container">
                            <table class="min-w-full bg-white border border-gray-200" id="results-table">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏ú‡∏•</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                        <th class="py-2 px-4 border-b text-left">Points</th>
                                        <th class="py-2 px-4 border-b text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="py-2 px-4 border-b text-left">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                    </tr>
                                </thead>
                                <tbody id="quiz-results-table-body">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- NEW: Quiz Leaderboard Tab Content -->
                    <div id="leaderboard-quiz-tab-content" class="hidden">
    <h3 class="text-xl font-semibold mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥ (‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</h3>

    <div class="mb-4 flex flex-wrap gap-2">
        <span class="self-center font-semibold mr-2">Export ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span>
        <button id="export-leaderboard-image-btn" class="bg-gray-600 text-white py-1 px-3 rounded-md hover:bg-gray-700 text-sm flex items-center gap-2"><i class="fas fa-file-image"></i>Image</button>
        <button id="export-leaderboard-pdf-btn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm flex items-center gap-2"><i class="fas fa-file-pdf"></i>PDF</button>
        <button id="export-leaderboard-word-btn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm flex items-center gap-2"><i class="fas fa-file-word"></i>Word</button>
        <button id="export-leaderboard-excel-btn" class="bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fas fa-file-excel"></i>Excel</button>
    </div>
    <div class="overflow-x-auto" id="quiz-leaderboard-table-container">
        <table class="min-w-full bg-white border border-gray-200" id="quiz-leaderboard-table">
            <thead class="bg-gray-100">
                <tr>
                    <th class="py-2 px-4 border-b text-center w-16">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                    <th class="py-2 px-4 border-b text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                    <th class="py-2 px-4 border-b text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</th>
                    <th class="py-2 px-4 border-b text-center">‡∏ú‡∏•</th>
                    <th class="py-2 px-4 border-b text-center">Points (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
                    <th class="py-2 px-4 border-b text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥</th>
                    <th class="py-2 px-4 border-b text-left">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                    <th class="py-2 px-4 border-b text-left">‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                </tr>
            </thead>
            <tbody id="quiz-leaderboard-table-body">
                </tbody>
        </table>
    </div>
</div>
                </div>
            </div>

            <!-- Student View -->
            <div id="student-view" class="fade-in">
                <div id="student-initial-view">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700 text-center">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
                    <div id="student-entry-area" class="space-y-4 max-w-md mx-auto">
                        <div>
                            <label for="quiz-id-input" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</label>
                            <input type="text" id="quiz-id-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°">
                        </div>
                        <button id="load-quiz-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center">
                            <i class="fas fa-search mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                        </button>
                        <div class="relative flex py-3 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-500">‡∏´‡∏£‡∏∑‡∏≠</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>
                        <button id="join-live-game-btn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center">
                            <i class="fas fa-flag-checkered mr-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°‡∏™‡∏î
                        </button>
                    </div>
                </div>

                <!-- NEW: Student Join Live Game View -->
                <div id="student-join-game-view" class="hidden max-w-md mx-auto">
                     <h2 class="text-2xl font-bold mb-4 text-indigo-700 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°‡∏™‡∏î</h2>
                     <div class="space-y-4">
                         <div>
                             <label for="game-pin-input" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (Game PIN):</label>
                             <input type="number" id="game-pin-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="12">
                         </div>
                         <div>
                             <label for="nickname-input" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</label>
                             <input type="text" id="nickname-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
                         </div>
                         <button id="confirm-join-game-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700">
                             <i class="fas fa-sign-in-alt mr-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                         </button>
                         <button id="back-to-student-initial-btn" class="w-full mt-2 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
                             ‡∏Å‡∏•‡∏±‡∏ö
                         </button>
                     </div>
                </div>
                
                <div id="student-name-selection-view" class="hidden max-w-md mx-auto">
                    <h2 id="student-quiz-topic" class="text-2xl font-bold mb-4 text-indigo-700 text-center"></h2>
                    <label for="student-name-select" class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
                    <select id="student-name-select" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                    <button id="start-quiz-btn" class="w-full mt-4 bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700">
                        <i class="fas fa-play-circle mr-2"></i>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                    </button>
                </div>
                <div id="student-quiz-area" class="mt-6 hidden"></div>
                <div id="student-result-area" class="mt-6 hidden"></div>
                <div id="student-reading-area" class="mt-6 hidden"></div>
            </div>

            <!-- NEW: Live Game View (Covers the whole main content area) -->
            <div id="live-game-view" class="hidden fade-in">
                <!-- Content will be injected by JS -->
            </div>

        </main>
        
        <div id="user-info" class="text-center mt-6 text-xs text-gray-400">
            User ID: <span id="user-id-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button id="modal-close-btn" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <div id="create-project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà</h3>
            <label for="project-name-input" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ:</label>
            <input type="text" id="project-name-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°.1 ‡πÄ‡∏ó‡∏≠‡∏° 2">
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-create-project-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-create-project-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</button>
            </div>
        </div>
    </div>

    <div id="admin-password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h3>
            <p class="text-center text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>
            <input type="password" id="admin-password-input" class="w-full p-3 border border-gray-300 rounded-lg text-center" placeholder="******">
            <p id="password-error-msg" class="text-red-500 text-sm text-center mt-2 hidden">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-admin-login-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-admin-login-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="rename-quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
            <label for="rename-quiz-input" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:</label>
            <input type="text" id="rename-quiz-input" class="w-full p-3 border border-gray-300 rounded-lg">
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-rename-quiz-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-rename-quiz-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="move-quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô</h3>
            <label for="move-quiz-project-select" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á:</label>
            <select id="move-quiz-project-select" class="w-full p-3 border border-gray-300 rounded-lg">
                <!-- Project options will be populated here -->
            </select>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-move-quiz-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-move-quiz-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">‡∏¢‡πâ‡∏≤‡∏¢</button>
            </div>
        </div>
    </div>
	
	<div id="global-live-game-modal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-xl w-full">
    <h3 class="text-xl font-bold mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏° Live Game (‡∏ó‡∏∏‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ)
    <span id="global-live-game-count" class="text-base font-normal text-gray-500 ml-2"></span>
</h3>

    <input id="global-quiz-search-input" type="text"
           class="w-full p-2 border border-gray-300 rounded-lg mb-3"
           placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ...">

    <div id="global-quiz-list"
         class="max-h-72 overflow-y-auto border rounded-md">
      <!-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢ JS -->
    </div>

    <div class="flex justify-end gap-3 mt-4">
      <button id="cancel-global-live-btn"
              class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button id="confirm-global-live-btn"
              class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 disabled:opacity-50"
              disabled>
        ‡πÄ‡∏£‡∏¥‡πà‡∏°
      </button>
    </div>
  </div>
</div>

<div id="quiz-bank-modal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-xl w-full flex flex-col">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    <span id="quiz-bank-count" class="text-base font-normal text-gray-500 ml-2"></span>
</h3>
        <button id="cancel-quiz-bank-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
    </div>

    <input id="bank-quiz-search-input" type="text"
           class="w-full p-2 border border-gray-300 rounded-lg mb-3"
           placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö, ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ, ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...">

    <div id="bank-quiz-list"
         class="max-h-96 overflow-y-auto border rounded-md">
      </div>

  </div>
</div>

    <div id="quiz-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal-shuffle-select" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
                    <select id="modal-shuffle-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        <option value="none">‡πÑ‡∏°‡πà‡∏™‡∏•‡∏±‡∏ö</option>
                        <option value="questions_only">‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠</option>
                        <option value="choices_only">‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                        <option value="both">‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                    </select>
                </div>
                 <div>
    <label for="modal-results-display-select" class="block text-sm font-medium text-gray-700">‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
    <select id="modal-results-display-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
        <option value="show_results_and_answers">‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</option>
        <option value="show_results_only">‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏•‡∏¢)</option>
        <option value="show_pass_fail_only">‡∏ó‡∏£‡∏≤‡∏ö‡∏ú‡∏•‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</option>
        <option value="manual_release">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•</option>
    </select>
</div>
                 <div class="flex items-center mt-2">
    <input id="modal-adaptive-quiz-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
    <label for="modal-adaptive-quiz-checkbox" class="ml-2 block text-sm font-medium text-gray-900">
        ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    </label>
</div>
                <div class="border-t pt-4">
                    <label for="modal-timer-mode-select" class="block text-sm font-medium text-gray-700">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤:</label>
                    <select id="modal-timer-mode-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</option>
                        <option value="whole_quiz">‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                        <option value="per_question">‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                    </select>
                </div>
                <div id="modal-timer-duration-container" class="hidden">
                    <label for="modal-timer-duration-input" id="modal-timer-duration-label" class="block text-sm font-medium text-gray-700">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</label>
                    <input type="number" id="modal-timer-duration-input" value="10" min="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <!-- NEW: Passing Score in Modal -->
                <div class="border-t pt-4">
                    <label for="modal-passing-score-input" class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô:</label>
                    <input type="number" id="modal-passing-score-input" value="5" min="0" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-quiz-settings-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-quiz-settings-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
    
    <div id="quiz-status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
            <div class="space-y-4">
                <div class="space-y-2" id="quiz-status-options">
                    <!-- Radio buttons will be dynamically inserted here -->
                </div>
                <div id="quiz-schedule-end-container" class="hidden space-y-2 border-t pt-3">
                    <label for="quiz-end-time" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î:</label>
                    <input type="datetime-local" id="quiz-end-time" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div id="quiz-schedule-start-container" class="hidden space-y-2 border-t pt-3">
                    <label for="quiz-start-time" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î:</label>
                    <input type="datetime-local" id="quiz-start-time" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-quiz-status-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-quiz-status-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

<div id="quiz-editor-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-indigo-700">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
                <button id="cancel-quiz-edits-btn" class="text-gray-500 hover:text-red-600 text-3xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <div class="mb-4">
                    <label for="editor-quiz-topic" class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</label>
                    <input type="text" id="editor-quiz-topic" class="w-full p-2 border border-gray-300 rounded-lg text-lg font-semibold">
                </div>
                <div id="quiz-editor-questions-container" class="space-y-6">
                    </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end gap-3">
                <button id="cancel-quiz-edits-btn-footer" class="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="save-quiz-edits-btn" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
            </div>
			
			<button id="auto-fix-latex-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
			
        </div>
    </div>

    <!-- Presentation Mode Container -->
    <div id="presentation-modal" class="fixed inset-0 bg-gray-800 text-white flex-col items-center justify-center hidden z-50 p-4">
        <button id="close-presentation-btn" class="absolute top-4 right-6 text-4xl hover:text-gray-300">&times;</button>
        <div id="presentation-slide-container" class="w-full max-w-5xl h-full flex flex-col items-center justify-center">
            <!-- Slide content will be injected here -->
        </div>
        <div class="absolute bottom-4 w-full flex justify-between items-center px-8 max-w-5xl mx-auto left-0 right-0">
            <button id="prev-question-btn" class="bg-indigo-600 py-2 px-5 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed"><i class="fas fa-arrow-left mr-2"></i>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <div id="slide-counter" class="text-lg font-semibold"></div>
            <button id="next-question-btn" class="bg-indigo-600 py-2 px-5 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ<i class="fas fa-arrow-right ml-2"></i></button>
        </div>
    </div>
    <!-- NEW: Student Rankings Modal -->
    <div id="student-rankings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-3xl w-full h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-indigo-700">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥</h3>
                <button id="close-student-rankings-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6">
                    <button id="student-quiz-leaderboard-tab" class="main-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                        <i class="fas fa-list-ol mr-2"></i>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
                    </button>
                    <button id="student-project-leaderboard-tab" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500">
                        <i class="fas fa-trophy mr-2"></i>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ
                    </button>
                </nav>
            </div>
            <!-- Content -->
            <div class="flex-grow overflow-y-auto mt-4">
                <div id="student-quiz-leaderboard-content">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100 sticky top-0">
                            <!-- Header for Quiz Leaderboard -->
                        </thead>
                        <tbody id="student-quiz-leaderboard-table-body"></tbody>
                    </table>
                </div>
                <div id="student-project-leaderboard-content" class="hidden">
                     <table class="min-w-full bg-white">
                        <thead class="bg-gray-100 sticky top-0">
                           <!-- Header for Project Leaderboard -->
                        </thead>
                        <tbody id="student-project-leaderboard-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, writeBatch, runTransaction, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Config ---
		
		// =====================================================================
// === ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown ‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ===
// =====================================================================

// 1. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const allMathTopics = [
    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏Å' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡πà‡∏≤' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (PEMDAS)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏•‡∏ö' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏ì' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏ß‡∏Å' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏•‡∏ö' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏®‡∏π‡∏ô‡∏¢‡πå' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏´.‡∏£.‡∏°. (GCD)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Ñ.‡∏£.‡∏ô. (LCM)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô (‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏ì‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏•‡∏∞' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° (‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏•‡∏±‡∏Å)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏π‡∏ì‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡πÅ‡∏õ‡∏•‡∏á ‡πÄ‡∏®‡∏©‡∏™‡πà‡∏ß‡∏ô‚Üî‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‚Üî‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‡∏†‡∏≤‡∏©‡∏µ ‡∏Å‡∏≥‡πÑ‡∏£ ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡πÄ‡∏•‡∏Ç‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á (‡∏Å‡∏é/‡∏®‡∏π‡∏ô‡∏¢‡πå/‡∏•‡∏ö)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏£‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏£‡∏π‡∏õ‡∏™‡πÅ‡∏Ñ‡∏ß‡∏£‡πå‡∏£‡∏π‡∏ó (surd)' },
    { category: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', name: '‡∏™‡∏±‡∏ç‡∏Å‡∏£‡∏ì‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' },
    // ‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏°‡∏ß‡∏•/‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏°/‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏°' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏™‡∏≤‡∏°‡∏°‡∏¥‡∏ï‡∏¥' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏™‡∏≤‡∏°‡∏°‡∏¥‡∏ï‡∏¥' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏°‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏°‡∏∏‡∏°' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏™‡πÄ‡∏Å‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' },
    { category: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î', name: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î' },
    // ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏à‡∏∏‡∏î ‡πÄ‡∏™‡πâ‡∏ô ‡∏£‡∏∞‡∏ô‡∏≤‡∏ö' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° (‡∏ä‡∏ô‡∏¥‡∏î/‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥)' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏£‡∏π‡∏õ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á/‡∏ö‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏á ‡πÄ‡∏ã‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏ã‡∏Å‡πÄ‡∏°‡∏ô‡∏ï‡πå' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô/‡∏´‡∏°‡∏∏‡∏ô/‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô/‡∏Ç‡∏¢‡∏≤‡∏¢)' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£ (‡πÅ‡∏Å‡∏ô/‡∏à‡∏∏‡∏î)' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‚Äì‡∏™‡∏±‡∏ô‡∏ï‡∏£‡∏á' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï', name: '‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ö‡∏ó‡∏û‡∏µ‡∏ó‡∏≤‡πÇ‡∏Å‡∏£‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå' },
    // ‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏°‡∏π‡πà' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏û‡∏´‡∏∏‡∏ô‡∏≤‡∏° (‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö/‡∏Ñ‡∏π‡∏ì/‡∏´‡∏≤‡∏£)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (rational)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏Å (radical)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏Å‡∏≤‡∏£‡∏¥‡∏ó‡∏∂‡∏°' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏≠‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏™‡πâ‡∏ô' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏≠‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏™‡∏°‡∏Å‡∏≤‡∏£' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏Å‡∏£‡∏ì‡πå' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏ô‡∏à‡πå' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏Å‡∏ú‡∏±‡∏ô' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô/‡∏¢‡∏∑‡∏î/‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏´‡∏∏‡∏ô‡∏≤‡∏°' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå (rational)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≤‡∏Å (root)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≠‡∏Å‡∏≤‡∏£‡∏¥‡∏ó‡∏∂‡∏°' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏ì‡∏¥‡∏ï (AP)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï (GP)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏≠‡∏ô‡∏∏‡∏Å‡∏£‡∏° (Œ£)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ó‡∏ß‡∏¥‡∏ô‡∏≤‡∏° (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)' },
    { category: '‡∏û‡∏µ‡∏ä‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô', name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏ã‡πâ‡∏≠‡∏ô (‡πÄ‡∏™‡∏£‡∏¥‡∏°)' },
    // ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏Å‡∏≤‡∏£' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á: ‡∏Ç‡∏ô‡∏≤‡∏ô/‡∏ï‡∏±‡πâ‡∏á‡∏â‡∏≤‡∏Å' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏™‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡∏û‡∏≤‡∏£‡∏≤‡πÇ‡∏ö‡∏•‡∏≤' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡∏ß‡∏á‡∏£‡∏µ' },
    { category: '‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', name: '‡πÑ‡∏Æ‡πÄ‡∏û‡∏≠‡∏£‡πå‡πÇ‡∏ö‡∏•‡∏≤' },
    // ‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥‡πÉ‡∏ô‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏∏‡∏°‡∏â‡∏≤‡∏Å' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏°‡∏∏‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© 30¬∞-60¬∞-90¬∞' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏°‡∏∏‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© 45¬∞-45¬∞-90¬∞' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡πÄ‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏ô‡πå' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πÑ‡∏ã‡∏ô‡πå' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏≠‡∏±‡∏ï‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥ (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏≠‡∏±‡∏ï‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏Å‡∏£‡∏≤‡∏ü‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì' },
    { category: '‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏°‡∏¥‡∏ï‡∏¥', name: '‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏µ‡πÇ‡∏Å‡∏ì‡∏ú‡∏Å‡∏ú‡∏±‡∏ô (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)' },
    // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Æ‡∏¥‡∏™‡πÇ‡∏ï‡πÅ‡∏Å‡∏£‡∏°' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏Å‡∏•‡πà‡∏≠‡∏á (box plot)' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏ê‡∏≤‡∏ô‡∏ô‡∏¥‡∏¢‡∏°' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏û‡∏¥‡∏™‡∏±‡∏¢' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ z-score' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏™‡∏´‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏ñ‡∏î‡∏ñ‡∏≠‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏™‡πâ‡∏ô' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á/‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏é‡∏ö‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏Ñ‡∏π‡∏ì' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏ß‡∏ô‡∏ô‡πå' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (Permutation)' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏°‡∏π‡πà (Combination)' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏ó‡∏ß‡∏¥‡∏ô‡∏≤‡∏° (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)' },
    { category: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏°‡∏≤‡∏¢ (Expected value)' },
    // ‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏•‡∏¥‡∏°‡∏¥‡∏ï' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏≠‡∏ô‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå: ‡∏Å‡∏é‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏≠‡∏ô‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå: ‡∏Å‡∏é‡∏•‡∏π‡∏Å‡πÇ‡∏ã‡πà' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏≠‡∏ô‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå: ‡∏ú‡∏•‡∏Ñ‡∏π‡∏ì/‡∏ú‡∏•‡∏´‡∏≤‡∏£' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏≠‡∏ô‡∏∏‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á exp/log/trig (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: 'Optimization (‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‚Äì‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏õ‡∏£‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏õ‡∏£‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ö‡∏ó‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™' },
    { category: '‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ï‡πâ‡∏Å‡∏£‡∏≤‡∏ü/‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü' },
    // ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå 2 ‡∏°‡∏¥‡∏ï‡∏¥: ‡∏ö‡∏ß‡∏Å/‡∏Ñ‡∏π‡∏ì‡∏™‡πÄ‡∏Å‡∏•‡∏≤‡∏£‡πå' },
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏î‡∏≠‡∏ó‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏ï‡πå (dot)' },
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô' },
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå: ‡∏ö‡∏ß‡∏Å/‡∏Ñ‡∏π‡∏ì' },
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏≠‡∏¥‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå' },
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏î‡∏µ‡πÄ‡∏ó‡∏≠‡∏£‡πå‡∏°‡∏¥‡πÅ‡∏ô‡∏ô‡∏ï‡πå' },
    { category: '‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡πÅ‡∏Å‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå' },
    // ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£
    { category: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£', name: '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢' },
    { category: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£', name: '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏ö‡∏ï‡πâ‡∏ô' },
    { category: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î (‡∏≠‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏ß‡∏î)' },
    { category: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£', name: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤' },
    { category: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏Å‡∏≤‡∏£', name: '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå' },
    // ‡∏ï‡∏£‡∏£‡∏Å‡∏∞/‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)
    { category: '‡∏ï‡∏£‡∏£‡∏Å‡∏∞/‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á' },
    { category: '‡∏ï‡∏£‡∏£‡∏Å‡∏∞/‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' },
    { category: '‡∏ï‡∏£‡∏£‡∏Å‡∏∞/‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå (‡πÄ‡∏™‡∏£‡∏¥‡∏°)', name: '‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏£‡∏á/‡∏≠‡∏∏‡∏õ‡∏ô‡∏±‡∏¢ (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)' },
];

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown
// === ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderTopicRefineDropdown ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ===
// === ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderTopicCheckboxes ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ===
function renderTopicCheckboxes() {
    const container = document.getElementById('math-topics-checkbox-container');
    if (!container) return;

    // 1. ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å 2 ‡πÅ‡∏´‡∏•‡πà‡∏á: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (allMathTopics) ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á (customMathTopics)
    const standardTopics = allMathTopics;
    const userCreatedTopics = customMathTopics.map(t => ({ category: '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á', name: t.name }));
    const combinedTopics = [...standardTopics, ...userCreatedTopics];

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    const topicsByCategory = combinedTopics.reduce((acc, topic) => {
        if (!acc[topic.category]) {
            acc[topic.category] = [];
        }
        acc[topic.category].push(topic);
        return acc;
    }, {});

    let html = '';

    // 3. ‡∏ß‡∏≤‡∏î HTML ‡πÇ‡∏î‡∏¢‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    // ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á" ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const categoryOrder = ['‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á', ...Object.keys(topicsByCategory).filter(c => c !== '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á')];

    for (const category of categoryOrder) {
        if (topicsByCategory[category]) {
            const categoryIcon = category === '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á' ? 'fas fa-user-edit' : 'fas fa-bookmark';
            const categoryColor = category === '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á' ? 'text-blue-700' : 'text-indigo-700';

            html += `<div class="mb-3">`;
            html += `<p class="font-bold text-sm ${categoryColor} border-b mb-1 pb-1"><i class="${categoryIcon} mr-2"></i>${category}</p>`;

            topicsByCategory[category].forEach(topic => {
                html += `
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded-md cursor-pointer">
                        <input type="checkbox" name="math_topic" value="${topic.name}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm">${topic.name}</span>
                    </label>
                `;
            });
            html += `</div>`;
        }
    }

    container.innerHTML = html || '<p class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</p>';

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    container.removeEventListener('change', updateSelectedTopicsCount); // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
    container.addEventListener('change', updateSelectedTopicsCount);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î)
function updateSelectedTopicsCount() {
    const container = document.getElementById('math-topics-checkbox-container');
    const count = container.querySelectorAll('input[type="checkbox"]:checked').length;
    const countEl = document.getElementById('selected-topics-count');
    if (count > 0) {
        countEl.textContent = `(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${count} ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)`;
    } else {
        countEl.textContent = '';
    }
}
// =====================================================================
		
        let db, auth, userId;
		let customMathTopics = []; //  <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        let currentMode = 'student'; // 'student', 'admin', or 'admin-testing'
        let currentProjectId = null;
        let currentProjectData = null;
        let currentQuizData = null;
        let currentDisplayedQuiz = null; // Holds the potentially shuffled quiz for the student
		let currentSubmissions = []; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
let quizLeaderboardSortBy = 'bestScore'; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
let quizLeaderboardSortOrder = 'desc'; // ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
        let currentStudentName = null;
        let currentStudentProjectData = null; 
        let currentPresentationSlide = 0;
        let allProjects = []; // Cache for projects
		let allQuizzesGlobal = [];        // ‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ (‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
		let selectedGlobalQuizId = null;  // id ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô modal
        let allQuizzes = []; // Cache for quizzes in a project
		let starredQuizzes = []; // Cache for starred quizzes
        let chartInstances = {}; // To hold chart objects
        let unsubscribeProjectsListener = null;
        let unsubscribeStudentsListener = null;
        let unsubscribeQuizzesListener = null;
        let unsubscribeSubmissionsListener = null;
        let unsubscribeStudentProfilesListener = null; // For Leaderboard
        let confirmAction = null;
        let actionTargetId = null; // Used for rename/move/timer actions
		let selectedFile = null; //  <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        let draggedSvgElement = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö element ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏≤‡∏Å
        let svgOffset = { x: 0, y: 0 }; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå/‡∏ô‡∏¥‡πâ‡∏ß‡∏Å‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á element
        // Timer-related state
        let quizTimerInterval = null;
        let perQuestionTimerInterval = null;
        let quizStartTime = null; // For calculating duration
        let currentQuestionIndex = 0;
        let studentAnswersPerQuestion = [];
        // Live Game State
        let currentLiveGameId = null;
        let currentLiveGamePin = null;
        let unsubscribeLiveGameListener = null;
		 let lastRenderedAdminQuestionIndex = -1; // <-- [ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ]


        // Gamification Constants
        const BADGES = {
            PERFECT_SCORE: { id: 'perfect_score', name: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°', description: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ', icon: 'fa-crown text-yellow-500' },
            QUICK_THINKER: { id: 'quick_thinker', name: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≠‡∏á‡πÑ‡∏ß', description: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î', icon: 'fa-bolt text-blue-500' },
            ON_FIRE: { id: 'on_fire', name: '‡∏ó‡πá‡∏≠‡∏õ‡∏ü‡∏≠‡∏£‡πå‡∏°', description: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å 3 ‡∏Ç‡πâ‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô', icon: 'fa-fire text-orange-500' },
            FIRST_TRY_ACE: { id: 'first_try_ace', name: '‡∏ú‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏∏‡∏¢', description: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å', icon: 'fa-rocket text-purple-500' },
            COMEBACK_KING: { id: 'comeback_king', name: '‡∏£‡∏≤‡∏ä‡∏≤‡∏Ñ‡∏±‡∏°‡πÅ‡∏ö‡πá‡∏Å', description: '‡∏™‡∏≠‡∏ö‡∏ï‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÅ‡∏ï‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ', icon: 'fa-shield-alt text-gray-600' },
            SPECIALIST: { id: 'specialist', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç', description: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ', icon: 'fa-user-astronaut text-blue-700' },
            PERSEVERANCE: { id: 'perseverance', name: '‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ', description: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', icon: 'fa-dumbbell text-gray-700' }
        };

        // Use the config provided by the environment, with a fallback for local development
       const firebaseConfig = {
    apiKey: "AIzaSyCQlVzy_LBImNp5TJNwRuepFzvxWm8AyZk",
    authDomain: "ai-quiz-app-aefee.firebaseapp.com",
    projectId: "ai-quiz-app-aefee",
    storageBucket: "ai-quiz-app-aefee.appspot.com",
    messagingSenderId: "274192258111",
    appId: "1:274192258111:web:4120c9118229b5644dd48a",
    measurementId: "G-V90KRM0L63"
};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-quiz-generator-v3';

        // --- DOM Elements ---
        const adminView = document.getElementById('admin-view');
        const studentView = document.getElementById('student-view');
        const projectDashboardView = document.getElementById('project-dashboard-view');
        const projectDetailView = document.getElementById('project-detail-view');
        const quizResultsView = document.getElementById('quiz-results-view');
        const projectList = document.getElementById('project-list');
        const noProjectsMsg = document.getElementById('no-projects-msg');
        const projectTitle = document.getElementById('project-title');
        const projectIdDisplay = document.getElementById('project-id-display');
        const studentList = document.getElementById('student-list');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const createProjectModal = document.getElementById('create-project-modal');
        const adminPasswordModal = document.getElementById('admin-password-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const userIdDisplay = document.getElementById('user-id-display');
        const topicTab = document.getElementById('topic-tab');
        const textTab = document.getElementById('text-tab');
        const topicInputArea = document.getElementById('topic-input-area');
        const textInputArea = document.getElementById('text-input-area');
        const manageTab = document.getElementById('manage-tab');
        const resultsTab = document.getElementById('results-tab');
        const leaderboardTab = document.getElementById('leaderboard-tab');
        const manageTabContent = document.getElementById('manage-tab-content');
        const resultsTabContent = document.getElementById('results-tab-content');
        const leaderboardTabContent = document.getElementById('leaderboard-tab-content');
        const projectQuizzesList = document.getElementById('project-quizzes-list');
        const fileTab = document.getElementById('file-tab');
        const fileInputArea = document.getElementById('file-input-area');
        const fileUploadInput = document.getElementById('file-upload-input');
        const worksheetTab = document.getElementById('worksheet-tab');
        
        const worksheetInputArea = document.getElementById('worksheet-input-area');
        const generateWorksheetBtn = document.getElementById('generate-worksheet-btn');
        // Student view elements
        const studentInitialView = document.getElementById('student-initial-view');
        const studentNameSelectionView = document.getElementById('student-name-selection-view');
        const studentQuizArea = document.getElementById('student-quiz-area');
        const studentResultArea = document.getElementById('student-result-area');
        const studentReadingArea = document.getElementById('student-reading-area');
        const loadQuizBtn = document.getElementById('load-quiz-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const studentJoinGameView = document.getElementById('student-join-game-view');
        
        // Presentation Mode elements
        const presentationModal = document.getElementById('presentation-modal');

        // Modals
        const renameQuizModal = document.getElementById('rename-quiz-modal');
        const moveQuizModal = document.getElementById('move-quiz-modal');
        const quizSettingsModal = document.getElementById('quiz-settings-modal');
        const quizStatusModal = document.getElementById('quiz-status-modal');

        // Live Game View
        const liveGameView = document.getElementById('live-game-view');

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î LaTeX ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
 * ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î LaTeX ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
 * ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 */
/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î LaTeX ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
 * ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 */

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î LaTeX ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
 * ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 */
function handleAutoFixLatex() {
  // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
  const root = document.getElementById('quiz-editor-questions-container') || document;

  const nodes = root.querySelectorAll([
    'textarea',
    'input[type="text"]',
    '[contenteditable="true"]',
    '[role="textbox"]',
    '.ql-editor',
    'label',
    '.choice-text',
    '.option-text',
    '.answer-text'
  ].join(','));

  let totalChanges = 0;

  // ---------- utils ----------
  const getText = el => ('value' in el ? String(el.value)
                        : (el.innerText !== undefined ? el.innerText : (el.textContent || '')));
  const setText = (el, s) => {
    if ('value' in el) { el.value = s; return; }
    if (el.querySelector && el.querySelector('mjx-container')) return; // ‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á MathJax
    if (el.innerText !== undefined) el.innerText = s; else el.textContent = s;
  };

  const normalize = s =>
    s.replace(/\u00A0/g, ' ')
     .replace(/\u200B/g, '')
     .replace(/\r\n?/g, '\n');

  // ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï
  const latexTokenLike =
    /[\^_\\]|\b(?:frac|dfrac|tfrac|sqrt|text|times|cdot|div|leq|geq|le|ge|neq|pm|approx|sin|cos|tan|log|ln|sum|prod|binom|overline|underline|left|right|ext|circ|deg)\b|[¬∞√ó√∑‚â§‚â•‚â†¬±¬∑‚àö‚àë]/;

  const isPlainNumber = t => /^\s*[+-]?(?:\d+(?:\.\d+)?|\.\d+)\s*$/.test(t);

  // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏¥‡∏î‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢ (‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÅ‡∏ï‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏à‡πä‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞)
  const balanceBraces = (t) => {
    const opens = (t.match(/\{/g) || []).length;
    const closes = (t.match(/\}/g) || []).length;
    if (opens > closes) t = t + '}'.repeat(opens - closes);
    return t;
  };

  // ---------- ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï ----------
  const fixLatexContent = (content) => {
    let t = content.trim();

    // ‡πÅ‡∏°‡πÇ‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    const macros = [
      'frac','dfrac','tfrac','sqrt','text','times','cdot','div','leq','geq','le','ge',
      'neq','pm','approx','sin','cos','tan','log','ln','sum','prod','binom',
      'left','right','overline','underline','circ','deg'
    ];

    // ‡∏•‡∏î \\macro -> \macro (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ \\ ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)
    t = t.replace(new RegExp('\\\\\\\\(?=(' + macros.join('|') + ')\\b)', 'g'), '\\');

    // ‡πÄ‡∏ï‡∏¥‡∏° backslash ‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πÇ‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î
    macros.forEach(m => {
      t = t.replace(new RegExp(`(^|[^\\\\])\\b${m}\\b`, 'g'), (_m, p1) => `${p1}\\${m}`);
    });

    // ‡∏¢‡∏π‡∏ô‡∏¥‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏ì‡∏¥‡∏ï -> LaTeX
    const uniMap = [
      [/√ó/g, '\\times'], [/¬∑/g, '\\cdot'], [/√∑/g, '\\div'],
      [/‚â§/g, '\\le'],    [/‚â•/g, '\\ge'],   [/‚â†/g, '\\neq'],
      [/¬±/g, '\\pm'],    [/‚àë/g, '\\sum'],  [/‚àí/g, '-'] // minus U+2212
    ];
    uniMap.forEach(([re, rep]) => { t = t.replace(re, rep); });

    // ‚àö9, ‚àö(x+1) -> \sqrt{9}, \sqrt{x+1}
    t = t.replace(/‚àö\s*\(([^)]*)\)/g, '\\sqrt{$1}');
    t = t.replace(/‚àö\s*([A-Za-z0-9]+)/g, '\\sqrt{$1}');

    // ‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
    t = t.replace(/(^|[^\\])\bimes\b/g, '$1\\times')
         .replace(/(^|[^\\])\b(?:rac|\/frac)\b/g, '$1\\frac')
         .replace(/(^|[^\\])ext\{/g, '$1\\text{')
         .replace(/(^|[^\\])ext\(/g, '$1\\text(')
         .replace(/\\text\(([^)]*)\)/g, '\\text{$1}')
         .replace(/\s\\frac/g, '\\frac');

    // ‡πÅ‡∏õ‡∏•‡∏á a/b -> \frac{a}{b} (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: a,b ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠ a,b ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß)
    // ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÄ‡∏ä‡πà‡∏ô 2.4/2
    t = t.replace(
      /(^|[^\w.])([A-Za-z]|\d+)\s*\/\s*([A-Za-z]|\d+)(?![\w/])/g,
      (_m, p, a, b) => `${p}\\frac{${a}}{${b}}`
    );

    // ‡∏ã‡πà‡∏≠‡∏° \frac ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö/‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
    t = t.replace(/\\(?:dfrac|tfrac|frac)\s+([^\s{}]+)\s+([^\s{}]+)/g, '\\frac{$1}{$2}')
         .replace(/\\(?:dfrac|tfrac|frac)\s*\{([^}]*)\}\s*([A-Za-z0-9+\-*/.]+)/g, '\\frac{$1}{$2}')
         .replace(/\\(?:dfrac|tfrac|frac)\s+([^\s{}]+)\s*\{([^}]*)\}/g, '\\frac{$1}{$2}');

    // ‡∏≠‡∏á‡∏®‡∏≤/‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™
    [
      [/(\d+)\s*\^\s*\\?text\{o\}\s*\\?text?\{?C\}?/g, '$1^{\\circ}\\text{C}'],
      [/(\d+)\s*\^\s*\\?ext\{o\}\s*C/g,               '$1^{\\circ}\\text{C}'],
      [/(\d+)\s*\^\s*\\?ext\(o\)\s*C/g,               '$1^{\\circ}\\text{C}'],
      [/(\d+)\s*\^\s*o\s*C\b/g,                       '$1^{\\circ}\\text{C}'],
      [/(\d+)\s*\^\s*\\?circ\s*C/g,                   '$1^{\\circ}\\text{C}'],
      [/(\d+)\s*¬∞\s*C/g,                               '$1^{\\circ}\\text{C}'],
      [/(\d+)\s*¬∞(?!\s*\\?text\{C\})/g,               '$1^{\\circ}'],
      // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢: 35 ‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™ / 35 ‡∏≠‡∏á‡∏®‡∏≤ C
      [/(\d+)\s*‡∏≠‡∏á‡∏®‡∏≤\s*(?:‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™|C)\b/g,          '$1^{\\circ}\\text{C}']
    ].forEach(([re, rep]) => { t = t.replace(re, rep); });

    // ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞: 50% -> 50\%
    t = t.replace(/(\d+)\s*%/g, '$1\\%');

    // ‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á/‡∏ã‡∏±‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏•‡∏∑‡∏° {}
    t = t.replace(/([A-Za-z0-9\)])\^\s*([-+]?\d+|[A-Za-z])(?!\s*\{)/g, '$1^{$2}')
         .replace(/([A-Za-z0-9\)])_\s*([-+]?\d+|[A-Za-z])(?!\s*\{)/g, '$1_{$2}')
         .replace(/\{\{([^\{\}]+)\}\}/g, '{$1}');

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∑‡∏° backslash ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
    ['sin','cos','tan','log','ln'].forEach(fn => {
      t = t.replace(new RegExp(`(^|[^\\\\])\\b${fn}\\s*\\(`, 'g'), (_m, p1) => `${p1}\\${fn}(`);
    });

    // \left ... \right ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏π‡πà -> ‡∏ï‡∏±‡∏î \left \right ‡∏≠‡∏≠‡∏Å (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏∏‡∏î)
    const cL = (t.match(/\\left\b/g) || []).length;
    const cR = (t.match(/\\right\b/g) || []).length;
    if (cL !== cR) t = t.replace(/\\left\b/g, '').replace(/\\right\b/g, '');

    // ‡∏õ‡∏¥‡∏î‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢
    t = balanceBraces(t);

    return t;
  };

  // ‡∏Ñ‡∏£‡∏≠‡∏ö $‚Ä¶$ ‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô
  const wrapBareMath = (seg) => {
    if (/\$|\\\(|\\\[/.test(seg)) return seg;       // ‡∏°‡∏µ‡∏Ñ‡∏±‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    if (!latexTokenLike.test(seg)) return seg;      // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏ì‡∏¥‡∏ï
    const lead = seg.match(/^\s*/)[0];
    const tail = seg.match(/\s*$/)[0];
    const core = seg.trim();
    return `${lead}$${fixLatexContent(core)}$${tail}`;
  };

  // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå (‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡πÑ‡∏ß‡πâ)
  const splitByListSeparators = (line) =>
    line.split(/(\s(?:‡πÅ‡∏•‡∏∞|‡∏´‡∏£‡∏∑‡∏≠)\s|[,\u3001Ôºå;Ôºõ])/);

  nodes.forEach(el => {
    if (el.querySelector && el.querySelector('mjx-container')) return;

    const original = getText(el);
    let s = normalize(original);

    // 1) ‡∏ã‡πà‡∏≠‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    s = s
      .replace(/\$\$([\s\S]*?)\$\$/g, (_m, inner) => `$$${fixLatexContent(inner)}$$`)
      .replace(/\$([^$]*?)\$/g,       (_m, inner) => `$${fixLatexContent(inner)}$`)
      .replace(/\\\(([\s\S]*?)\\\)/g, (_m, inner) => `\\(${fixLatexContent(inner)}\\)`)
      .replace(/\\\[([\s\S]*?)\\\]/g, (_m, inner) => `\\[${fixLatexContent(inner)}\\]`);

    // 2) S‚Ä¶S ‡∏û‡∏¥‡πÄ‡∏®‡∏©
    let tmp = s, guard = 0;
    const fixS = (txt) => txt.replace(/S([^S]{0,2000}?)S/g,
      (m, inner) => latexTokenLike.test(inner) ? `$${fixLatexContent(inner)}$` : m
    );
    while (guard++ < 20) {
      const next = fixS(tmp);
      if (next === tmp) break;
      tmp = next;
    }
    s = tmp;

    // 3) ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , ; „ÄÅ Ôºå ‡πÅ‡∏•‡∏∞/‡∏´‡∏£‡∏∑‡∏≠ ‚Üí ‡∏Ñ‡∏£‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏¥‡πâ‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï
    s = s.split('\n').map(line => {
      if (!(/[,\u3001Ôºå;Ôºõ]/.test(line) || /\s(?:‡πÅ‡∏•‡∏∞|‡∏´‡∏£‡∏∑‡∏≠)\s/.test(line)) || !latexTokenLike.test(line)) {
        return line;
      }
      return splitByListSeparators(line).map(part => {
        if (/^\s(?:‡πÅ‡∏•‡∏∞|‡∏´‡∏£‡∏∑‡∏≠)\s$/.test(part) || /^[,\u3001Ôºå;Ôºõ]$/.test(part)) return part;
        return wrapBareMath(part);
      }).join('');
    }).join('\n');

    // 4) ‡∏ä‡∏¥‡πâ‡∏ô‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‚Üí ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    s = s.split('\n').map(line => {
      const t = line.trim();
      if (!t) return line;
      const hasDelim = /\$|\\\(|\\\[/.test(t);
      const looksMath = /(\\[A-Za-z]+|[\^_]|[¬∞√ó√∑‚â§‚â•‚â†¬±¬∑‚àö‚àë])/.test(t);
      if (hasDelim || !looksMath || isPlainNumber(t)) return line;
      return line.replace(t, `$${fixLatexContent(t)}$`);
    }).join('\n');

    // 5) ‡∏≠‡∏á‡∏®‡∏≤/¬∞C ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏•‡∏≠‡∏¢‡∏ô‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏¥‡∏ï (‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢)
    s = s
      .replace(/(\d+)\s*¬∞\s*C\b/g, (m, n, off, str) => {
        const prev = str[off - 1]; if (prev === '$' || prev === 'S' || prev === '\\') return m;
        return `$${n}^{\\circ}\\text{C}$`;
      })
      .replace(/(\d+)\s*‡∏≠‡∏á‡∏®‡∏≤\s*(?:‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™|C)\b/g, (m, n, off, str) => {
        const prev = str[off - 1]; if (prev === '$' || prev === 'S' || prev === '\\') return m;
        return `$${n}^{\\circ}\\text{C}$`;
      })
      .replace(/(\d+)\s*\^\s*(?:\\?ext\{o\}|\\?ext\(o\)|o)\s*C\b/g, (m, n, off, str) => {
        const prev = str[off - 1]; if (prev === '$' || prev === 'S' || prev === '\\') return m;
        return `$${n}^{\\circ}\\text{C}$`;
      });

    // 6) ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏ß‡∏≤‡∏î
    s = s.replace(/\$\s*\$/g, '$$'); // "$  $" -> "$$"

    if (s !== original) { setText(el, s); totalChanges++; }
  });

  if (totalChanges > 0) {
    showMessage(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${totalChanges} ‡∏ä‡πà‡∏≠‡∏á`);
    // re-typeset (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á MathJax ‡πÅ‡∏•‡∏∞ KaTeX)
    try {
      if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
      if (window.katex && typeof renderMathInElement === 'function') {
        renderMathInElement(root, { delimiters: [
          {left: "$$", right: "$$", display: true},
          {left: "$",  right: "$",  display: false},
          {left: "\\(", right: "\\)", display: false},
          {left: "\\[", right: "\\]", display: true}
        ]});
      }
    } catch (_) {}
  } else {
    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°');
  }
}

async function listenForCustomMathTopics() {
    // if (!userId) return; // ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ userId ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞
    const customTopicsRef = collection(db, `artifacts/${appId}/public/data/customMathTopics`);

    onSnapshot(customTopicsRef, (snapshot) => {
        customMathTopics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
        renderTopicCheckboxes(); 
    }, (error) => {
        console.error("Error listening for custom math topics:", error);
    });
}

function handleSelectAllTopics() {
        const container = document.getElementById('math-topics-checkbox-container');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = true;
        });
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        updateSelectedTopicsCount();
    }

    function handleDeselectAllTopics() {
        const container = document.getElementById('math-topics-checkbox-container');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = false;
        });
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        updateSelectedTopicsCount();
    }

async function handleAddCustomMathTopic() {
    const input = document.getElementById('custom-math-topic-input');
    const topicName = input.value.trim();

    if (!topicName) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°");
        return;
    }
    if (!userId) {
        showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ");
        return;
    }

    try {
        const customTopicsRef = collection(db, `artifacts/${appId}/public/data/customMathTopics`);
        await addDoc(customTopicsRef, {
            name: topicName,
            createdAt: serverTimestamp()
        });
        input.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        showMessage(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${topicName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    } catch (error) {
        console.error("Error adding custom topic:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠");
    }
}

        // --- Initial Setup ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener();
                setupEventListeners();
                showView('student'); // Default to student view
				        // ‚ñº‚ñº‚ñº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‚ñº‚ñº‚ñº
        renderTopicCheckboxes();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
            }
        }
		
		/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
 * @param {string} userAnswer ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} idealAnswer ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
 * @returns {boolean} ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ true ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
 */
function compareNumericalAnswers(userAnswer, idealAnswer) {
    // ‡πÅ‡∏õ‡∏•‡∏á comma ‡πÄ‡∏õ‡πá‡∏ô period ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏Å (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏ö)
    const cleanUserStr = String(userAnswer).replace(',', '.').replace(/[^\d.-]/g, '').trim();
    const cleanIdealStr = String(idealAnswer).replace(',', '.').replace(/[^\d.-]/g, '').trim();

    // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    if (cleanUserStr === '' || cleanIdealStr === '') {
        return false;
    }

    const userNum = parseFloat(cleanUserStr);
    const idealNum = parseFloat(cleanIdealStr);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (isNaN(userNum) || isNaN(idealNum)) {
        return false;
    }

    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏î‡∏¢‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (Epsilon) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    return Math.abs(userNum - idealNum) < 0.001;
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô/‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô
 * @param {string} userAnswer ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {object} questionData ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ idealAnswer
 * @returns {Promise<boolean>} ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Promise ‡∏ó‡∏µ‡πà resolve ‡πÄ‡∏õ‡πá‡∏ô true ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
 */
async function gradeShortAnswer(userAnswer, questionData) {
    const idealAnswer = questionData.idealAnswer;

    // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß (Case-Insensitive) ---
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    if (String(userAnswer).trim().toLowerCase() === String(idealAnswer).trim().toLowerCase()) {
        return true;
    }

    // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Numerical Check) ---
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
    if (compareNumericalAnswers(userAnswer, idealAnswer)) {
        return true;
    }

    // --- (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ---
    // ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ
    // if (questionData.acceptedAnswers && Array.isArray(questionData.acceptedAnswers)) {
    //     const normalizedUserAnswer = String(userAnswer).trim().toLowerCase();
    //     if (questionData.acceptedAnswers.some(ans => String(ans).trim().toLowerCase() === normalizedUserAnswer)) {
    //         return true;
    //     }
    // }

    // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 4: ‡πÉ‡∏ä‡πâ AI ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ---
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    console.log("Programmatic checks failed. Deferring to AI for grading.");
    return await gradeShortAnswerWithAI(userAnswer, idealAnswer);
}
		
		async function revealAnswerForAdmin(index, total) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô ‡∏´‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
            if (document.getElementById('next-live-question-btn')) return;

            const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
            await updateDoc(gameRef, { questionStatus: 'revealed' });

            const correctOption = liveGameView.querySelector('[data-is-correct="true"]');
            if (correctOption) {
                correctOption.classList.remove('bg-white/30');
                correctOption.classList.add('bg-green-300', 'text-green-900', 'font-bold', 'border-4', 'border-green-500');
                correctOption.innerHTML = `<i class="fas fa-check mr-3"></i>` + correctOption.innerHTML;
            }

            const actionButtonsContainer = document.getElementById('admin-action-buttons');
            if(actionButtonsContainer){
                actionButtonsContainer.innerHTML = `
                    <button id="next-live-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-2xl">
                        ${index + 1 === total ? '‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•' : '‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ'} <i class="fas fa-arrow-right"></i>
                    </button>
                `;

                document.getElementById('next-live-question-btn').addEventListener('click', async () => {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
                    const gameSnap = await getDoc(gameRef);
                    if (!gameSnap.exists()) return;

                    const gameData = gameSnap.data();
                    const updateData = {};
                    
                    if (gameData.players) {
                        for (const playerName in gameData.players) {
                            updateData[`players.${playerName}.answeredCurrentQuestion`] = false;
                        }
                    }
                    
                    const nextIndex = index + 1;
                    if (nextIndex < total) {
                        updateData.currentQuestionIndex = nextIndex;
                        updateData.questionDisplayedAt = serverTimestamp();
                        updateData.questionStatus = 'answering';
                        await updateDoc(gameRef, updateData);
                    } else {
                        await updateDoc(gameRef, { status: 'podium' });
                    }
                });
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setupAuthListener
function setupAuthListener() {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid; 
            userIdDisplay.textContent = userId;

            if (unsubscribeProjectsListener) unsubscribeProjectsListener();
            listenForProjects();
            listenForStarredQuizzes();
            listenForCustomMathTopics(); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        } else {
            await authenticateUser();
        }
    });
}

function showPodiumView(players) {
            const playersArray = Object.entries(players).map(([name, data]) => ({
                name: name,
                score: data.score || 0,
                badges: data.badges || []
            }));

            playersArray.sort((a, b) => {
                const scoreDiff = b.score - a.score;
                if (scoreDiff !== 0) {
                    return scoreDiff;
                }
                return (b.badges.length || 0) - (a.badges.length || 0);
            });

            const renderBadges = (badges) => {
                if (!badges || badges.length === 0) return '';
                const badgeIcons = {
                    quick_thinker: '‚ö°Ô∏è',
                    on_fire: 'üî•'
                };
                return `<div class="flex justify-center gap-2 my-1 text-2xl">${badges.map(b => badgeIcons[b] || '').join('')}</div>`;
            };

            // --- [ ‡πÄ‡∏£‡∏¥‡πà‡∏° ] ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
            const otherPlayers = playersArray.slice(3);
            const otherPlayersHtml = otherPlayers.length > 0 ? `
                <div class="mt-8 w-full max-w-lg bg-black/20 p-4 rounded-lg text-left">
                    <h3 class="text-xl font-bold mb-3 text-center">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>
                    <div class="space-y-2 text-lg">
                        ${otherPlayers.map((player, index) => `
                            <div class="flex justify-between items-center bg-black/10 hover:bg-black/30 p-2 rounded-md transition-colors">
                                <div>
                                    <span class="font-semibold text-gray-300 w-8 inline-block">${index + 4}.</span>
                                    <i class="fas fa-user-circle mr-2 text-gray-300"></i>
                                    <span>${player.name}</span>
                                </div>
                                <span class="font-bold text-white">${player.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            // --- [ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ] ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---

            const podiumHTML = `
                <div class="live-game-bg text-white rounded-lg p-8 flex flex-col h-full items-center justify-center">
                    <h2 class="text-4xl font-bold mb-8">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô! <i class="fas fa-trophy text-yellow-300"></i></h2>

                    <div class="flex items-end justify-center gap-4 w-full max-w-2xl">
                        ${playersArray[1] ? `
                        <div class="podium-step text-center flex-1">
                            <i class="fas fa-user-circle text-6xl mb-2 text-gray-300"></i>
                            <p class="font-bold text-2xl">${playersArray[1].name}</p>
                            ${renderBadges(playersArray[1].badges)}
                            <p class="text-xl">${playersArray[1].score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                            <div class="bg-gray-400 text-gray-900 font-bold p-4 rounded-t-lg mt-2 h-32 flex items-center justify-center text-5xl">2</div>
                        </div>
                        ` : '<div class="flex-1"></div>'}

                        ${playersArray[0] ? `
                        <div class="podium-step text-center flex-1">
                            <i class="fas fa-crown text-6xl mb-2 text-yellow-400"></i>
                            <p class="font-bold text-3xl">${playersArray[0].name}</p>
                            ${renderBadges(playersArray[0].badges)}
                            <p class="text-2xl">${playersArray[0].score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                            <div class="bg-yellow-500 text-yellow-900 font-bold p-4 rounded-t-lg mt-2 h-48 flex items-center justify-center text-6xl">1</div>
                        </div>
                        ` : '<div class="flex-1"></div>'}

                        ${playersArray[2] ? `
                        <div class="podium-step text-center flex-1">
                            <i class="fas fa-user-circle text-6xl mb-2 text-amber-800"></i>
                            <p class="font-bold text-2xl">${playersArray[2].name}</p>
                            ${renderBadges(playersArray[2].badges)}
                            <p class="text-xl">${playersArray[2].score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                            <div class="bg-amber-700 text-amber-100 font-bold p-4 rounded-t-lg mt-2 h-24 flex items-center justify-center text-4xl">3</div>
                        </div>
                        ` : '<div class="flex-1"></div>'}
                    </div>

                    ${otherPlayersHtml} 

                    ${currentMode === 'admin' ? `
                    <button id="close-game-final-btn" class="mt-8 bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700">
                        <i class="fas fa-times-circle mr-2"></i>‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                    ` : `
                    <p class="mt-8 text-lg">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å!</p>
                    `}
                </div>
            `;
            liveGameView.innerHTML = podiumHTML;

            if (currentMode === 'admin') {
                document.getElementById('close-game-final-btn').addEventListener('click', async () => {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
                    await deleteDoc(gameRef);
                    showView('admin-dashboard');
                });
            }
        }

        // ===== Drop-in replacement =====
async function handleStartLiveRace(quizId) {
  // 1) ‡∏´‡∏≤ quiz ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ)
  let quiz = allQuizzes.find(q => q.id === quizId);

  // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏î‡∏à‡∏≤‡∏Å Dashboard) ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ quiz ‡∏ï‡∏£‡∏á‡πÜ
  if (!quiz) {
    const qref = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
    const qsnap = await getDoc(qref);
    if (!qsnap.exists()) {
      showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
      return;
    }
    quiz = { id: qsnap.id, ...qsnap.data() };
  }

  // ‡πÉ‡∏ä‡πâ quiz ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
  currentQuizData = getShuffledQuiz(quiz);

  // ‡πÉ‡∏ä‡πâ projectId ‡∏Ç‡∏≠‡∏á quiz (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏π‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ
  const projectIdForGame = quiz.projectId || currentProjectId || null;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°
  const gamePin = Math.floor(1000 + Math.random() * 9000).toString();
  currentLiveGamePin = gamePin;

  try {
    const gameRef = await addDoc(collection(db, `artifacts/${appId}/public/data/liveGames`), {
      quizId,
      projectId: projectIdForGame,
      status: "lobby",
      currentQuestionIndex: -1,
      players: {},
      gamePin,
      createdAt: serverTimestamp()
    });

    currentLiveGameId = gameRef.id;
    showAdminLobbyView(gamePin, quiz.topic);
    listenForLiveGameUpdates();
  } catch (err) {
    console.error("Error starting live race:", err);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏°");
  }
}

        async function handleShowStudentRankings() {
    // Insert table headers for student leaderboard views
    const quizTableHead = document.querySelector('#student-quiz-leaderboard-content thead');
    if (quizTableHead) {
      quizTableHead.innerHTML = `
        <tr>
          <th class="py-2 px-3 text-center w-16">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
          <th class="py-2 px-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥</th>
          <th class="py-2 px-3 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
          <th class="py-2 px-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)</th>
          <th class="py-2 px-3 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Points</th>
          <th class="py-2 px-3 text-left">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
        </tr>
      `;
    }
    const projectTableHead = document.querySelector('#student-project-leaderboard-content thead');
    if (projectTableHead) {
      projectTableHead.innerHTML = `
        <tr>
          <th class="py-2 px-3 text-center w-16">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
          <th class="py-2 px-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
          <th class="py-2 px-3 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Points)</th>
          <th class="py-2 px-3 text-left">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</th>
        </tr>
      `;
    }
    
            const modal = document.getElementById('student-rankings-modal');
            modal.classList.remove('hidden');

            // Setup close button
            document.getElementById('close-student-rankings-btn').onclick = () => modal.classList.add('hidden');

            // Setup tabs
            const quizTab = document.getElementById('student-quiz-leaderboard-tab');
            const projectTab = document.getElementById('student-project-leaderboard-tab');
            const quizContent = document.getElementById('student-quiz-leaderboard-content');
            const projectContent = document.getElementById('student-project-leaderboard-content');

            quizTab.onclick = () => {
                quizTab.classList.add('active');
                projectTab.classList.remove('active');
                quizContent.classList.remove('hidden');
                projectContent.classList.add('hidden');
            };
            projectTab.onclick = () => {
                projectTab.classList.add('active');
                quizTab.classList.remove('active');
                projectContent.classList.remove('hidden');
                quizContent.classList.add('hidden');
            };

            // Fetch and render data
            try {
                // 1. Fetch data for THIS quiz leaderboard
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${currentQuizData.id}/submissions`);
                const submissionsSnapshot = await getDocs(submissionsRef);
                const submissions = submissionsSnapshot.docs.map(doc => doc.data());
                renderQuizLeaderboard(submissions, currentQuizData, 'student-quiz-leaderboard-table-body');

                // 2. Fetch data for the OVERALL project leaderboard
                const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${currentQuizData.projectId}/studentProfiles`);
                const profilesSnapshot = await getDocs(profilesRef);
                const profiles = profilesSnapshot.docs.map(doc => doc.data());
                renderLeaderboard(profiles, 'student-project-leaderboard-table-body');

            } catch (error) {
                console.error("Error fetching student rankings:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ");
            }
        }

        async function handleSaveToBank(e) {
    const btn = e.currentTarget;
    const index = btn.dataset.index;
    const questionData = currentQuizData.questions[index];

    if (!userId) {
        showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
        return;
    }

    try {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        const dataToSave = {
            ...questionData,
            originalTopic: currentQuizData.topic, 
            savedAt: serverTimestamp()
        };

        const bankCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/questionBank`);
        await addDoc(bankCollectionRef, dataToSave);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ó‡∏£‡∏≤‡∏ö
        showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß");
        btn.classList.remove('text-purple-600');
        btn.classList.add('text-green-600'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        btn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
    } catch (error) {
        console.error("Error saving to question bank:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
    }
}

function listenForStarredQuizzes() {
            if (!userId) return;
            const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
            const q = query(quizzesRef, where("isStarred", "==", true));

            onSnapshot(q, (snapshot) => {
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
                starredQuizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderProjects() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏£‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ "‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                renderProjects();
            }, (error) => {
                console.error("Error listening for starred quizzes:", error);
            });
        }

async function handleToggleStarQuiz(quizId) {
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
            try {
                const quizDoc = await getDoc(quizRef);
                if (quizDoc.exists()) {
                    const currentStatus = quizDoc.data().isStarred || false;
                    await updateDoc(quizRef, {
                        isStarred: !currentStatus
                    });
                }
            } catch (error) {
                console.error("Error toggling star status:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß");
            }
        }

async function displayQuestionBank() {
    const container = document.getElementById('bank-input-area');
    container.innerHTML = '<div class="loader mx-auto"></div>'; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î

    try {
        const bankCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/questionBank`);
        const q = query(bankCollectionRef); // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° orderBy ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            container.innerHTML = '<p class="text-center text-gray-500">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</p>';
            return;
        }

        let questionsHTML = snapshot.docs.map(doc => {
            const question = doc.data();
            const questionId = doc.id;
            return `
                <div class="flex items-start gap-3 p-2 border-b">
                    <input type="checkbox" value='${JSON.stringify(question)}' class="mt-1 h-4 w-4">
                    <div>
                        <p class="font-semibold">${question.questionText || question.stem}</p>
                        <p class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${question.originalTopic}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div class="max-h-60 overflow-y-auto border rounded-lg p-2">${questionsHTML}</div>
            <button id="create-from-bank-btn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700">
                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </button>
        `;

        document.getElementById('create-from-bank-btn').addEventListener('click', createQuizFromBank);

    } catch (error) {
        console.error("Error displaying question bank:", error);
        container.innerHTML = '<p class="text-center text-red-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ</p>';
    }
}

function showAdminLiveQuestionView(question, index, total) {
            const questionType = question.questionType || currentQuizData.quizType; //
            let optionsHTML = '';

            // --- CHANGE 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢ ---
            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° data-attribute ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if(questionType === 'multiple_choice' || questionType === 'true_false') {
                const options = questionType === 'true_false' ? ['‡πÉ‡∏ä‡πà', '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà'] : question.options;
                const correctIndex = questionType === 'true_false' ? (question.correctAnswer ? 0 : 1) : question.correctAnswerIndex;

                optionsHTML = options.map((opt, i) => `
                    <div class="p-4 rounded-lg text-xl flex items-center justify-center text-center bg-white/30" data-is-correct="${i === correctIndex}">
                        ${opt}
                    </div>
                `).join('');
            } else if (questionType === 'matching_item') { // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
                const options = question.allResponses || [];
                optionsHTML = options.map(opt => `
                    <div class="p-4 rounded-lg text-xl flex items-center justify-center text-center bg-white/30" data-is-correct="${opt === question.correctResponse}">
                        ${opt}
                    </div>
                `).join('');
            }

						const questionDisplayText = question.stem || question.questionText; // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            const adminQuestionHTML = `
                <div class="live-game-bg text-white rounded-lg p-8 flex flex-col h-full">
                    <div class="flex justify-between items-center text-lg">
                        <span>‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1} / ${total}</span>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-base">
                            ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: <span id="answer-counter" class="font-bold">0/0</span>
                        </span>
                        <button id="end-game-btn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm">‡∏à‡∏ö‡πÄ‡∏Å‡∏°</button>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center">
                        <h2 class="text-3xl font-bold mb-8 text-center">${questionDisplayText}</h2>
                        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${optionsHTML}
                        </div>
                    </div>
                    <div id="admin-action-buttons" class="text-center mt-8">
                        <button id="reveal-answer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg text-2xl">
                            <i class="fas fa-eye"></i> ‡πÄ‡∏â‡∏•‡∏¢
                        </button>
                    </div>
                </div>
            `; //
            liveGameView.innerHTML = adminQuestionHTML; //
            
            if (window.MathJax && MathJax.typesetPromise) { MathJax.typesetPromise([liveGameView]); } //

            // --- CHANGE 3: ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
            const actionButtonsContainer = document.getElementById('admin-action-buttons'); //

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏â‡∏•‡∏¢"
            document.getElementById('reveal-answer-btn').addEventListener('click', async () => { // <-- [ ‡πÄ‡∏û‡∏¥‡πà‡∏° async ]
                // --- [ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ] ---
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ Client ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
                await updateDoc(gameRef, { questionStatus: 'revealed' });
                // --- [ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ] ---

                // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const correctOption = liveGameView.querySelector('[data-is-correct="true"]'); //
                if (correctOption) {
                    // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° Style ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô)
                    correctOption.classList.remove('bg-white/30'); //
                    correctOption.classList.add('bg-green-300', 'text-green-900', 'font-bold', 'border-4', 'border-green-500'); //
                    correctOption.innerHTML = `<i class="fas fa-check mr-3"></i>` + correctOption.innerHTML; //
                }

                // 3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏â‡∏•‡∏¢" ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ"
                actionButtonsContainer.innerHTML = `
                    <button id="next-live-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-2xl">
                        ${index + 1 === total ? '‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•' : '‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ'} <i class="fas fa-arrow-right"></i>
                    </button>
                `; //

                // 4. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                document.getElementById('next-live-question-btn').addEventListener('click', async () => { //
                    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId); //
                    const gameSnap = await getDoc(gameRef); //
                    if (!gameSnap.exists()) return;

                    const gameData = gameSnap.data(); //
                    const updateData = {};
                    
                    if (gameData.players) {
                        for (const playerName in gameData.players) {
                            updateData[`players.${playerName}.answeredCurrentQuestion`] = false;
                        }
                    }
                    
                    const nextIndex = index + 1; //
                    if (nextIndex < total) {
                        updateData.currentQuestionIndex = nextIndex; //
                        updateData.questionDisplayedAt = serverTimestamp(); //
                        updateData.questionStatus = 'answering'; // <-- [ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ] ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
                        await updateDoc(gameRef, updateData); //
                    } else {
                        await updateDoc(gameRef, { status: 'podium' }); //
                    }
                });
            });

            // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            document.getElementById('end-game-btn').addEventListener('click', async () => { //
                const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId); //
                await deleteDoc(gameRef); //
                showView('admin-dashboard'); //
            });
        }

function showStudentLiveQuestionView(question, index, total) {
    const questionType = question.questionType || currentQuizData.quizType;
    let optionsHTML = '';

            if(questionType === 'multiple_choice' || questionType === 'true_false') {
                const options = questionType === 'true_false' ? ['‡πÉ‡∏ä‡πà', '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà'] : question.options;
                optionsHTML = options.map((opt, i) => `
                    <button data-index="${i}" class="live-answer-btn p-4 rounded-lg text-xl text-center bg-white text-gray-800 hover:bg-indigo-100 transition-all transform hover:scale-105">
                        ${opt}
                    </button>
                `).join('');
            } else if (questionType === 'matching_item') { // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
                const options = question.allResponses || [];
                optionsHTML = options.map((opt, i) => `
                    <button data-index="${i}" class="live-answer-btn p-4 rounded-lg text-xl text-center bg-white text-gray-800 hover:bg-indigo-100 transition-all transform hover:scale-105">
                        ${opt}
                    </button>
                `).join('');
				} else if (questionType === 'short_answer') { // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
                optionsHTML = `
                    <div class="w-full md:col-span-2 flex flex-col items-center gap-4">
                        <textarea id="live-short-answer-input" class="w-full max-w-lg p-3 border rounded-lg text-gray-800 text-lg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea>
                        <button id="live-submit-short-answer-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl">
                            <i class="fas fa-paper-plane mr-2"></i>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                        </button>
                    </div>
                `;
            }

				const questionDisplayText = question.stem || question.questionText; // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    const studentQuestionHTML = `
        <div class="live-game-bg text-white rounded-lg p-8 flex flex-col h-full">
            <p class="text-lg text-center">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1} / ${total}</p>
            <div class="flex-grow flex flex-col items-center justify-center">
                <h2 class="text-3xl font-bold mb-8 text-center">${questionDisplayText}</h2>
                <div id="live-options-container" class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${optionsHTML}
                </div>
            </div>
        </div>
    `;
    liveGameView.innerHTML = studentQuestionHTML;

    
    // Typeset math after injecting student live question
    if (window.MathJax && MathJax.typesetPromise) { MathJax.typesetPromise([liveGameView]); }
	
	 // --- [ ‡πÄ‡∏£‡∏¥‡πà‡∏° ] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ---
    const submitShortAnswerBtn = document.getElementById('live-submit-short-answer-btn');
    if (submitShortAnswerBtn) {
        submitShortAnswerBtn.addEventListener('click', () => {
            const answerText = document.getElementById('live-short-answer-input').value;
            handleLiveAnswer(answerText, question); // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
        });
    }
    // --- [ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ---
	
// Add event listener for student answers
    document.getElementById('live-options-container').addEventListener('click', (e) => {
        const btn = e.target.closest('.live-answer-btn');
        if (btn) {
            const answerIndex = parseInt(btn.dataset.index);
            handleLiveAnswer(answerIndex, question);
        }
    });
}

async function handleLiveAnswer(answerIndex, question) {
    // Disable all buttons after answering to prevent multiple submissions
    document.querySelectorAll('.live-answer-btn, #live-submit-short-answer-btn').forEach(b => b.disabled = true);

    const questionType = question.questionType || currentQuizData.quizType;
    let isCorrect = false;

    // Determine if the selected answer is correct
    if (questionType === 'short_answer') {
        // --- [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ---
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏°‡∏™‡∏î ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå answerIndex
        const userAnswer = (answerIndex || '').toString(); 
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
        isCorrect = await gradeShortAnswer(userAnswer, question);
        // --- [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ---
    }
    else if (questionType === 'multiple_choice') {
        isCorrect = answerIndex === question.correctAnswerIndex;
    } else if (questionType === 'true_false') {
        const correctAnswerBool = question.correctAnswer;
        isCorrect = (answerIndex === 0 && correctAnswerBool) || (answerIndex === 1 && !correctAnswerBool);
    } else if (questionType === 'matching_item') {
        const selectedResponse = question.allResponses[answerIndex];
        isCorrect = selectedResponse === question.correctResponse;
    }

    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
    const gameSnap = await getDoc(gameRef);

    if (!gameSnap.exists()) return;

    const gameData = gameSnap.data();
    const playerData = gameData.players[currentStudentName];
    
    // --- UPDATED LOGIC FOR DYNAMIC SCORING & BADGES ---
    let playerBadges = playerData.badges || [];
    let playerStreak = playerData.correctStreak || 0;
    const updatePayload = {};
    let calculatedPoints = 0;

    // 1. Calculate time taken
    if (gameData.questionDisplayedAt) {
        const questionStartTime = gameData.questionDisplayedAt.toDate();
        const timeTaken = new Date() - questionStartTime; // in milliseconds

        if (isCorrect) {
            // 2. Calculate dynamic points based on speed
            const maxPoints = 1000;
            const bonusPoints = 500; // Points decay over time
            const timeLimit = 20000; // 20 seconds

            let timeRatio = timeTaken / timeLimit;
            if (timeRatio > 1) timeRatio = 1;

            const pointsLost = Math.round(timeRatio * bonusPoints);
            calculatedPoints = maxPoints - pointsLost;

            // 3. Award "Quick Thinker" badge
            if (timeTaken <= 5000 && !playerBadges.includes('quick_thinker')) {
                playerBadges.push('quick_thinker');
            }
        }
    }
    
    // 4. Award "On Fire" badge
    if (isCorrect) {
        playerStreak++;
        if (playerStreak === 3 && !playerBadges.includes('on_fire')) {
            playerBadges.push('on_fire');
            playerStreak = 0;
        }
    } else {
        playerStreak = 0;
    }
    
    // 5. Prepare payload for Firestore update
    if (isCorrect) {
        updatePayload[`players.${currentStudentName}.score`] = increment(calculatedPoints);
    }
    updatePayload[`players.${currentStudentName}.badges`] = playerBadges;
    updatePayload[`players.${currentStudentName}.correctStreak`] = playerStreak;
    updatePayload[`players.${currentStudentName}.answeredCurrentQuestion`] = true;
    updatePayload[`players.${currentStudentName}.lastAnswerCorrect`] = isCorrect;
    updatePayload[`players.${currentStudentName}.pointsLastQuestion`] = calculatedPoints;


    // 6. Update Firestore
    await updateDoc(gameRef, updatePayload);
    // --- END OF UPDATED LOGIC ---

    // Show the waiting screen
    liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
        <h2 class="text-3xl font-bold">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h2>
        <p class="mt-8">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
        <div class="loader mt-4"></div>
    </div>`;
}

function createQuizFromBank() {
    const selectedCheckboxes = document.querySelectorAll('#bank-input-area input[type="checkbox"]:checked');
    if (selectedCheckboxes.length === 0) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠");
        return;
    }

    const questions = [];
    selectedCheckboxes.forEach(box => {
        questions.push(JSON.parse(box.value));
    });

    const newQuizData = {
        topic: "‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß",
        questions: questions
    };

    displayGeneratedQuiz(newQuizData);
}

        function showAdminLobbyView(gamePin, quizTopic) {
    showView('live-game'); // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà container ‡∏Ç‡∏≠‡∏á live game

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Lobby (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const lobbyHTML = `
        <div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
            <h2 class="text-2xl font-bold mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°: ${quizTopic}</h2>
            <p class="text-lg mb-4">‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ:</p>
            <div class="bg-white text-gray-800 rounded-lg p-4 mb-4">
                <p class="text-6xl font-bold tracking-widest">${gamePin}</p>
            </div>
            <div class="w-full max-w-md bg-white/20 p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (<span id="player-count">0</span>)</h3>
                <div id="player-list-lobby" class="flex flex-wrap justify-center gap-2">
                    </div>
            </div>
            <button id="start-game-btn" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-2xl transition-transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
            </button>
        </div>
    `;
    liveGameView.innerHTML = lobbyHTML;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Event Listener ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ---
    document.getElementById('start-game-btn').addEventListener('click', async () => {
        if (!currentQuizData || !currentQuizData.questions || currentQuizData.questions.length === 0) {
            showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ");
            return;
        }
        
        try {
            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
            await updateDoc(gameRef, {
                status: 'question',
                currentQuestionIndex: 0,
                questionDisplayedAt: serverTimestamp()
            });

            // 2. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Admin ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤)
            const firstQuestion = currentQuizData.questions[0];
            const totalQuestions = currentQuizData.questions.length;
            showAdminLiveQuestionView(firstQuestion, 0, totalQuestions);

        } catch (error) {
            console.error("Error starting game:", error);
            showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ");
        }
    });
}

async function openGlobalLiveModal() {
  // ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ (‡∏î‡∏∂‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
  if (allQuizzesGlobal.length === 0) {
    const qs = await getDocs(collection(db, `artifacts/${appId}/public/data/quizzes`));
    allQuizzesGlobal = qs.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  renderGlobalQuizList('');
  document.getElementById('global-live-game-modal').classList.remove('hidden');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
async function openQuizBankModal() {
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
  if (allQuizzesGlobal.length === 0) {
    const qs = await getDocs(collection(db, `artifacts/${appId}/public/data/quizzes`));
    allQuizzesGlobal = qs.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Modal
  renderQuizBankList('');
  document.getElementById('quiz-bank-modal').classList.remove('hidden');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Modal
function renderQuizBankList(filterText = '') {
  const listEl = document.getElementById('bank-quiz-list');
  const term = filterText.toLowerCase().trim();

  const rows = allQuizzesGlobal
    .map(q => ({
      ...q,
      projectName: (allProjects.find(p => p.id === q.projectId)?.projectName) || 'N/A'
    }))
    .filter(q =>
      (q.topic || '').toLowerCase().includes(term) ||
      (q.projectName || '').toLowerCase().includes(term) ||
      (q.id.toString().includes(term)) // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Quiz ID ‡πÑ‡∏î‡πâ
    );
	
	document.getElementById('quiz-bank-count').textContent = `(${rows.length} ‡∏ä‡∏∏‡∏î)`;

 listEl.innerHTML = rows.length
  ? rows.map(q => `
      <div class="w-full text-left p-3 border-b hover:bg-gray-100 flex items-center justify-between">
        <div data-id="${q.id}" class="quiz-bank-item flex-grow cursor-pointer">
          <p class="font-semibold text-indigo-700">${q.topic || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)'}
            <span class="text-sm font-normal text-gray-500">(${q.questions?.length || 0} ‡∏Ç‡πâ‡∏≠)</span>
          </p>
          <p class="text-xs text-gray-600">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ: ${q.projectName}</p>
          <p class="text-xs text-gray-600 font-mono mt-1">Quiz ID: ${q.id}</p>
        </div>
        <div class="flex items-center gap-4 ml-4 shrink-0">
            <button data-id="${q.id}" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô" class="quiz-bank-parallel-btn text-teal-600 hover:text-teal-800 text-xl p-2 rounded-full hover:bg-gray-200">
                <i class="fas fa-clone pointer-events-none"></i>
            </button>
            <button data-id="${q.id}" title="‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠" class="quiz-bank-present-btn text-indigo-600 hover:text-indigo-800 text-xl p-2 rounded-full hover:bg-gray-200">
                <i class="fas fa-chalkboard-teacher pointer-events-none"></i>
            </button>
            <button data-id="${q.id}" title="‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö" class="quiz-bank-try-btn text-purple-600 hover:text-purple-800 text-xl p-2 rounded-full hover:bg-gray-200">
                <i class="fas fa-vial pointer-events-none"></i>
            </button>
        </div>
        </div>
    `).join('')
  : `<div class="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>`;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
  listEl.querySelectorAll('.quiz-bank-item').forEach(btn => {
    btn.addEventListener('click', () => {
      const quizId = btn.dataset.id;
      document.getElementById('quiz-bank-modal').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô Modal
      showQuizDetailView(quizId); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•
    });
  });
  
  // ‚ñº‚ñº‚ñº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚ñº‚ñº‚ñº
// Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏≥" ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
listEl.querySelectorAll('.quiz-bank-try-btn').forEach(btn => {
    btn.addEventListener('click', (event) => {
        event.stopPropagation(); // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

        const quizId = btn.dataset.id;
        const quizData = allQuizzesGlobal.find(q => q.id === quizId);

        if (quizData) {
            currentQuizData = quizData; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏•‡∏≠‡∏á
            document.getElementById('quiz-bank-modal').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô Modal
            startAdminTest(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
        } else {
            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
        }
    });
});

listEl.querySelectorAll('.quiz-bank-parallel-btn').forEach(btn => {
    btn.addEventListener('click', (event) => {
        event.stopPropagation();
        const quizId = btn.dataset.id;
        const quizData = allQuizzesGlobal.find(q => q.id === quizId);

        if (quizData) {
            document.getElementById('quiz-bank-modal').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô Modal
            handleGenerateParallelFromBank(quizData); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
        } else {
            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
        }
    });
});

listEl.querySelectorAll('.quiz-bank-present-btn').forEach(btn => {
    btn.addEventListener('click', (event) => {
        event.stopPropagation();
        const quizId = btn.dataset.id;
        const quizData = allQuizzesGlobal.find(q => q.id === quizId);

        if (quizData) {
            document.getElementById('quiz-bank-modal').classList.add('hidden');
            startPresentation(quizData); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏î‡∏¥‡∏°
        } else {
            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
        }
    });
});
  
}

function renderGlobalQuizList(filterText = '') {
  const listEl = document.getElementById('global-quiz-list');
  const term = filterText.toLowerCase().trim();

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞ quiz ‡∏à‡∏≤‡∏Å allProjects ‡∏ó‡∏µ‡πà listen ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
  const rows = allQuizzesGlobal
    .map(q => ({
      ...q,
      projectName: (allProjects.find(p => p.id === q.projectId)?.projectName) || q.projectId
    }))
    .filter(q =>
      (q.topic || '').toLowerCase().includes(term) ||
      (q.projectName || '').toLowerCase().includes(term)
    );

document.getElementById('global-live-game-count').textContent = `(${rows.length} ‡∏ä‡∏∏‡∏î)`;

  listEl.innerHTML = rows.length
    ? rows.map(q => `
        <button data-id="${q.id}"
                class="w-full text-left p-2 border-b hover:bg-gray-50 flex items-center justify-between">
          <div>
            <div class="font-semibold">
  ${q.topic || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)'}
  <span class="text-sm font-normal text-gray-500">(${(q.questions?.length || 0)} ‡∏Ç‡πâ‡∏≠)</span>
</div>
            <div class="text-xs text-gray-500">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ: ${q.projectName}</div>
          </div>
          <i class="fas fa-play text-purple-600"></i>
        </button>
      `).join('')
    : `<div class="p-3 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>`;

  selectedGlobalQuizId = null;
  document.getElementById('confirm-global-live-btn').disabled = true;

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  listEl.querySelectorAll('button[data-id]').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedGlobalQuizId = btn.dataset.id;
      listEl.querySelectorAll('button').forEach(b => b.classList.remove('bg-purple-50','ring-2','ring-purple-400'));
      btn.classList.add('bg-purple-50','ring-2','ring-purple-400');
      document.getElementById('confirm-global-live-btn').disabled = false;
    });
  });
}

        function listenForLiveGameUpdates() {
            if (unsubscribeLiveGameListener) unsubscribeLiveGameListener(); 

            const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
            unsubscribeLiveGameListener = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessage("‡πÄ‡∏Å‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß");
                    showView(currentMode); 
                    return;
                }

                const gameData = docSnap.data();

                if (!currentQuizData && gameData.quizId) {
                    (async () => {
                        try {
                            const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, gameData.quizId);
                            const quizDocSnap = await getDoc(quizDocRef);
                            if (quizDocSnap.exists()) {
                                currentQuizData = { id: quizDocSnap.id, ...quizDocSnap.data() };
                            }
                        } catch (e) { console.error('Failed to fetch quiz for admin:', e); }
                    })();
                }

                switch (gameData.status) {
                    case 'lobby':
                        if (currentMode === 'admin') {
                            const players = gameData.players ? Object.keys(gameData.players) : [];
                            document.getElementById('player-count').textContent = players.length;
                            document.getElementById('player-list-lobby').innerHTML = players.map(name => `<span class="bg-white/30 px-3 py-1 rounded-full text-sm">${name}</span>`).join('');
                            const startGameBtn = document.getElementById('start-game-btn');
							if (startGameBtn) {
								startGameBtn.disabled = players.length === 0;
							}
                        } else {
                            showView('live-game');
                            liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
                                <h2 class="text-3xl font-bold">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß!</h2>
                                <p class="text-xl mt-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: <span class="font-bold">${currentStudentName}</span></p>
                                <p class="mt-8">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                                <div class="loader mt-4"></div>
                            </div>`;
                        }
                        break;

                    case 'question':
						const questionIndex = gameData.currentQuestionIndex;
						if (currentQuizData && currentQuizData.questions[questionIndex]) {
							const questionData = currentQuizData.questions[questionIndex];
							const totalQuestions = currentQuizData.questions.length;
							
							if (currentMode === 'admin') {
								// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ß‡∏≤‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ index
								if (lastRenderedAdminQuestionIndex !== questionIndex) {
									showAdminLiveQuestionView(questionData, questionIndex, totalQuestions);
									lastRenderedAdminQuestionIndex = questionIndex; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
								}
								
								// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
								const answerCounterEl = document.getElementById('answer-counter');
								if (answerCounterEl && gameData.players) {
									const totalPlayers = Object.keys(gameData.players).length;
									const answeredPlayers = Object.values(gameData.players).filter(p => p.answeredCurrentQuestion === true).length;
									answerCounterEl.textContent = `${answeredPlayers}/${totalPlayers}`;

									// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (Logic ‡πÄ‡∏â‡∏•‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
									if (totalPlayers > 0 && answeredPlayers === totalPlayers && gameData.questionStatus !== 'revealed') {
										revealAnswerForAdmin(questionIndex, totalQuestions);
									}
								}
							} else {
								// ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ù‡∏±‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                                const playerData = gameData.players[currentStudentName];
								
								if (gameData.questionStatus === 'revealed') {
									if (playerData.answeredCurrentQuestion) {
										const wasCorrect = playerData.lastAnswerCorrect;
										const pointsEarned = playerData.pointsLastQuestion || 0;
										const resultText = wasCorrect 
											? `‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! +${pointsEarned} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô` 
											: '‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î';
										liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
											<h2 class="text-3xl font-bold">${resultText}</h2>
											<p class="mt-8">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ...</p>
											<div class="loader mt-4"></div>
										 </div>`;
									} else {
										liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
											<h2 class="text-3xl font-bold">‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!</h2>
											<p class="mt-8">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ...</p>
											<div class="loader mt-4"></div>
										 </div>`;
									}
								} else {
									if (!playerData.answeredCurrentQuestion) {
										showStudentLiveQuestionView(questionData, questionIndex, totalQuestions);
									}
								}
							}
						}
						break;
						
                    case 'podium':
                        showPodiumView(gameData.players);
                        break;       
                }
            });
        }

        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showMessage("‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
            }
        }

        // --- UI & Mode Switching ---
        function showView(view) {
            const allViews = ['admin-view', 'student-view', 'project-dashboard-view', 'project-detail-view', 'quiz-results-view', 'live-game-view'];
            allViews.forEach(v => document.getElementById(v)?.classList.add('hidden'));

            if (view === 'admin-dashboard') {
                adminView.classList.remove('hidden');
                projectDashboardView.classList.remove('hidden');
            } else if (view === 'student') {
                studentView.classList.remove('hidden');
                studentInitialView.classList.remove('hidden');
                studentNameSelectionView.classList.add('hidden');
                studentQuizArea.classList.add('hidden');
                studentResultArea.classList.add('hidden');
                studentReadingArea.classList.add('hidden');
                studentJoinGameView.classList.add('hidden');
            } else if (view === 'project-detail') {
                adminView.classList.remove('hidden');
                projectDetailView.classList.remove('hidden');
            } else if (view === 'quiz-results') {
                adminView.classList.remove('hidden');
                quizResultsView.classList.remove('hidden');
            } else if (view === 'live-game') {
                liveGameView.classList.remove('hidden');
            }
        }
        
        function showJoinGameView() {
            studentInitialView.classList.add('hidden');
            studentJoinGameView.classList.remove('hidden');
        }
        
        function setupEventListeners() {
            // New unified mode switcher
            document.getElementById('mode-switcher-btn').addEventListener('click', handleModeSwitch);
			
			document.getElementById('add-custom-math-topic-btn').addEventListener('click', handleAddCustomMathTopic);
			
			document.getElementById('select-all-topics-btn').addEventListener('click', handleSelectAllTopics);
        document.getElementById('deselect-all-topics-btn').addEventListener('click', handleDeselectAllTopics);

            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
                currentProjectId = null;
                currentProjectData = null;
                if (unsubscribeStudentsListener) unsubscribeStudentsListener();
                if (unsubscribeQuizzesListener) unsubscribeQuizzesListener();
                if (unsubscribeStudentProfilesListener) unsubscribeStudentProfilesListener();
                showView('admin-dashboard');
            });
            document.getElementById('back-to-project-btn').addEventListener('click', () => {
                if (unsubscribeSubmissionsListener) unsubscribeSubmissionsListener();
                showView('project-detail');
            });

            document.getElementById('back-to-dashboard-from-results-btn').addEventListener('click', () => {
                showView('admin-dashboard');
            });
            
            // Modals
            document.getElementById('modal-close-btn').addEventListener('click', () => messageModal.classList.add('hidden'));
            document.getElementById('create-project-btn').addEventListener('click', () => createProjectModal.classList.remove('hidden'));
            document.getElementById('cancel-create-project-btn').addEventListener('click', () => createProjectModal.classList.add('hidden'));
            
            // Admin Password Modal
            document.getElementById('cancel-admin-login-btn').addEventListener('click', () => adminPasswordModal.classList.add('hidden'));
            document.getElementById('confirm-admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-password-input').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleAdminLogin();
            });

            // Confirmation Modal
            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                confirmAction = null;
            });
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                if (confirmAction) {
                    confirmAction();
                }
                confirmationModal.classList.add('hidden');
                confirmAction = null;
            });

            // Modal Listeners
            document.getElementById('cancel-rename-quiz-btn').addEventListener('click', () => renameQuizModal.classList.add('hidden'));
            document.getElementById('confirm-rename-quiz-btn').addEventListener('click', confirmRenameQuiz);
            document.getElementById('cancel-move-quiz-btn').addEventListener('click', () => moveQuizModal.classList.add('hidden'));
            document.getElementById('confirm-move-quiz-btn').addEventListener('click', confirmMoveQuiz);
            document.getElementById('cancel-quiz-settings-btn').addEventListener('click', () => quizSettingsModal.classList.add('hidden'));
            document.getElementById('confirm-quiz-settings-btn').addEventListener('click', confirmQuizSettings);
            document.getElementById('cancel-quiz-status-btn').addEventListener('click', () => quizStatusModal.classList.add('hidden'));
            document.getElementById('confirm-quiz-status-btn').addEventListener('click', confirmQuizStatus);
			// ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ
            document.getElementById('open-global-live-btn')
            .addEventListener('click', openGlobalLiveModal);

            // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal
            document.getElementById('cancel-global-live-btn')
            .addEventListener('click', () => {
                document.getElementById('global-live-game-modal').classList.add('hidden');
                selectedGlobalQuizId = null;
            });

            document.getElementById('global-quiz-search-input')
            .addEventListener('input', (e) => renderGlobalQuizList(e.target.value));

            document.getElementById('confirm-global-live-btn')
            .addEventListener('click', () => {
                const id = selectedGlobalQuizId;
                if (!id) return;
                document.getElementById('global-live-game-modal').classList.add('hidden');
                handleStartLiveRace(id); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
            });  
            // Search and Sort Listeners
            document.getElementById('project-search-input').addEventListener('input', renderProjects);
            document.getElementById('project-sort-select').addEventListener('change', renderProjects);
            document.getElementById('quiz-search-input').addEventListener('input', renderQuizzes);


            // Project Detail Tabs
            manageTab.addEventListener('click', () => switchProjectTab('manage'));
            resultsTab.addEventListener('click', () => switchProjectTab('results'));
            leaderboardTab.addEventListener('click', () => switchProjectTab('leaderboard'));

            // Quiz Results Tabs
            document.getElementById('analytics-tab-btn').addEventListener('click', () => switchQuizDetailTab('analytics'));
            document.getElementById('scores-tab-btn').addEventListener('click', () => switchQuizDetailTab('scores'));
            document.getElementById('leaderboard-quiz-tab-btn').addEventListener('click', () => switchQuizDetailTab('leaderboard-quiz'));
            document.getElementById('analyze-strengths-btn').addEventListener('click', handleAnalyzeClass);
            generateWorksheetBtn.addEventListener('click', generateWorksheet);
            
            // --- START: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå" ---
            const linkTab = document.getElementById('link-tab');
            const linkInputArea = document.getElementById('link-input-area');
            
            // --- ‚ñº‚ñº‚ñº [‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ UI ‡πÉ‡∏´‡∏°‡πà] ‚ñº‚ñº‚ñº ---
            const blueprintTab = document.getElementById('blueprint-tab');
            const blueprintInputArea = document.getElementById('blueprint-input-area');
            // --- ‚ñ≤‚ñ≤‚ñ≤ [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£] ‚ñ≤‚ñ≤‚ñ≤ ---
			
			const parallelTestTab = document.getElementById('parallel-test-tab');
const parallelTestInputArea = document.getElementById('parallel-test-input-area');

            // Generation Tabs
            topicTab.addEventListener('click', () => {
                topicTab.classList.add('active');
                textTab.classList.remove('active');
                fileTab.classList.remove('active');
                worksheetTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                if(blueprintTab) blueprintTab.classList.remove('active'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                
                topicInputArea.classList.remove('hidden');
                textInputArea.classList.add('hidden');
                fileInputArea.classList.add('hidden');
                worksheetInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
                if(blueprintInputArea) blueprintInputArea.classList.add('hidden'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            });

            textTab.addEventListener('click', () => {
                textTab.classList.add('active');
                topicTab.classList.remove('active');
                fileTab.classList.remove('active');
                worksheetTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                if(blueprintTab) blueprintTab.classList.remove('active'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï

                textInputArea.classList.remove('hidden');
                topicInputArea.classList.add('hidden');
                fileInputArea.classList.add('hidden');
                worksheetInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
                if(blueprintInputArea) blueprintInputArea.classList.add('hidden'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            });

            fileTab.addEventListener('click', () => {
                fileTab.classList.add('active');
                topicTab.classList.remove('active');
                textTab.classList.remove('active');
                worksheetTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                if(blueprintTab) blueprintTab.classList.remove('active'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï

                fileInputArea.classList.remove('hidden');
                topicInputArea.classList.add('hidden');
                textInputArea.classList.add('hidden');
                worksheetInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
                if(blueprintInputArea) blueprintInputArea.classList.add('hidden'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            });
            
            worksheetTab.addEventListener('click', () => {
                worksheetTab.classList.add('active');
                topicTab.classList.remove('active');
                textTab.classList.remove('active');
                fileTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                if(blueprintTab) blueprintTab.classList.remove('active'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï

                worksheetInputArea.classList.remove('hidden');
                topicInputArea.classList.add('hidden');
                textInputArea.classList.add('hidden');
                fileInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
                if(blueprintInputArea) blueprintInputArea.classList.add('hidden'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            });

            const bankTab = document.getElementById('bank-tab');
            const bankInputArea = document.getElementById('bank-input-area');

            if(bankTab) {
                bankTab.addEventListener('click', () => {
                    // Deactivate other tabs
                    topicTab.classList.remove('active');
                    textTab.classList.remove('active');
                    fileTab.classList.remove('active');
                    worksheetTab.classList.remove('active');
                    if(linkTab) linkTab.classList.remove('active');
                    if(blueprintTab) blueprintTab.classList.remove('active'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                    
                    // Activate this tab
                    bankTab.classList.add('active');

                    // Hide other input areas
                    topicInputArea.classList.add('hidden');
                    textInputArea.classList.add('hidden');
                    fileInputArea.classList.add('hidden');
                    worksheetInputArea.classList.add('hidden');
                    if(linkInputArea) linkInputArea.classList.add('hidden');
                    if(blueprintInputArea) blueprintInputArea.classList.add('hidden'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï

                    // Show this input area and load the questions
                    bankInputArea.classList.remove('hidden');
                    displayQuestionBank(); 
                });
            }

            if(linkTab) {
                linkTab.addEventListener('click', () => {
                    topicTab.classList.remove('active');
                    textTab.classList.remove('active');
                    fileTab.classList.remove('active');
                    worksheetTab.classList.remove('active');
                    linkTab.classList.add('active');
                    if(blueprintTab) blueprintTab.classList.remove('active'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï

                    topicInputArea.classList.add('hidden');
                    textInputArea.classList.add('hidden');
                    fileInputArea.classList.add('hidden');
                    worksheetInputArea.classList.add('hidden');
                    linkInputArea.classList.remove('hidden');
                    if(blueprintInputArea) blueprintInputArea.classList.add('hidden'); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                });
                document.getElementById('generate-from-link-btn').addEventListener('click', handleGenerateFromLink);
            }
            // --- END: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå" ---

            // --- ‚ñº‚ñº‚ñº [‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö Blueprint ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î] ‚ñº‚ñº‚ñº ---
            if(blueprintTab) {
                blueprintTab.addEventListener('click', () => {
                    // Deactivate other tabs
                    topicTab.classList.remove('active');
                    textTab.classList.remove('active');
                    fileTab.classList.remove('active');
                    worksheetTab.classList.remove('active');
                    if(linkTab) linkTab.classList.remove('active');
                    if(bankTab) bankTab.classList.remove('active');
                    
                    // Activate this tab
                    blueprintTab.classList.add('active');
    
                    // Hide other input areas
                    topicInputArea.classList.add('hidden');
                    textInputArea.classList.add('hidden');
                    fileInputArea.classList.add('hidden');
                    worksheetInputArea.classList.add('hidden');
                    if(linkInputArea) linkInputArea.classList.add('hidden');
                    if(bankInputArea) bankInputArea.classList.add('hidden');
    
                    // Show this input area
                    blueprintInputArea.classList.remove('hidden');
                });
            }
			
			// === ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===
if(parallelTestTab) {
    parallelTestTab.addEventListener('click', () => {
        // Deactivate other tabs
        topicTab.classList.remove('active');
        textTab.classList.remove('active');
        fileTab.classList.remove('active');
        worksheetTab.classList.remove('active');
        if(linkTab) linkTab.classList.remove('active');
        if(blueprintTab) blueprintTab.classList.remove('active');

        // Activate this tab
        parallelTestTab.classList.add('active');

        // Hide other input areas
        topicInputArea.classList.add('hidden');
        textInputArea.classList.add('hidden');
        fileInputArea.classList.add('hidden');
        worksheetInputArea.classList.add('hidden');
        if(linkInputArea) linkInputArea.classList.add('hidden');
        if(blueprintInputArea) blueprintInputArea.classList.add('hidden');

        // Show this input area
        parallelTestInputArea.classList.remove('hidden');
    });
}

            const blueprintUploadInput = document.getElementById('blueprint-upload-input');
            const generateFromBlueprintBtn = document.getElementById('generate-from-blueprint-btn');
            
            if (blueprintUploadInput) {
                blueprintUploadInput.addEventListener('change', (event) => {
                    if (event.target.files.length > 0) {
                        generateFromBlueprintBtn.disabled = false;
                    } else {
                        generateFromBlueprintBtn.disabled = true;
                    }
                });
            }
        
            if (generateFromBlueprintBtn) {
                generateFromBlueprintBtn.addEventListener('click', handleGenerateFromBlueprint);
            }
            // --- ‚ñ≤‚ñ≤‚ñ≤ [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Blueprint] ‚ñ≤‚ñ≤‚ñ≤ ---
			
			// === ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===
const parallelTestUploadInput = document.getElementById('parallel-test-upload-input');
const generateFromParallelTestBtn = document.getElementById('generate-from-parallel-test-btn');

if (parallelTestUploadInput) {
    parallelTestUploadInput.addEventListener('change', (event) => {
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
        generateFromParallelTestBtn.disabled = event.target.files.length === 0;
    });
}

if (generateFromParallelTestBtn) {
    generateFromParallelTestBtn.addEventListener('click', handleGenerateParallelTest);
}
// --- ‚ñ≤‚ñ≤‚ñ≤ [‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠] ‚ñ≤‚ñ≤‚ñ≤ ---

            // Student flow buttons
            loadQuizBtn.addEventListener('click', handleLoadQuiz);
            startQuizBtn.addEventListener('click', () => {
                const studentNameSelect = document.getElementById('student-name-select');
                currentStudentName = studentNameSelect.value;
                if (!currentStudentName) {
                    showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
                    return;
                }
                studentNameSelectionView.classList.add('hidden');
                quizStartTime = new Date(); // Record start time for speed bonus
                displayQuizForStudent(currentQuizData);
            });
            // NEW: Live Game Listeners
            document.getElementById('join-live-game-btn').addEventListener('click', showJoinGameView);
            document.getElementById('confirm-join-game-btn').addEventListener('click', handleJoinLiveGame);
            document.getElementById('back-to-student-initial-btn').addEventListener('click', () => showView('student'));


            // === START: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô Event Listeners ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===
            
            // Helper function for Scores Table filename
            const getResultsFilename = () => {
                const quizTitle = document.getElementById('results-quiz-title').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                return `results_${quizTitle || 'quiz'}`;
            };
			
			// ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
            const topicSearchInput = document.getElementById('math-topic-search-input');
            if (topicSearchInput) {
                topicSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const checkboxContainer = document.getElementById('math-topics-checkbox-container');
                    
                    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                    const categories = checkboxContainer.querySelectorAll('.mb-3');
                    categories.forEach(category => {
                        let categoryHasVisibleTopic = false;
                        
                        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (label) ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                        const topics = category.querySelectorAll('label');
                        topics.forEach(label => {
                            const topicName = label.textContent.toLowerCase();
                            if (topicName.includes(searchTerm)) {
                                label.style.display = 'flex'; // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                categoryHasVisibleTopic = true;
                            } else {
                                label.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
                            }
                        });

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if (categoryHasVisibleTopic) {
                            category.style.display = 'block'; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ
                        } else {
                            category.style.display = 'none'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏ï‡∏£‡∏á‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                        }
                    });
                });
            }

            // Export buttons for Scores Table (CHANGED)
            document.getElementById('export-image-btn').addEventListener('click', () => exportTableAsImage('results-table-container', getResultsFilename()));
            document.getElementById('export-pdf-btn').addEventListener('click', () => exportTableAsPDF('results-table', getResultsFilename()));
            document.getElementById('export-word-btn').addEventListener('click', () => exportTableAsWord('results-table-container', getResultsFilename()));
            document.getElementById('export-excel-btn').addEventListener('click', () => exportTableAsExcel('results-table', getResultsFilename()));
            
            // Helper function for Leaderboard Table filename
            const getLeaderboardFilename = () => {
                const quizTitle = document.getElementById('results-quiz-title').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                return `leaderboard_${quizTitle || 'quiz'}`;
            };
            
            // Export buttons for Leaderboard Table (NEW)
            document.getElementById('export-leaderboard-image-btn').addEventListener('click', () => exportTableAsImage('quiz-leaderboard-table-container', getLeaderboardFilename()));
            document.getElementById('export-leaderboard-pdf-btn').addEventListener('click', () => exportTableAsPDF('quiz-leaderboard-table', getLeaderboardFilename()));
            document.getElementById('export-leaderboard-word-btn').addEventListener('click', () => exportTableAsWord('quiz-leaderboard-table-container', getLeaderboardFilename()));
            document.getElementById('export-leaderboard-excel-btn').addEventListener('click', () => exportTableAsExcel('quiz-leaderboard-table', getLeaderboardFilename()));
            
            // === END: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô Event Listeners ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏° Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===


            // Event delegation for project quizzes list
            projectQuizzesList.addEventListener('click', async (e) => {
                const starBtn = e.target.closest('.star-quiz-btn');
                const deleteBtn = e.target.closest('.delete-quiz-btn');
                const copyBtn = e.target.closest('.copy-quiz-id-list-btn');
                const presentBtn = e.target.closest('.start-presentation-list-btn');
                const tryQuizBtn = e.target.closest('.admin-try-quiz-list-btn');
                const renameBtn = e.target.closest('.rename-quiz-btn');
                const moveBtn = e.target.closest('.move-quiz-btn');
                const settingsBtn = e.target.closest('.quiz-settings-btn');
                const statusBtn = e.target.closest('.quiz-status-btn');
                const duplicateBtn = e.target.closest('.duplicate-quiz-btn');
                const liveRaceBtn = e.target.closest('.start-live-race-btn'); // NEW
                const editBtn = e.target.closest('.edit-quiz-btn'); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
				const parallelBtn = e.target.closest('.parallel-quiz-btn');
                
                if (editBtn) {
                    const quizId = editBtn.dataset.quizId;
                    handleOpenQuizEditor(quizId);
					} else if (parallelBtn) {
        const quizId = parallelBtn.dataset.quizId;
        const quizData = allQuizzes.find(q => q.id === quizId);
        if (quizData) {
            handleGenerateParallelFromBank(quizData);
        } else {
            showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
        }
                } else if (starBtn) {
                    const quizId = starBtn.dataset.quizId;
                    handleToggleStarQuiz(quizId);
                } else if (liveRaceBtn) {
                    const quizId = liveRaceBtn.dataset.quizId;
                    handleStartLiveRace(quizId);
                } else if (deleteBtn) {
                    const quizId = deleteBtn.dataset.quizId;
                    const quizTopic = deleteBtn.dataset.topic;
                        showConfirmation(
                        `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö "${quizTopic}"? ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`,
                        () => handleDeleteQuiz(quizId)
                    );
                } else if (copyBtn) {
                    const quizId = copyBtn.dataset.quizId;
                    copyTextToClipboard(quizId, "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!");
                } else if (presentBtn) {
                    const quizId = presentBtn.dataset.quizId;
                    const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                    const quizDocSnap = await getDoc(quizDocRef);
                    if (quizDocSnap.exists()) {
                        const quizData = { id: quizDocSnap.id, ...quizDocSnap.data() };
                        startPresentation(quizData);
                    } else {
                        showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                    }
                } else if (tryQuizBtn) {
                    const quizId = tryQuizBtn.dataset.quizId;
                    const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                    const quizDocSnap = await getDoc(quizDocRef);
                    if (quizDocSnap.exists()) {
                        currentQuizData = {id: quizDocSnap.id, ...quizDocSnap.data()}; // Set the global quiz data
                        startAdminTest();
                    } else {
                        showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                    }
                } else if (renameBtn) {
                    const quizId = renameBtn.dataset.quizId;
                    const topic = renameBtn.dataset.topic;
                    handleRenameQuiz(quizId, topic);
                } else if (moveBtn) {
                    const quizId = moveBtn.dataset.quizId;
                    handleMoveQuiz(quizId);
                } else if (settingsBtn) {
                    const quizId = settingsBtn.dataset.quizId;
                    handleQuizSettings(quizId);
                } else if (statusBtn) {
                    const quizId = statusBtn.dataset.quizId;
                    handleQuizStatus(quizId);
                } else if (duplicateBtn) {
                    const quizId = duplicateBtn.dataset.quizId;
                    handleDuplicateQuiz(quizId);
                }
            });
			
			// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
            document.getElementById('quiz-leaderboard-table').querySelector('thead').addEventListener('click', (e) => {
                const header = e.target.closest('.sortable-header');
                if (!header || !header.dataset.sort) return;

                const newSortBy = header.dataset.sort;
                if (quizLeaderboardSortBy === newSortBy) {
                    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á
                    quizLeaderboardSortOrder = quizLeaderboardSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
                    quizLeaderboardSortBy = newSortBy;
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    const textBasedSort = ['studentName'];
                    quizLeaderboardSortOrder = textBasedSort.includes(newSortBy) ? 'asc' : 'desc';
                }
                // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà
                renderQuizLeaderboard(currentSubmissions, currentQuizData, 'quiz-leaderboard-table-body');
            });

            // Presentation Mode Listeners
            document.getElementById('close-presentation-btn').addEventListener('click', closePresentation);
            document.getElementById('prev-question-btn').addEventListener('click', () => {
                if (currentPresentationSlide > 0) {
                    currentPresentationSlide--;
                    renderPresentationSlide(currentPresentationSlide);
                }
            });
            document.getElementById('next-question-btn').addEventListener('click', () => {
                if (currentQuizData.questions && currentPresentationSlide < currentQuizData.questions.length - 1) {
                    currentPresentationSlide++;
                    renderPresentationSlide(currentPresentationSlide);
                }
            });
            // Handle exiting fullscreen with ESC key
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    presentationModal.style.display = 'none';
                }
            });
            
            // Student Deletion Listeners
            document.getElementById('delete-all-students-btn').addEventListener('click', handleDeleteAllStudents);
            studentList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-student-btn');
                if (deleteBtn) {
                    const studentName = deleteBtn.dataset.studentName;
                    handleDeleteStudent(studentName);
                }
            });
            
            // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° ---

            // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
            document.getElementById('generate-from-file-btn').addEventListener('click', handleGenerateFromFileClick);

            // 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Listener ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
            fileUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                const generateBtn = document.getElementById('generate-from-file-btn');
                if (file) {
                    selectedFile = file; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                    generateBtn.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
                } else {
                    selectedFile = null; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                    generateBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
                }
            });

            // Timer Settings Listener
            document.getElementById('timer-mode-select').addEventListener('change', (e) => {
                const durationContainer = document.getElementById('timer-duration-container');
                const durationLabel = document.getElementById('timer-duration-label');
                const durationInput = document.getElementById('timer-duration-input');
                if (e.target.value === 'none') {
                    durationContainer.classList.add('hidden');
                } else {
                    durationContainer.classList.remove('hidden');
                    if (e.target.value === 'whole_quiz') {
                        durationLabel.textContent = '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ):';
                        durationInput.value = '10';
                    } else { // per_question
                        durationLabel.textContent = '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ):';
                        durationInput.value = '30';
                    }
                }
            });
            
            // Quiz Type Selector Listener
            document.getElementById('quiz-type-select').addEventListener('change', (e) => {
                const numChoicesContainer = document.getElementById('num-choices-container');
                const type = e.target.value;
                const numQuestionsLabel = document.querySelector('label[for="num-questions"]');
                const passingScoreInput = document.getElementById('passing-score-input');
                const numQuestionsInput = document.getElementById('num-questions');

                if (type === 'matching') {
                    numQuestionsLabel.textContent = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà:';
                } else {
                    numQuestionsLabel.textContent = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠:';
                }

                if (type === 'multiple_choice' || type === 'fill_in_with_choices' || type === 'mixed') {
                    numChoicesContainer.classList.remove('hidden');
                } else {
                    numChoicesContainer.classList.add('hidden');
                }
                
                // Update max for passing score
                passingScoreInput.max = numQuestionsInput.value;
            });

            document.getElementById('num-questions').addEventListener('input', (e) => {
                document.getElementById('passing-score-input').max = e.target.value;
            });


            // Modal Timer Settings Listener
            document.getElementById('modal-timer-mode-select').addEventListener('change', (e) => {
                const durationContainer = document.getElementById('modal-timer-duration-container');
                const durationLabel = document.getElementById('modal-timer-duration-label');
                const durationInput = document.getElementById('modal-timer-duration-input');
                if (e.target.value === 'none') {
                    durationContainer.classList.add('hidden');
                } else {
                    durationContainer.classList.remove('hidden');
                    if (e.target.value === 'whole_quiz') {
                        durationLabel.textContent = '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ):';
                    } else { // per_question
                        durationLabel.textContent = '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ):';
                    }
                }
            });
			
			// Event Listeners for Quiz Editor Modal
            document.getElementById('cancel-quiz-edits-btn').addEventListener('click', () => {
                document.getElementById('quiz-editor-modal').classList.add('hidden');
            });
            document.getElementById('cancel-quiz-edits-btn-footer').addEventListener('click', () => {
                document.getElementById('quiz-editor-modal').classList.add('hidden');
            });
            document.getElementById('save-quiz-edits-btn').addEventListener('click', () => {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                document.getElementById('quiz-editor-modal').classList.add('hidden');

                // ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                showConfirmation(
                    '‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¢‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ö‡∏™‡∏ô‡πÑ‡∏î‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                    handleSaveChanges
                )
            });
			
			document.getElementById('auto-fix-latex-btn').addEventListener('click', handleAutoFixLatex);
			
			// ‚ñº‚ñº‚ñº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚ñº‚ñº‚ñº
            const editorContainer = document.getElementById('quiz-editor-questions-container');
            if (editorContainer) {
                editorContainer.addEventListener('click', (e) => {
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà" ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    const regenerateBtn = e.target.closest('.regenerate-question-editor-btn');
                    if (regenerateBtn) {
                        const questionItem = regenerateBtn.closest('.question-editor-item');
                        const index = parseInt(questionItem.dataset.qIndex, 10);
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà
                        handleRegenerateQuestionInEditor(index);
                    }
                });
            }
 // 1. Event Listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    document.getElementById('open-quiz-bank-btn')
      .addEventListener('click', openQuizBankModal);

    // 2. Event Listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î (X) ‡∏Ç‡∏≠‡∏á Modal ‡πÉ‡∏´‡∏°‡πà
    document.getElementById('cancel-quiz-bank-btn')
      .addEventListener('click', () => {
        document.getElementById('quiz-bank-modal').classList.add('hidden');
      });

    // 3. Event Listener ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á Modal ‡πÉ‡∏´‡∏°‡πà
    document.getElementById('bank-quiz-search-input')
      .addEventListener('input', (e) => renderQuizBankList(e.target.value));			
        }
		
		/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF
 * @param {File} file - ‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
 * @returns {Promise<string>} - Promise ‡∏ó‡∏µ‡πà‡∏à‡∏∞ resolve ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå
 */
async function extractTextFromPdf(file) {
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ worker source ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pdf.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    const numPages = pdf.numPages;
    let fullText = '';

    for (let i = 1; i <= numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n'; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
    }

    return fullText;
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Test Blueprint PDF
 */
async function handleGenerateFromBlueprint() {
    const blueprintInput = document.getElementById('blueprint-upload-input');
    const file = blueprintInput.files[0];
    if (!file) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Test Blueprint ‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    const generateBtn = document.getElementById('generate-from-blueprint-btn');

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    generateBtn.disabled = true;
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Test Blueprint...';

    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF
        const blueprintText = await extractTextFromPdf(file);
        if (!blueprintText.trim()) {
            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢");
        }
        loaderText.textContent = 'Blueprint ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';

        // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI
        const prompt = `
            ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (Test Blueprint)
            ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Test Blueprint:
            ---
            ${blueprintText}
            ---
            ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:
            1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏ô‡∏±‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å, ‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç), ‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
            2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå 1 ‡∏ä‡∏∏‡∏î ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô Blueprint ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î **‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£**
            3. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (multiple_choice, short_answer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô Blueprint
            4. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö "‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏Å‡∏ô‡∏Å‡∏•‡∏≤‡∏á" ‡πÅ‡∏•‡∏∞ "‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î" ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô
            5. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

            ${simpleMathPrompt}
        `;

        // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Schema (‡πÉ‡∏ä‡πâ 'mixed' schema ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
        const mixedQuestionSchema = { type: "OBJECT", properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "questionType", "explanation"] };
        const finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: mixedQuestionSchema } }, required: ["topic", "questions"] };

        // 4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        // handleApiCall ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ú‡πà‡∏≤‡∏ô displayGeneratedQuiz ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
        await handleApiCall(prompt, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Blueprint...', finalSchema);

    } catch (error) {
        console.error("Error generating from blueprint:", error);
        showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        genQuizContainer.innerHTML = `<p class="text-red-500 text-center">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Blueprint ‡πÑ‡∏î‡πâ</p>`;
    } finally {
        loader.classList.add('hidden');
        generateBtn.disabled = false;
    }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
 * @param {object} originalQuizData ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á)
 * @param {object} originalQuizData ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)
 * @param {object} originalQuizData ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
async function handleGenerateParallelFromBank(originalQuizData) {
    // ‚ñº‚ñº‚ñº ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚ñº‚ñº‚ñº
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    const quizGenerationArea = document.getElementById('quiz-generation-area');

    // 1. ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏ô
    showView('project-detail');
    switchProjectTab('manage');
    quizGenerationArea.classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö "${originalQuizData.topic}"...`;
    // ‚ñ≤‚ñ≤‚ñ≤ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚ñ≤‚ñ≤‚ñ≤

    try {
        // 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const originalTestText = originalQuizData.questions.map((q, index) => {
            let questionString = `${index + 1}. ${q.questionText || q.stem}\n`;
            if (q.options) {
                questionString += q.options.map((opt, i) => `   - ${i === q.correctAnswerIndex ? '[*]' : ''} ${opt}`).join('\n');
            } else if (q.idealAnswer) {
                questionString += `   - ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: ${q.idealAnswer}`;
            } else if (q.correctResponse) {
                questionString += `   - ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: ${q.correctResponse}`;
            }
            return questionString;
        }).join('\n\n');

        loaderText.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô...';

        // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const prompt = `
            ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${originalQuizData.topic}":
            ---
            ${originalTestText}
            ---
            ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:
            1.  ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤, ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (${originalQuizData.quizType}), ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å
            2.  ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô" (Parallel Test) ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ 1 ‡∏ä‡∏∏‡∏î ‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
            3.  **‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç, ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î** ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏™‡∏°‡∏°‡∏π‡∏•" ‡∏Å‡∏±‡∏ô
            4.  ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
            5.  ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

            ${simpleMathPrompt}
        `;

        // 4. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Schema (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const mixedQuestionSchema = { type: "OBJECT", properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer", "true_false", "matching_item"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, correctAnswer: { type: "BOOLEAN" }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, allResponses: { type: "ARRAY", items: { type: "STRING" } }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionType", "explanation"] };
        const finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: mixedQuestionSchema } }, required: ["topic", "questions"] };

        // 5. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        await handleApiCall(prompt, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô...', finalSchema);

    } catch (error) {
        console.error("Error generating parallel test from bank:", error);
        showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        genQuizContainer.innerHTML = `<p class="text-red-500 text-center">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>`;
    } finally {
        // 6. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏ã‡πà‡∏≠‡∏ô loader (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        loader.classList.add('hidden');
    }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF
 */
async function handleGenerateParallelTest() {
    const parallelTestInput = document.getElementById('parallel-test-upload-input');
    const file = parallelTestInput.files[0];
    if (!file) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    const generateBtn = document.getElementById('generate-from-parallel-test-btn');

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    generateBtn.disabled = true;
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö...';

    try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å PDF (‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        const originalTestText = await extractTextFromPdf(file);
        if (!originalTestText.trim()) {
            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢");
        }
        loaderText.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô...';

        // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ AI ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà "‡∏™‡∏°‡∏°‡∏π‡∏•" ‡∏Å‡∏±‡∏ô
        const prompt = `
            ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö 1 ‡∏ä‡∏∏‡∏î:
            ---
            ${originalTestText}
            ---
            ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:
            1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á, ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠, ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏ô‡∏±‡∏¢, ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥), ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏á‡πà‡∏≤‡∏¢
            2. ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô" (Parallel Test) ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ 1 ‡∏ä‡∏∏‡∏î ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö **‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î**
            3. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (multiple_choice, short_answer) ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
            4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

            ${simpleMathPrompt}
        `;

        // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Schema (‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ 'mixedQuestionSchema' ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
        const mixedQuestionSchema = { type: "OBJECT", properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "questionType", "explanation"] };
        const finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: mixedQuestionSchema } }, required: ["topic", "questions"] };

        // 4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ API ‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (handleApiCall ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á)
        await handleApiCall(prompt, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô...', finalSchema);

    } catch (error) {
        console.error("Error generating from parallel test file:", error);
        showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        genQuizContainer.innerHTML = `<p class="text-red-500 text-center">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>`;
    } finally {
        loader.classList.add('hidden');
        generateBtn.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    }
}
		
		async function handleRegenerateQuestionInEditor(index) {
    if (currentEditingQuizData === null) return;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    const questionItem = document.querySelector(`.question-editor-item[data-q-index="${index}"]`);
    if (questionItem) {
        questionItem.innerHTML = '<div class="flex justify-center items-center h-32"><div class="loader"></div></div>';
    }

    const originalQuestion = currentEditingQuizData.questions[index];
    const quizTopic = currentEditingQuizData.topic;
    const questionType = originalQuestion.questionType;

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Prompt ‡πÅ‡∏•‡∏∞ Schema ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI
    const mcqSchema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" } }, required: ["questionText", "options", "correctAnswerIndex", "explanation"] };
    const shortAnswerSchema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" } }, required: ["questionText", "idealAnswer", "explanation"] };
    
    let schema;
    let typeDescription = "";
    if (questionType === 'multiple_choice') {
        schema = mcqSchema;
        typeDescription = "‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
    } else {
        schema = shortAnswerSchema;
        typeDescription = "‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö";
    }

    const prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà 1 ‡∏Ç‡πâ‡∏≠ ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${quizTopic}" ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "${typeDescription}" ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏µ‡πâ: "${originalQuestion.questionText || originalQuestion.stem}". ${simpleMathPrompt}`;

    try {
        const newQuestionData = await callAnalysisApi(prompt, schema);
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô State
        currentEditingQuizData.questions[index] = { ...originalQuestion, ...newQuestionData };

        // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
        renderQuizEditor(currentEditingQuizData);
    } catch (error) {
        console.error("Error regenerating question in editor:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà");
        
        // ‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        renderQuizEditor(currentEditingQuizData);
    }
}
        
        function handleModeSwitch() {
            const switcherBtn = document.getElementById('mode-switcher-btn');
            if (currentMode === 'student') {
                // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á login ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                
                // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô admin
                currentMode = 'admin';

                // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
                switcherBtn.innerHTML = `<i class="fas fa-user-graduate fa-lg"></i>`;
                switcherBtn.title = "‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                
                // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ dashboard ‡∏Ç‡∏≠‡∏á admin
                showView('admin-dashboard');

            } else {
                // If in admin mode, switch back to student
                currentMode = 'student';
                switcherBtn.innerHTML = `<i class="fas fa-user-shield fa-lg"></i>`;
                switcherBtn.title = "‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°";
                showView('student');
            }
        }

        function handleAdminLogin() {
            const passInput = document.getElementById('admin-password-input');
            const errorMsg = document.getElementById('password-error-msg');
            // This is a simple, non-secure password. In a real app, use a proper auth system.
            if (passInput.value === '2741') {
                adminPasswordModal.classList.add('hidden');
                passInput.value = '';
                errorMsg.classList.add('hidden');
                
                // Update mode and button
                currentMode = 'admin';
                const switcherBtn = document.getElementById('mode-switcher-btn');
                switcherBtn.innerHTML = `<i class="fas fa-user-graduate fa-lg"></i>`;
                switcherBtn.title = "‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                
                showView('admin-dashboard');
            } else {
                errorMsg.classList.remove('hidden');
                passInput.value = '';
            }
        }

        function switchProjectTab(tabName) {
            ['manage', 'results', 'leaderboard'].forEach(name => {
                document.getElementById(`${name}-tab`).classList.remove('active');
                document.getElementById(`${name}-tab-content`).classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
        }

        // NEW: Function to switch tabs in the Quiz Detail view
        function switchQuizDetailTab(tabName) {
            const tabs = {
                'analytics': { btn: 'analytics-tab-btn', content: 'analytics-tab-content' },
                'scores': { btn: 'scores-tab-btn', content: 'scores-tab-content' },
                'leaderboard-quiz': { btn: 'leaderboard-quiz-tab-btn', content: 'leaderboard-quiz-tab-content' }
            };

            for (const key in tabs) {
                document.getElementById(tabs[key].btn).classList.remove('active');
                document.getElementById(tabs[key].content).classList.add('hidden');
            }

            document.getElementById(tabs[tabName].btn).classList.add('active');
            document.getElementById(tabs[tabName].content).classList.remove('hidden');
        }

        // --- Messaging & Confirmation ---
        function showMessage(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirmation-modal').querySelector('h3').textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥';
            confirmAction = onConfirm;
            confirmationModal.classList.remove('hidden');
        }
        
        // --- Project Management (Shared/Public) ---
        function listenForProjects() {
            const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
            unsubscribeProjectsListener = onSnapshot(projectsRef, (snapshot) => {
                allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjects();
            }, (error) => {
                console.error("Error listening for projects:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ");
            });
        }
        
 async function renderProjects() {
            const searchTerm = document.getElementById('project-search-input').value.toLowerCase();
            const sortBy = document.getElementById('project-sort-select').value;

            // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏à‡∏£‡∏¥‡∏á
            let filteredProjects = allProjects.filter(p => p.projectName.toLowerCase().includes(searchTerm));
            filteredProjects.sort((a, b) => {
                switch (sortBy) {
                    case 'name_asc': return a.projectName.localeCompare(b.projectName, 'th');
                    case 'name_desc': return b.projectName.localeCompare(a.projectName, 'th');
                    case 'date_asc': return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'date_desc': default: return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });

            // 2. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏à‡∏£‡∏¥‡∏á
            const quizCounts = {};
            await Promise.all(
                filteredProjects.map(async (project) => {
                    const qref = query(collection(db, `artifacts/${appId}/public/data/quizzes`), where('projectId', '==', project.id));
                    const qsnap = await getDocs(qref);
                    quizCounts[project.id] = qsnap.size;
                })
            );

            let html = '';

            // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß" ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
            if (starredQuizzes.length > 0) {
                html += `
                <div class="project-card-container bg-indigo-50 border-indigo-200 p-4 rounded-lg shadow hover:shadow-lg transition-all duration-300 flex flex-col justify-between">
                    <div class="project-card-content cursor-pointer" data-id="starred-project">
                    <h4 class="font-bold text-lg text-indigo-800 pointer-events-none">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß <i class="fas fa-star text-yellow-400"></i></h4>
                    <p class="text-sm text-gray-500 pointer-events-none">‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</p>
                    <p class="text-sm text-gray-700 mt-1 pointer-events-none"><i class="fas fa-file mr-1"></i> ${starredQuizzes.length} ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                    </div>
                    <div class="text-right mt-2 h-6">
                    </div>
                </div>
                `;
            }

            // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏à‡∏£‡∏¥‡∏á
            filteredProjects.forEach(project => {
                const count = quizCounts[project.id] ?? 0;
                html += `
                <div class="project-card-container bg-white p-4 rounded-lg shadow hover:shadow-lg transition-all duration-300 border border-gray-200 flex flex-col justify-between">
                    <div class="project-card-content cursor-pointer" data-id="${project.id}">
                    <h4 class="font-bold text-lg text-indigo-800 pointer-events-none">${project.projectName}</h4>
                    <p class="text-sm text-gray-500 pointer-events-none">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(project.createdAt).toLocaleDateString('th-TH')}</p>
                    <p class="text-sm text-gray-700 mt-1 pointer-events-none"><i class="fas fa-file mr-1"></i> ${count} ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
                    </div>
                    <div class="text-right mt-2">
                    <button data-id="${project.id}" data-name="${project.projectName}" class="delete-project-btn text-red-500 hover:text-red-700 text-sm p-1">
                        <i class="fas fa-trash-alt"></i> ‡∏•‡∏ö
                    </button>
                    </div>
                </div>
                `;
            });

            // 5. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            projectList.innerHTML = html;
            noProjectsMsg.classList.toggle('hidden', html.length > 0);
        }

        document.getElementById('confirm-create-project-btn').addEventListener('click', async () => {
            const projectNameInput = document.getElementById('project-name-input');
            const projectName = projectNameInput.value.trim();
            if (!projectName) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ");
                return;
            }
            try {
                const newProjectRef = doc(collection(db, `artifacts/${appId}/public/data/projects`));
                await setDoc(newProjectRef, {
                    projectName: projectName,
                    students: [],
                    settings: {
                        resultsDisplay: 'show_results_and_answers',
                        shuffleSetting: 'none',
                        defaultNumQuestions: 5,
                        defaultNumChoices: 4,
                        defaultPassingScore: 3, // Default passing score
                        timerMode: 'none',
                        timerDuration: 10,
                    },
                    createdBy: userId, // Keep track of who created it
                    createdAt: new Date().toISOString()
                });
                projectNameInput.value = '';
                createProjectModal.classList.add('hidden');
                showMessage("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (error) {
                console.error("Error creating project:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÑ‡∏î‡πâ");
            }
        });

        projectList.addEventListener('click', async (e) => {
            const cardContent = e.target.closest('.project-card-content');
            const deleteBtn = e.target.closest('.delete-project-btn');

            if (cardContent) {
                const projectId = cardContent.dataset.id;
                if (projectId === 'starred-project') {
                    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
                    showStarredProjectView();
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                    currentProjectId = projectId;
                    await loadProjectDetails(currentProjectId);
                    showView('project-detail');
                }
            } else if (deleteBtn) {
                const projectId = deleteBtn.dataset.id;
                const projectName = deleteBtn.dataset.name;
                showConfirmation(
                    `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ "${projectName}"? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`,
                    () => handleDeleteProject(projectId)
                );
            }
        });

function showStarredProjectView() {
            currentProjectId = 'starred'; // ‡∏ï‡∏±‡πâ‡∏á ID ‡∏û‡∏¥‡πÄ‡∏®‡∏©
            currentProjectData = null; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏à‡∏£‡∏¥‡∏á‡πÜ

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á view
            projectTitle.textContent = '‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß';
            projectIdDisplay.textContent = 'pinned-items';
            showView('project-detail');

            // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            manageTab.classList.add('hidden');
            leaderboardTab.classList.add('hidden');
            
            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå" (‡∏ã‡∏∂‡πà‡∏á‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
            switchProjectTab('results');
			renderQuizzes(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        }

        async function loadProjectDetails(projectId) {
            const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
            const docSnap = await getDoc(projectRef);
            if (docSnap.exists()) {
			                manageTab.classList.remove('hidden');
                leaderboardTab.classList.remove('hidden');
                currentProjectData = docSnap.data();
                projectTitle.textContent = currentProjectData.projectName;
                projectIdDisplay.textContent = projectId;
                
                // Load settings, providing defaults if they don't exist
                const settings = currentProjectData.settings || {};
                document.getElementById('num-questions').value = settings.defaultNumQuestions || 5;
                document.getElementById('num-choices').value = settings.defaultNumChoices || 4;
                document.getElementById('passing-score-input').value = settings.defaultPassingScore || Math.floor((settings.defaultNumQuestions || 5) / 2);
                document.getElementById('passing-score-input').max = settings.defaultNumQuestions || 5;
                document.getElementById('results-display-select').value = settings.resultsDisplay || 'show_results_and_answers';
                document.getElementById('shuffle-setting-select').value = settings.shuffleSetting || 'none';

                // Load timer settings
                const timerMode = settings.timerMode || 'none';
                const timerDuration = settings.timerDuration || 10;
                const timerModeSelect = document.getElementById('timer-mode-select');
                const durationContainer = document.getElementById('timer-duration-container');
                const durationInput = document.getElementById('timer-duration-input');
                
                timerModeSelect.value = timerMode;
                durationInput.value = timerDuration;

                if (timerMode === 'none') {
                    durationContainer.classList.add('hidden');
                } else {
                    durationContainer.classList.remove('hidden');
                }
                // Trigger change to set label correctly
                timerModeSelect.dispatchEvent(new Event('change'));


                if (unsubscribeStudentsListener) unsubscribeStudentsListener();
                if (unsubscribeQuizzesListener) unsubscribeQuizzesListener();
                if (unsubscribeStudentProfilesListener) unsubscribeStudentProfilesListener();
                listenForStudents(projectId);
                listenForProjectQuizzes(projectId);
                listenForStudentProfiles(projectId); // For Leaderboard
            } else {
                showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ");
                showView('admin-dashboard');
            }
        }

        async function handleDeleteProject(projectId) {
            try {
                const batch = writeBatch(db);
                // 1. Find all quizzes associated with the project
                const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
                const q = query(quizzesRef, where("projectId", "==", projectId));
                const quizSnapshot = await getDocs(q);

                // 2. For each quiz, find and delete its submissions, then the quiz itself
                for (const quizDoc of quizSnapshot.docs) {
                    // Delete submissions
                    const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${quizDoc.id}/submissions`);
                    const submissionsSnapshot = await getDocs(submissionsRef);
                    submissionsSnapshot.forEach(subDoc => {
                        batch.delete(subDoc.ref);
                    });
                    // Delete quiz
                    batch.delete(quizDoc.ref);
                }

                // 3. Delete student profiles subcollection
                const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${projectId}/studentProfiles`);
                const profilesSnapshot = await getDocs(profilesRef);
                profilesSnapshot.forEach(profDoc => {
                    batch.delete(profDoc.ref);
                });

                // 4. Delete the project document
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
                batch.delete(projectRef);
                
                await batch.commit();

                showMessage("‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
                showView('admin-dashboard'); // Go back to dashboard after deletion
            } catch (error) {
                console.error("Error deleting project:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ");
            }
        }
        
        // --- Settings & Student Management in Project ---
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            if (!currentProjectId) return;
            const settings = {
                defaultNumQuestions: parseInt(document.getElementById('num-questions').value),
                defaultNumChoices: parseInt(document.getElementById('num-choices').value),
                defaultPassingScore: parseInt(document.getElementById('passing-score-input').value),
                resultsDisplay: document.getElementById('results-display-select').value,
                shuffleSetting: document.getElementById('shuffle-setting-select').value,
                timerMode: document.getElementById('timer-mode-select').value,
                timerDuration: parseInt(document.getElementById('timer-duration-input').value)
            };
            try {
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                await updateDoc(projectRef, { settings });
                showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
            } catch (error) {
                console.error("Error saving settings:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ");
            }
        });

        function listenForStudents(projectId) {
            const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
            unsubscribeStudentsListener = onSnapshot(projectRef, (doc) => {
                if (doc.exists()) {
                    const projectData = doc.data();
                    currentProjectData = projectData; 
                    renderStudentList(projectData.students || []); 
                }
            });
        }

        function renderStudentList(students) {
            const deleteAllBtn = document.getElementById('delete-all-students-btn');
            if (students.length === 0) {
                studentList.innerHTML = `<p class="text-gray-400 text-center p-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ</p>`;
                deleteAllBtn.classList.add('hidden');
            } else {
                studentList.innerHTML = students.map(name => `
                    <div class="flex justify-between items-center p-1 hover:bg-gray-100 rounded">
                        <span>${name}</span>
                        <button data-student-name="${name}" class="delete-student-btn text-red-500 hover:text-red-700 p-1 text-xs">
                            <i class="fas fa-times-circle pointer-events-none"></i>
                        </button>
                    </div>
                `).join('');
                deleteAllBtn.classList.remove('hidden');
            }
        }

        document.getElementById('add-student-btn').addEventListener('click', async () => {
            if (!currentProjectId) return;
            const studentNameInput = document.getElementById('student-name-input');
            const studentNamesText = studentNameInput.value.trim();
            if (!studentNamesText) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
                return;
            }
            
            const newStudents = studentNamesText.split('\n').map(name => name.trim()).filter(name => name);
            if (newStudents.length === 0) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                const docSnap = await getDoc(projectRef);
                if (docSnap.exists()) {
                    const currentStudents = docSnap.data().students || [];
                    const updatedStudents = [...new Set([...currentStudents, ...newStudents])];
                    await updateDoc(projectRef, { students: updatedStudents });
                    studentNameInput.value = '';
                }
            } catch (error) {
                console.error("Error adding students:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ");
            }
        });

        function handleDeleteStudent(studentName) {
            showConfirmation(
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ "${studentName}"? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢`,
                async () => {
                    if (!currentProjectId || !currentProjectData) return;
                    const updatedStudents = currentProjectData.students.filter(s => s !== studentName);
                    try {
                        const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                        const studentProfileRef = doc(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/studentProfiles`, studentName);
                        
                        const batch = writeBatch(db);
                        batch.update(projectRef, { students: updatedStudents });
                        batch.delete(studentProfileRef); // Also delete their profile for the leaderboard
                        await batch.commit();

                    } catch (error) {
                        console.error("Error deleting student:", error);
                        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
                    }
                }
            );
        }

        function handleDeleteAllStudents() {
            showConfirmation(
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
                async () => {
                    if (!currentProjectId) return;
                    try {
                        const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                        const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/studentProfiles`);
                        const profilesSnapshot = await getDocs(profilesRef);

                        const batch = writeBatch(db);
                        batch.update(projectRef, { students: [] });
                        profilesSnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();

                    } catch (error) {
                        console.error("Error deleting all students:", error);
                        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
                    }
                }
            );
        }

        // --- File Handling ---
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö" ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
async function handleGenerateFromFileClick() {
    if (!selectedFile) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    const generateBtn = document.getElementById('generate-from-file-btn');
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    generateBtn.disabled = true;
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå...';
    
    const reader = new FileReader();
    reader.readAsDataURL(selectedFile);
    reader.onload = async () => {
        try {
            const base64String = reader.result.split(',')[1];
            const mimeType = selectedFile.type;
            
            await generateQuizFromFile(mimeType, base64String);

        } catch (error) {
            console.error("Error processing file for AI:", error);
            showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå: ${error.message}`);
            loader.classList.add('hidden');
        } finally {
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        }
    };
    reader.onerror = (error) => {
        console.error("FileReader error:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå");
        loader.classList.add('hidden');
        generateBtn.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏≤‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    };
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
 * ‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô LaTeX ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ $ ‡∏Ñ‡∏£‡∏≠‡∏ö
 * @param {string} text - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
 * @returns {string} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
 */
function autoFormatMath(text) {
    if (typeof text !== 'string' || !text) {
        return text;
    }

    // Regex ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç \times ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç", "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç^‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç", ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á LaTeX 
    // ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ $ ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    const mathPattern = /((?<!\$)\b(\d+(\.\d+)?\s*(\\times|\\div)\s*\d+(\.\d+)?|(\d+\s*\^\s*\{?\d+\}?)|(\\frac|\\sqrt|\\pm|\\geq|\\leq|\\neq))\b(?!\$))/g;

    let formattedText = text.replace(mathPattern, (match) => {
        // ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ $
        return `$${match.trim()}$`;
    });

    return formattedText;
}

        // --- Math Sanitization ---
        function sanitizeQuizData(quizData) {
            if (!quizData || !quizData.questions) return quizData;

            const replacements = {
                'imes': '\\times',
                'div': '\\div',
            };

            const sanitizeText = (text) => {
    if (typeof text !== 'string') return text;
    let sanitizedText = text;
    for (const [wrong, correct] of Object.entries(replacements)) {
        // Use word boundaries to avoid replacing parts of words, e.g., 'div' in 'division'.
        const regex = new RegExp(`\\b${wrong}\\b`, 'g');
        sanitizedText = sanitizedText.replace(regex, correct);
    }

    // ================== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ==================
    sanitizedText = sanitizedText.replace(/\\\//g, '\\div'); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
    // =================================================================

    // Normalize inline-tag math tokens and symbols before MathJax
    sanitizedText = sanitizedText
        .replace(/<(i|em)>\s*div\s*<\/\1>/gi, '\\div')
        .replace(/<(i|em)>\s*times\s*<\/\1>/gi, '\\times')
        .replace(/√∑/g, '\\div')
        .replace(/√ó/g, '\\times');
    
    sanitizedText = sanitizedText.replace(/(\d)(\\frac)/g, '$1 \\frac');

    sanitizedText = autoFormatMath(sanitizedText);

    return sanitizedText;
};

            if (quizData.topic) {
                quizData.topic = sanitizeText(quizData.topic);
            }
            quizData.questions.forEach(q => {
                q.questionText = sanitizeText(q.questionText);
                if (q.options) {
                    q.options = q.options.map(sanitizeText);
                }
                if (q.explanation) {
                    q.explanation = sanitizeText(q.explanation);
                }
                // NEW: Sanitize matching question types
                if (q.stem) {
                    q.stem = sanitizeText(q.stem);
                }
                if (q.correctResponse) {
                    q.correctResponse = sanitizeText(q.correctResponse);
                }
                if (q.allResponses) {
                    q.allResponses = q.allResponses.map(sanitizeText);
                }
            });

            return quizData;
        }

        // --- Quiz Generation (Admin) ---
        const simpleMathPrompt = "‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏ô‡∏¥‡∏û‡∏à‡∏ô‡πå‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö LaTeX ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏´‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå ($) ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß";

async function handleGenerateFromLink() {
    const urlInput = document.getElementById('link-url-input');
    const topicInput = document.getElementById('link-topic-input');
    const url = urlInput.value.trim();
    const topic = topicInput.value.trim();

    if (!url) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    const generateBtn = document.getElementById('generate-from-link-btn');

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå...';
    generateBtn.disabled = true;

    try {
        // ‡πÉ‡∏ä‡πâ CORS Proxy ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        const response = await fetch(proxyUrl);
        if (!response.ok) {
            throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏î‡πâ (Status: ${response.status})`);
        }
        const htmlContent = await response.text();
        
        // ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏ß‡∏ô‡πÜ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å HTML
        const textContent = extractTextFromHtml(htmlContent);

        if (!textContent || textContent.length < 100) {
             throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤");
        }

        // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        await generateQuiz(topic, textContent);

    } catch (error) {
        console.error("Error generating from link:", error);
        showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        genQuizContainer.innerHTML = `<p class="text-red-500 text-center">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ</p>`;
    } finally {
        loader.classList.add('hidden');
        generateBtn.disabled = false;
    }
}

function extractTextFromHtml(htmlString) {
    const doc = new DOMParser().parseFromString(htmlString, 'text/html');
    
    // ‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô script, style, nav, footer
    doc.querySelectorAll('script, style, nav, footer, header, aside').forEach(el => el.remove());
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å body
    return doc.body.textContent || "";
}

document.getElementById('generate-from-topic-btn').addEventListener('click', () => {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    const topic = document.getElementById('topic-input').value.trim();

    // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô generateQuiz ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    // ‡∏´‡∏≤‡∏Å 'topic' ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ('') ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô generateQuiz ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    // ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
    generateQuiz(topic, null);
});

        async function generateQuiz(topic, textContent, singleQuestionIndex = null) {
    const includeImages = document.getElementById('include-images-checkbox').checked;
    const quizType = document.getElementById('quiz-type-select').value;
    const numQuestions = document.getElementById('num-questions').value;
    const numChoices = document.getElementById('num-choices').value;

    const isNormalTopic = document.getElementById('force-math-checkbox').checked;
    const subjectPrefix = isNormalTopic ? "" : "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå";

    const difficultySelect = document.getElementById('difficulty-level-select');
    const difficultyValue = difficultySelect.value;
    let difficultyInstruction = "";
    if (difficultyValue !== "auto") {
        difficultyInstruction = `‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô "${difficultyValue}"`;
    }
	
	const complexitySelect = document.getElementById('question-complexity-select');
const complexityValue = complexitySelect.value;
let complexityInstruction = "";
if (complexityValue !== "mixed") {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á AI
    complexityInstruction = `‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö "${complexityValue}" ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å Bloom's Taxonomy`;
}

    // === ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡πá‡∏≠‡∏Å‡∏ã‡πå" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ===
    const checkedTopics = document.querySelectorAll('#math-topics-checkbox-container input:checked');
    const selectedTopicNames = Array.from(checkedTopics).map(cb => cb.value);
    
    let topicRefinementInstruction = "";
    if (selectedTopicNames.length > 0) {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ AI ‡∏ú‡∏™‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏î‡πâ
        topicRefinementInstruction = `‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ: ${selectedTopicNames.join(', ')}. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°`;
    }
    // ===========================================================

    let prompt = "";
    let loadingMessage = "";
    let schema;

    let topicInstruction = `‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${topic}"`;
    if (!topic && textContent) {
        topicInstruction = "‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥";
    } else if (!topic && !textContent) {
        topicInstruction = "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'";
    }
    
    // (‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Schemas ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    const mcqSchema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "options", "correctAnswerIndex", "explanation"] };
    const shortAnswerSchema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "idealAnswer", "explanation"] };
    const mixedQuestionSchema = { type: "OBJECT", properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "questionType", "explanation"] };
    const trueFalseSchema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, correctAnswer: { type: "BOOLEAN" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "correctAnswer", "explanation"] };
    const matchingItemSchema = { type: "OBJECT", properties: { questionType: { type: "STRING", "enum": ["matching_item"] }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, allResponses: { type: "ARRAY", items: { type: "STRING" } }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionType", "stem", "correctResponse", "allResponses", "explanation"] };

    let finalSchema;

    if (singleQuestionIndex !== null) {
        // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö context ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å topicRefinementInstruction)
        const originalQuestionType = currentQuizData.questions[singleQuestionIndex].questionType;
        const imageInstruction = includeImages ? `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô property ‡∏ä‡∏∑‡πà‡∏≠ "imageCode".` : '';
        
        prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà 1 ‡∏Ç‡πâ‡∏≠ ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô. ${imageInstruction} ${simpleMathPrompt}`;
        if(originalQuestionType === 'multiple_choice') schema = mcqSchema;
        else if(originalQuestionType === 'matching_item') schema = { type: "OBJECT", properties: { questionType: { type: "STRING", "enum": ["matching_item"] }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionType", "stem", "correctResponse", "explanation"] };
        else schema = shortAnswerSchema;

        finalSchema = schema;

    } else {
        const imageInstruction = includeImages ? `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡∏Å‡∏£‡∏≤‡∏ü) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô property ‡∏ä‡∏∑‡πà‡∏≠ "imageCode". ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà property ‡∏ô‡∏µ‡πâ.` : '';
        
        // === ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Prompt ‡∏ó‡∏∏‡∏Å case ‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° ${topicRefinementInstruction} ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ===
        switch (quizType) {
            case 'multiple_choice':
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ${complexityInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏µ ${numChoices} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å, ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ. ${imageInstruction} ${simpleMathPrompt}`;
                schema = mcqSchema;
                break;
            case 'fill_in_with_choices':
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ${complexityInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (questionText containing '.....'), ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${numChoices} ‡∏ï‡∏±‡∏ß (options), ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (correctAnswerIndex), ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (explanation). ${imageInstruction} ${simpleMathPrompt}`;
                schema = mcqSchema;
                break;
            case 'fill_in_no_choices':
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ${complexityInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (questionText containing '.....'), ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (idealAnswer), ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (explanation). ${imageInstruction} ${simpleMathPrompt}`;
                schema = shortAnswerSchema;
                break;
            case 'mixed':
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ${complexityInstruction}, ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢ ‡πÉ‡∏´‡πâ‡∏°‡∏µ ${numChoices} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å. ${imageInstruction} ${simpleMathPrompt}.`;
                schema = mixedQuestionSchema;
                break;
            case 'true_false':
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πà/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ${complexityInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°, ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (true/false), ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢. ${imageInstruction} ${simpleMathPrompt}`;
                schema = trueFalseSchema;
                break;
            case 'matching':
                prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà${subjectPrefix} ${numQuestions} ‡∏Ñ‡∏π‡πà ${topicInstruction} ${topicRefinementInstruction} ${difficultyInstruction} ${complexityInstruction}. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô. ${imageInstruction} ${simpleMathPrompt}`;
                schema = matchingItemSchema;
                break;
        }
        finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: schema } }, required: ["topic", "questions"] };
    }

    if (textContent) {
        prompt = `‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ: "${textContent}", ${prompt}`;
        loadingMessage = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
    } else {
        loadingMessage = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠...';
    }
    
    return handleApiCall(prompt, loadingMessage, finalSchema, singleQuestionIndex);
}

        async function generateQuizFromFile(mimeType, base64Data) {
    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å input field
    const topic = document.getElementById('file-topic-input').value.trim();

    const quizType = document.getElementById('quiz-type-select').value;
    const numQuestions = document.getElementById('num-questions').value;
    const numChoices = document.getElementById('num-choices').value;
    const includeImages = document.getElementById('include-images-checkbox').checked;

    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤] ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Checkbox ---
    // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞)
const isNormalTopic = document.getElementById('force-math-checkbox').checked;
const subjectPrefix = isNormalTopic ? "" : "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå";
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ---

    let prompt = "";
    let schema;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á prompt ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å
    let topicInstruction = `‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${topic}"`;
    if (!topic) { // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
        topicInstruction = "‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥";
    }

    const imageInstruction = includeImages ? `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡∏Å‡∏£‡∏≤‡∏ü) ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô property ‡∏ä‡∏∑‡πà‡∏≠ "imageCode". ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà property ‡∏ô‡∏µ‡πâ.` : '';

    switch (quizType) {
        case 'multiple_choice':
            // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ---
            prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏µ ${numChoices} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å, ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ. ${imageInstruction} ${simpleMathPrompt}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "options", "correctAnswerIndex", "explanation"] };
            break;
        case 'fill_in_with_choices':
             // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ---
            prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (questionText containing '.....'), ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${numChoices} ‡∏ï‡∏±‡∏ß (options), ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (correctAnswerIndex), ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (explanation). ${imageInstruction} ${simpleMathPrompt}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "options", "correctAnswerIndex", "explanation"] };
            break;
        case 'fill_in_no_choices':
             // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ---
            prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (questionText containing '.....'), ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (idealAnswer), ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (explanation). ${imageInstruction} ${simpleMathPrompt}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "idealAnswer", "explanation"] };
            break;
        case 'mixed':
             // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ---
            prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction}, ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢ (questionType: 'multiple_choice') ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡πÄ‡∏≠‡∏á (questionType: 'short_answer') ‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢ ‡πÉ‡∏´‡πâ‡∏°‡∏µ ${numChoices} ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å. ${imageInstruction} ${simpleMathPrompt}. For each question, specify its 'questionType'. If 'questionType' is 'multiple_choice', provide 'options' and 'correctAnswerIndex'. If 'questionType' is 'short_answer', provide 'idealAnswer'.`;
            schema = { type: "OBJECT", properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "questionType", "explanation"] };
            break;
        case 'true_false':
             // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ---
            prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πà/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà${subjectPrefix} ${numQuestions} ‡∏Ç‡πâ‡∏≠ ${topicInstruction}. ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (questionText), ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (correctAnswer ‡πÄ‡∏õ‡πá‡∏ô true ‡∏´‡∏£‡∏∑‡∏≠ false), ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (explanation). ${imageInstruction} ${simpleMathPrompt}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, correctAnswer: { type: "BOOLEAN" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "correctAnswer", "explanation"] };
            break;
        case 'matching':
             // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ---
            prompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà${subjectPrefix} ${numQuestions} ‡∏Ñ‡∏π‡πà ${topicInstruction}. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON object ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞ object ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ: 'questionType' (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 'matching_item'), 'stem' (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢), 'correctResponse' (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤), ‡πÅ‡∏•‡∏∞ 'explanation'. ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á key ‡∏ä‡∏∑‡πà‡∏≠ 'allResponses' ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° 'correctResponse' ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${numQuestions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô dropdown. ${imageInstruction} ${simpleMathPrompt}`;
            schema = { type: "OBJECT", properties: { questionType: { type: "STRING", "enum": ["matching_item"] }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, allResponses: { type: "ARRAY", items: { type: "STRING" } }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionType", "stem", "correctResponse", "allResponses", "explanation"] };
            break;
    }
    const finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: schema } }, required: ["topic", "questions"] };

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
    const finalPrompt = `‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏ô‡∏µ‡πâ, ${prompt}`;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Multimodal
    const payload = {
        contents: [{
            parts: [
                { text: finalPrompt },
                {
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                }
            ]
        }],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: finalSchema
        }
    };

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ handleApiCall ‡∏Å‡∏±‡∏ö Payload ‡πÉ‡∏´‡∏°‡πà
    return handleApiCall(payload.contents[0].parts, 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...', finalSchema);
}

        async function handleApiCall(promptOrParts, loadingMessage, schema, singleQuestionIndex = null) {
    const quizGenArea = document.getElementById('quiz-generation-area');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');

    quizGenArea.classList.remove('hidden');
    if (singleQuestionIndex === null) {
        genQuizContainer.innerHTML = '';
    }
    loader.classList.remove('hidden');
    loaderText.textContent = loadingMessage;

    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    document.getElementById('generate-from-topic-btn').disabled = true;
    document.getElementById('generate-from-text-btn').disabled = true;
    document.getElementById('generate-from-link-btn').disabled = true;


    try {
        const generationConfig = {
            responseMimeType: "application/json",
            responseSchema: schema
        };
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ prompt ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡∏´‡∏£‡∏∑‡∏≠ array of parts
        const parts = Array.isArray(promptOrParts) ? promptOrParts : [{ text: promptOrParts }];
        const payload = { contents: [{ role: "user", parts: parts }], generationConfig };

        const apiKey = "AIzaSyBgBJ28OshxBTnqUzCKsv7nve2Xj899fwA"; // API key will be provided by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
        const result = await response.json();
        
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            let jsonText = result.candidates[0].content.parts[0].text;
            let parsedData;
            try {
                // --- START: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î JSON ---
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö Markdown code fences (```json ... ```) ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏°‡∏≤
                if (jsonText.startsWith("```json")) {
                    jsonText = jsonText.substring(7, jsonText.length - 3).trim();
                } else if (jsonText.startsWith("```")) {
                     jsonText = jsonText.substring(3, jsonText.length - 3).trim();
                }
                // --- END: ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---

                parsedData = JSON.parse(jsonText);

            } catch(e) {
                console.error("Failed to parse JSON from AI", e, jsonText);
                throw new Error("Invalid response structure from AI.");
            }
            
            if (singleQuestionIndex !== null) {
                // Handle regenerating a single question
                if (parsedData.questionType === 'matching_item') {
                    // When regenerating a matching item, the AI only returns one item.
                    // We need to merge it back into the existing quiz structure.
                    const allResponses = currentQuizData.questions.map(q => q.correctResponse);
                    parsedData.allResponses = allResponses; // Keep the original full list of responses
                    // Replace the specific correctResponse in the list with the new one
                    const oldCorrectResponse = currentQuizData.questions[singleQuestionIndex].correctResponse;
                    const responseIndex = allResponses.indexOf(oldCorrectResponse);
                    if (responseIndex > -1) {
                        allResponses[responseIndex] = parsedData.correctResponse;
                    }
                    // Update all other matching questions with the new response list
                    currentQuizData.questions.forEach(q => {
                        if(q.questionType === 'matching_item') q.allResponses = allResponses;
                    });
                }
                currentQuizData.questions[singleQuestionIndex] = parsedData;
                displayGeneratedQuiz(currentQuizData);
            } else {
                // Handle generating a new quiz
                currentQuizData = parsedData;
                const quizTypeFromUI = document.getElementById('quiz-type-select').value;

                // Standardize the quizType and questionType properties
                currentQuizData.quizType = quizTypeFromUI; 

                // Assign questionType to each question based on the overall type, if not already present
                if(currentQuizData.questions) {
                    currentQuizData.questions.forEach(q => {
                        if (!q.questionType) {
                            if (quizTypeFromUI === 'fill_in_with_choices') {
                                q.questionType = 'multiple_choice';
                            } else if (quizTypeFromUI === 'fill_in_no_choices') {
                                q.questionType = 'short_answer';
                            } else {
                                q.questionType = quizTypeFromUI;
                            }
                        }
                    });
                }
                displayGeneratedQuiz(currentQuizData);
            }
        } else {
            console.error("Invalid response structure from AI:", JSON.stringify(result));
            throw new Error("Invalid response structure from AI.");
        }

    } catch (error) {
        console.error("Error generating quiz:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        if (singleQuestionIndex === null) {
            genQuizContainer.innerHTML = `<p class="text-red-500 text-center">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ</p>`;
        }
    } finally {
        loader.classList.add('hidden');
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        document.getElementById('generate-from-topic-btn').disabled = false;
        document.getElementById('generate-from-text-btn').disabled = false;
        document.getElementById('generate-from-link-btn').disabled = false;
        
        // === ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ===
        const fileBtn = document.getElementById('generate-from-file-btn');
        if (fileBtn) {
            fileBtn.disabled = false;
        }
    }
}

        function displayGeneratedQuiz(quizData) {
            const container = document.getElementById('generated-quiz-container');
            let html = `<h3 class="text-xl font-bold mb-3" contenteditable="true" id="editable-quiz-topic">${quizData.topic}</h3>`;
            quizData.questions.forEach((q, index) => {
                const questionType = q.questionType || quizData.quizType;
                
                html += `
                    <div class="mb-4 p-4 border rounded-lg relative group">
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                             <button data-index="${index}" class="save-to-bank-btn text-purple-600 hover:text-purple-800 p-1" title="‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">
    <i class="fas fa-university"></i>
</button>
                             <button data-index="${index}" class="edit-question-btn text-blue-600 hover:text-blue-800 p-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ"><i class="fas fa-pen"></i></button>
                             <button data-index="${index}" class="regenerate-question-btn text-green-600 hover:text-green-800 p-1" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà"><i class="fas fa-sync-alt"></i></button>
                        </div>
                `;

                // Render based on question type
                switch(questionType) {
                    case 'matching_item':
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.stem}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<div class="mt-2 p-2 bg-green-100 text-sm"><strong class="text-gray-700">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</strong> <span id="q-correct-${index}">${q.correctResponse}</span></div>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                    case 'short_answer':
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.questionText}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<div class="mt-2 p-2 bg-gray-100 text-sm"><strong class="text-gray-700">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:</strong> <span id="q-ideal-${index}">${q.idealAnswer}</span></div>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                    case 'true_false':
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.questionText}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<div class="mt-2 space-y-1 text-sm">
                                     <p class="${q.correctAnswer === true ? 'text-green-600 font-bold' : ''}">‡πÉ‡∏ä‡πà</p>
                                     <p class="${q.correctAnswer === false ? 'text-green-600 font-bold' : ''}">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</p>
                                 </div>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                    case 'fill_in_the_blank':
                    case 'multiple_choice':
                    default:
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.questionText}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<ul class="list-disc list-inside mt-2 space-y-1 text-sm" id="q-options-${index}">
                                     ${q.options.map((opt, i) => `<li class="${i === q.correctAnswerIndex ? 'text-green-600 font-bold' : ''}">${opt}</li>`).join('')}
                                 </ul>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                }

                html += `</div>`;
            });
            html += `<div id="generated-quiz-actions" class="mt-4">
                          <button id="save-quiz-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700"><i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™</button>
                         </div>`;
            container.innerHTML = html;
            
            // Add event listeners for new buttons
            document.querySelectorAll('.edit-question-btn').forEach(btn => btn.addEventListener('click', handleEditQuestion));
            document.querySelectorAll('.regenerate-question-btn').forEach(btn => btn.addEventListener('click', handleRegenerateQuestion));
            document.querySelectorAll('.save-to-bank-btn').forEach(btn => btn.addEventListener('click', handleSaveToBank));
            document.getElementById('save-quiz-btn').addEventListener('click', saveQuiz);

            if (window.MathJax) window.MathJax.typesetPromise([container]);
        }
        
        function handleRegenerateQuestion(e) {
            const index = e.currentTarget.dataset.index;
            const topic = currentQuizData.topic;
            showMessage(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ${parseInt(index) + 1} ‡πÉ‡∏´‡∏°‡πà...`);
            generateQuiz(topic, null, parseInt(index));
        }

        // --- SVG Drag and Drop Functions (Mouse & Touch) ---
        function getPointerPosition(svg, evt) {
            const CTM = svg.getScreenCTM();
            let clientX, clientY;

            // Check for touch event
            if (evt.touches && evt.touches.length > 0) {
                clientX = evt.touches[0].clientX;
                clientY = evt.touches[0].clientY;
            } else {
                // Fallback to mouse event
                clientX = evt.clientX;
                clientY = evt.clientY;
            }

            return {
                x: (clientX - CTM.e) / CTM.a,
                y: (clientY - CTM.f) / CTM.d
            };
        }

        function startDrag(evt) {
            // Prevent default touch actions like scrolling
            if (evt.type === 'touchstart') {
                evt.preventDefault();
            }
            const target = evt.target.closest('.draggable-text');
            if (target) {
                draggedSvgElement = target;
                const svg = draggedSvgElement.ownerSVGElement;
                const pointerPos = getPointerPosition(svg, evt);

                svgOffset.x = pointerPos.x - parseFloat(draggedSvgElement.getAttributeNS(null, "x"));
                svgOffset.y = pointerPos.y - parseFloat(draggedSvgElement.getAttributeNS(null, "y"));
            }
        }

        function drag(evt) {
            if (draggedSvgElement) {
                evt.preventDefault();
                const svg = draggedSvgElement.ownerSVGElement;
                const pointerPos = getPointerPosition(svg, evt);
                const viewBox = svg.viewBox.baseVal;

                // Calculate proposed new coordinates
                let newX = pointerPos.x - svgOffset.x;
                let newY = pointerPos.y - svgOffset.y;

                // Get the bounding box of the text element itself to prevent it from going partially off-screen
                const textBBox = draggedSvgElement.getBBox();

                // Clamp coordinates within the SVG viewbox
                newX = Math.max(viewBox.x, Math.min(newX, viewBox.x + viewBox.width - textBBox.width));
                newY = Math.max(viewBox.y, Math.min(newY, viewBox.y + viewBox.height - textBBox.height));

                draggedSvgElement.setAttributeNS(null, "x", newX);
                draggedSvgElement.setAttributeNS(null, "y", newY);
            }
        }

        function endDrag(evt) {
            draggedSvgElement = null;
        }

        // --- SVG Edit Click Handler ---
        function handleSvgEditClick(e) {
            if (e.target.classList.contains('delete-svg-btn')) {
                const targetId = e.target.dataset.targetId;
                const svg = e.currentTarget;
                const textElementToDelete = svg.querySelector(`#${targetId}`);
                if (textElementToDelete) {
                    textElementToDelete.remove();
                }
                e.target.remove(); // Remove the delete button itself
            }
        }
        
        function handleEditQuestion(e) {
            const btn = e.currentTarget;
            const index = btn.dataset.index;
            const q = currentQuizData.questions[index];
            const qTextEl = document.getElementById(`q-text-${index}`);
            const qExplanationEl = document.getElementById(`q-explanation-${index}`);
            const imageContainer = document.getElementById(`q-image-container-${index}`);

            if (btn.innerHTML.includes('fa-pen')) { // --- Start edit mode ---
                btn.innerHTML = '<i class="fas fa-save"></i>';
                btn.title = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";

                if(qTextEl) qTextEl.contentEditable = true;
                if(qExplanationEl) qExplanationEl.contentEditable = true;

                if (imageContainer) {
                    const svgElement = imageContainer.querySelector('svg');
                    if (svgElement) {
                        const textElements = svgElement.querySelectorAll('text');
                        textElements.forEach((textEl, i) => {
                            const textId = `editable-text-${index}-${i}`;
                            textEl.id = textId;
                            textEl.classList.add('draggable-text');
                            textEl.style.cursor = 'move';

                            // Create and append delete button
                            const deleteBtn = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            const textBBox = textEl.getBBox();
                            deleteBtn.setAttribute('cx', String(textBBox.x + textBBox.width + 5));
                            deleteBtn.setAttribute('cy', String(textBBox.y + textBBox.height / 2 - 5));
                            deleteBtn.setAttribute('r', '5');
                            deleteBtn.setAttribute('fill', 'red');
                            deleteBtn.setAttribute('class', 'delete-svg-btn');
                            deleteBtn.dataset.targetId = textId;
                            textEl.after(deleteBtn);
                        });
                        
                        // Add event listeners for drag and delete
                        svgElement.addEventListener('mousedown', startDrag);
                        svgElement.addEventListener('mousemove', drag);
                        svgElement.addEventListener('mouseup', endDrag);
                        svgElement.addEventListener('mouseleave', endDrag);
                        svgElement.addEventListener('touchstart', startDrag, { passive: false });
                        svgElement.addEventListener('touchmove', drag, { passive: false });
                        svgElement.addEventListener('touchend', endDrag);
                        svgElement.addEventListener('touchcancel', endDrag);
                        svgElement.addEventListener('click', handleSvgEditClick);
                    }
                }
                if(qTextEl) qTextEl.focus();

            } else { // --- Save edits ---
                btn.innerHTML = '<i class="fas fa-pen"></i>';
                btn.title = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ";

                if(qTextEl) {
                    qTextEl.contentEditable = false;
                    const questionType = q.questionType || currentQuizData.quizType;
                    if (questionType === 'matching_item') {
                         q.stem = qTextEl.innerText.substring(qTextEl.innerText.indexOf('.') + 2).trim();
                    } else {
                         q.questionText = qTextEl.innerText.substring(qTextEl.innerText.indexOf('.') + 2).trim();
                    }
                }
                if(qExplanationEl) {
                    qExplanationEl.contentEditable = false;
                    q.explanation = qExplanationEl.innerText;
                }

                if (imageContainer) {
                    const svgElement = imageContainer.querySelector('svg');
                    if (svgElement) {
                        // Clone the SVG to manipulate it without affecting the display
                        const svgClone = svgElement.cloneNode(true);
                        
                        // Remove delete buttons and other edit-mode artifacts from the clone
                        svgClone.querySelectorAll('.delete-svg-btn').forEach(btn => btn.remove());
                        svgClone.querySelectorAll('.draggable-text').forEach(el => {
                            el.classList.remove('draggable-text');
                            el.style.cursor = 'default';
                            el.removeAttribute('id');
                        });

                        // Save the cleaned HTML
                        q.imageCode = svgClone.outerHTML;

                        // Now, remove listeners and artifacts from the displayed SVG
                        svgElement.removeEventListener('mousedown', startDrag);
                        svgElement.removeEventListener('mousemove', drag);
                        svgElement.removeEventListener('mouseup', endDrag);
                        svgElement.removeEventListener('mouseleave', endDrag);
                        svgElement.removeEventListener('touchstart', startDrag);
                        svgElement.removeEventListener('touchmove', drag);
                        svgElement.removeEventListener('touchend', endDrag);
                        svgElement.removeEventListener('touchcancel', endDrag);
                        svgElement.removeEventListener('click', handleSvgEditClick);
                        
                        svgElement.querySelectorAll('.delete-svg-btn').forEach(btn => btn.remove());
                        svgElement.querySelectorAll('.draggable-text').forEach(el => {
                            el.classList.remove('draggable-text');
                            el.style.cursor = 'default';
                        });
                    }
                }
            }
        }

let currentEditingQuizData = null; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á script

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î Editor ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function handleOpenQuizEditor(quizId) {
            const editorModal = document.getElementById('quiz-editor-modal');
            const questionsContainer = document.getElementById('quiz-editor-questions-container');
            
            questionsContainer.innerHTML = '<div class="loader mx-auto"></div>';
            editorModal.classList.remove('hidden');

            try {
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const quizSnap = await getDoc(quizRef);

                if (!quizSnap.exists()) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                }
                
                currentEditingQuizData = { id: quizId, ...quizSnap.data() };
                renderQuizEditor(currentEditingQuizData);

            } catch (error) {
                console.error("Error opening quiz editor:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                editorModal.classList.add('hidden');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Editor ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
        function renderQuizEditor(quizData) {
            document.getElementById('editor-quiz-topic').value = quizData.topic;
            const questionsContainer = document.getElementById('quiz-editor-questions-container');
            
            let html = quizData.questions.map((q, index) => {
                let questionContent = '';
                const questionType = q.questionType || quizData.quizType;
                
                switch(questionType) {
                    case 'multiple_choice':
                        const optionsHTML = (q.options || []).map((opt, optIndex) => `
                            <div class="flex items-center gap-2">
                                <input type="radio" name="correct-answer-${index}" value="${optIndex}" ${optIndex === q.correctAnswerIndex ? 'checked' : ''} class="accent-green-600">
                                <input type="text" value="${opt}" class="w-full p-1 border rounded-md">
                            </div>
                        `).join('');
                        questionContent = `
                            <label class="block text-sm font-medium text-gray-600">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏â‡∏•‡∏¢:</label>
                            <div class="space-y-2 mt-1">${optionsHTML}</div>
                        `;
                        break;
                    case 'short_answer':
                         questionContent = `
                            <label class="block text-sm font-medium text-gray-600">‡πÄ‡∏â‡∏•‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</label>
                            <input type="text" value="${q.idealAnswer || ''}" class="w-full p-1 border rounded-md ideal-answer-input">
                         `;
                        break;
                    case 'true_false':
                        questionContent = `
                            <label class="block text-sm font-medium text-gray-600">‡πÄ‡∏â‡∏•‡∏¢:</label>
                            <div class="space-y-1 mt-1">
                                <div class="flex items-center gap-2"><input type="radio" name="correct-answer-${index}" value="true" ${q.correctAnswer === true ? 'checked' : ''} class="accent-green-600"> <span>‡πÉ‡∏ä‡πà / ‡∏ñ‡∏π‡∏Å</span></div>
                                <div class="flex items-center gap-2"><input type="radio" name="correct-answer-${index}" value="false" ${q.correctAnswer === false ? 'checked' : ''} class="accent-green-600"> <span>‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà / ‡∏ú‡∏¥‡∏î</span></div>
                            </div>
                        `;
                        break;
                    case 'matching_item':
                        questionContent = `
                             <label class="block text-sm font-medium text-gray-600">‡πÄ‡∏â‡∏•‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ñ‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ):</label>
                             <input type="text" value="${q.correctResponse || ''}" class="w-full p-1 border rounded-md correct-response-input">
                        `;
                        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Matching ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (stem) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                        // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô dropdown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
                        break;
                }

                const questionText = q.questionText || q.stem || '';
                return `
     <div class="p-4 border rounded-lg bg-gray-50 question-editor-item relative" data-q-index="${index}" data-q-type="${questionType}">
        
        <div class="absolute top-2 right-2 flex items-center gap-2">
            <button class="regenerate-question-editor-btn text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-100" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1} (${questionType}):</label>
        <textarea class="w-full p-2 border border-gray-300 rounded-lg" rows="2">${questionText}</textarea>
        <div class="mt-3">${questionContent}</div>
    </div>
                `;
            }).join('');

            questionsContainer.innerHTML = html;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        async function handleSaveChanges() {
            const saveBtn = document.getElementById('save-quiz-edits-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const newTopic = document.getElementById('editor-quiz-topic').value;
                const questionElements = document.querySelectorAll('.question-editor-item');
                let allCorrectResponsesForMatching = [];

                // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
                const newQuestions = Array.from(questionElements).map((el, index) => {
                    const questionType = el.dataset.qType;
                    const questionTextFromTextArea = el.querySelector('textarea').value;
                    let newQuestionData = { questionType: questionType };
                    const originalQuestion = currentEditingQuizData.questions[index];
                    
                    // ‡πÉ‡∏ä‡πâ switch case ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                    switch (questionType) {
                        case 'multiple_choice':
                            newQuestionData.questionText = questionTextFromTextArea;
                            const optionInputs = el.querySelectorAll('input[type="text"]');
                            newQuestionData.options = Array.from(optionInputs).map(input => input.value);
                            const checkedRadioMCQ = el.querySelector('input[type="radio"]:checked');
                            newQuestionData.correctAnswerIndex = checkedRadioMCQ ? parseInt(checkedRadioMCQ.value) : 0;
                            break;
                        case 'short_answer':
                            newQuestionData.questionText = questionTextFromTextArea;
                            newQuestionData.idealAnswer = el.querySelector('.ideal-answer-input').value;
                            break;
                        case 'true_false':
                            newQuestionData.questionText = questionTextFromTextArea;
                            const checkedRadioTF = el.querySelector('input[type="radio"]:checked');
                            newQuestionData.correctAnswer = checkedRadioTF ? checkedRadioTF.value === 'true' : true;
                            break;
                        case 'matching_item':
                            newQuestionData.stem = questionTextFromTextArea;
                            const correctResponseInput = el.querySelector('.correct-response-input');
                            newQuestionData.correctResponse = correctResponseInput ? correctResponseInput.value : '';
                            allCorrectResponsesForMatching.push(newQuestionData.correctResponse);
                            break;
                        default:
                            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                            newQuestionData.questionText = questionTextFromTextArea;
                            break;
                    }
                    
                    // ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    return { ...originalQuestion, ...newQuestionData };
                });

                // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï 'allResponses' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô matching_item
                if (allCorrectResponsesForMatching.length > 0) {
                    newQuestions.forEach(q => {
                        if (q.questionType === 'matching_item') {
                            q.allResponses = allCorrectResponsesForMatching;
                        }
                    });
                }

                // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô Firestore
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, currentEditingQuizData.id);
                await updateDoc(quizRef, {
                    topic: newTopic,
                    questions: newQuestions
                });
                
                showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                document.getElementById('quiz-editor-modal').classList.add('hidden');
                
            } catch (error) {
                console.error("Error saving quiz edits:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; // <-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô class=
            }
        }

        async function saveQuiz() {
    // ‚ñº‚ñº‚ñº ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‚ñº‚ñº‚ñº
    if (!currentProjectId) {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô
        promptForProjectAndSave();
        return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveQuiz ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    }
    // ‚ñ≤‚ñ≤‚ñ≤ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‚ñ≤‚ñ≤‚ñ≤

    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveQuiz() ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ currentProjectId ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    if (!currentQuizData || !currentQuizData.questions || !userId) {
        showMessage("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ");
        return;
    }
    const saveButton = document.getElementById('save-quiz-btn');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    currentQuizData.topic = document.getElementById('editable-quiz-topic').innerText;

    try {
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô try...catch... ‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveQuiz ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ...
        // (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ)
        const newQuizSettings = {
            resultsDisplay: document.getElementById('results-display-select').value,
            shuffle: document.getElementById('shuffle-setting-select').value,
            timerMode: document.getElementById('timer-mode-select').value,
            timerDuration: parseInt(document.getElementById('timer-duration-input').value) || 10,
            passingScore: parseInt(document.getElementById('passing-score-input').value) || 0,
            isAdaptive: document.getElementById('adaptive-quiz-checkbox').checked
        };

        const cleanQuestions = (currentQuizData.questions || []).map(q => {
            const quizTypeFromUI = document.getElementById('quiz-type-select').value;
            const cleanQ = {
                questionText: q.questionText || "",
                explanation: q.explanation || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢",
                questionType: q.questionType || quizTypeFromUI,
                imageCode: q.imageCode || null,
            };
            
            if (cleanQ.questionType === 'multiple_choice' || cleanQ.questionType === 'fill_in_with_choices' || (cleanQ.questionType === 'mixed' && q.options)) {
                cleanQ.options = q.options || [];
                cleanQ.correctAnswerIndex = q.correctAnswerIndex !== undefined ? q.correctAnswerIndex : 0;
            }
            if (cleanQ.questionType === 'short_answer' || cleanQ.questionType === 'fill_in_no_choices' || (cleanQ.questionType === 'mixed' && q.idealAnswer)) {
                cleanQ.idealAnswer = q.idealAnswer || "";
            }
            if (cleanQ.questionType === 'true_false') {
                cleanQ.correctAnswer = q.correctAnswer === true;
            }
            if (cleanQ.questionType === 'matching_item') {
                cleanQ.stem = q.stem || "";
                cleanQ.correctResponse = q.correctResponse || "";
                cleanQ.allResponses = q.allResponses || [];
            }
            return cleanQ;
        });

        const dataToSave = {
            topic: currentQuizData.topic || "‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠",
            quizType: currentQuizData.quizType || "multiple_choice",
            questions: cleanQuestions,
            projectId: currentProjectId,
            createdBy: userId,
            createdAt: new Date().toISOString(),
            status: 'active',
            settings: newQuizSettings
        };

        let quizId;
        while (true) {
            quizId = Math.floor(1000 + Math.random() * 9000).toString();
            const existing = await getDoc(doc(db, `artifacts/${appId}/public/data/quizzes`, quizId));
            if (!existing.exists()) break;
        }
        await setDoc(doc(db, `artifacts/${appId}/public/data/quizzes`, quizId), dataToSave);

        currentQuizData.settings = newQuizSettings;
        currentQuizData.id = quizId;

        const actionsContainer = document.getElementById('generated-quiz-actions');
        actionsContainer.innerHTML = `
            <div class="p-4 bg-green-100 text-green-800 rounded-lg text-center">
                <p class="font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                <p>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: <strong id="quiz-id" class="text-lg select-all">${quizId}</strong></p>
                <button id="copy-quiz-id-btn" class="mt-2 bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 text-sm"><i class="fas fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mt-4">
                <button id="start-live-race-generated-btn" class="w-full bg-orange-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-orange-600 flex items-center justify-center">
                    <i class="fas fa-flag-checkered mr-2"></i>‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏î
                </button>
                <button id="start-presentation-btn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠
                </button>
                <button id="admin-try-quiz-btn" class="w-full bg-teal-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-teal-700 flex items-center justify-center">
                    <i class="fas fa-vial mr-2"></i>‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                </button>
            </div>
        `;
        document.getElementById('copy-quiz-id-btn').addEventListener('click', () => copyTextToClipboard(quizId, "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!"));
        document.getElementById('start-live-race-generated-btn').addEventListener('click', () => handleStartLiveRace(quizId));
        document.getElementById('start-presentation-btn').addEventListener('click', () => startPresentation(currentQuizData));
        document.getElementById('admin-try-quiz-btn').addEventListener('click', startAdminTest);
        showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");

    } catch (error) {
        console.error("Error saving quiz:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™';
    }
}

/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Modal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 */
function promptForProjectAndSave() {
    const moveQuizModal = document.getElementById('move-quiz-modal');
    const projectSelect = document.getElementById('move-quiz-project-select');
    const modalTitle = moveQuizModal.querySelector('h3');
    const confirmBtn = document.getElementById('confirm-move-quiz-btn');

    // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
    modalTitle.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    confirmBtn.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

    // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ
    if (allProjects.length === 0) {
        projectSelect.innerHTML = '<option value="">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ</option>';
        confirmBtn.disabled = true;
    } else {
        projectSelect.innerHTML = allProjects
            .map(p => `<option value="${p.id}">${p.projectName}</option>`)
            .join('');
        confirmBtn.disabled = false;
    }
    
    // 3. ‡πÅ‡∏™‡∏î‡∏á Modal
    moveQuizModal.classList.remove('hidden');

    // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
    const newConfirmHandler = () => {
        const selectedProjectId = projectSelect.value;
        if (selectedProjectId) {
            currentProjectId = selectedProjectId; // **‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å**
            moveQuizModal.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô Modal
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveQuiz ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ currentProjectId ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß
            saveQuiz(); 
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞ Event Listener ‡∏Ç‡∏≠‡∏á Modal ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            modalTitle.textContent = '‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô';
            confirmBtn.textContent = '‡∏¢‡πâ‡∏≤‡∏¢';
            confirmBtn.removeEventListener('click', newConfirmHandler);
            confirmBtn.addEventListener('click', confirmMoveQuiz);
        } else {
            showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        }
    };

    // ‡∏•‡∏ö Event Listener ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    confirmBtn.removeEventListener('click', confirmMoveQuiz);
    confirmBtn.addEventListener('click', newConfirmHandler);
}
        
        function copyTextToClipboard(text, successMessage) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                showMessage(successful ? successMessage : "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (err) {
                showMessage("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                console.error('Copy command failed', err);
            }
            document.body.removeChild(textArea);
        }

        // --- Admin Results View ---
        function listenForProjectQuizzes(projectId) {
            const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
            const q = query(quizzesRef, where("projectId", "==", projectId));
            
            unsubscribeQuizzesListener = onSnapshot(q, async (snapshot) => {
                allQuizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQuizzes();
            }, (error) => {
                console.error("Error fetching project quizzes:", error);
                document.getElementById('project-quizzes-list').innerHTML = '<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>';
            });
        }
        
       async function renderQuizzes() {
            const quizzesListContainer = document.getElementById('project-quizzes-list');
            const searchTerm = document.getElementById('quiz-search-input').value.toLowerCase();

            // --- [ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ] ---
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÑ‡∏´‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            let quizzesToRender;
            if (currentProjectId === 'starred') {
                quizzesToRender = starredQuizzes; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å starredQuizzes
            } else {
                quizzesToRender = allQuizzes; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å allQuizzes
            }
            // --- [ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ] ---
            
            // --- [ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ] ---
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å allQuizzes ‡πÄ‡∏õ‡πá‡∏ô quizzesToRender
            let filteredQuizzes = quizzesToRender.filter(q => q.topic.toLowerCase().includes(searchTerm));
            filteredQuizzes.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (filteredQuizzes.length === 0) {
                quizzesListContainer.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</p>';
                return;
            }
            
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            const submissionCounts = {};
            const submissionPromises = filteredQuizzes.map(async (quiz) => {
                const submissionsCol = collection(db, `artifacts/${appId}/public/data/quizzes/${quiz.id}/submissions`);
                const submissionSnapshot = await getDocs(submissionsCol);
                submissionCounts[quiz.id] = submissionSnapshot.size;
            });
            await Promise.all(submissionPromises);

            let html = '';
            filteredQuizzes.forEach(quiz => {
                const submissionCount = submissionCounts[quiz.id] || 0;
                const status = quiz.status || 'active';
                const timerMode = quiz.settings?.timerMode || 'none';

                let statusText = '';
                let statusColor = '';
                const now = new Date();
                let effectiveStatus = status;

                if (status === 'scheduled') {
                    const startTime = quiz.startTime ? new Date(quiz.startTime) : null;
                    const endTime = quiz.endTime ? new Date(quiz.endTime) : null;
                    if (endTime && now > endTime) {
                        effectiveStatus = 'inactive';
                    } else if (startTime && now < startTime) {
                        effectiveStatus = 'scheduled_pending';
                    } else {
                        effectiveStatus = 'active'; // It's within the scheduled time
                    }
                }

                switch(effectiveStatus) {
                    case 'inactive':
                        statusText = '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                        statusColor = 'text-red-700 bg-red-100';
                        break;
                    case 'scheduled_pending':
                        statusText = '‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î';
                        statusColor = 'text-blue-700 bg-blue-100';
                        break;
                    case 'active':
                        statusText = timerMode !== 'none' ? '‡πÄ‡∏õ‡∏¥‡∏î (‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                        statusColor = 'text-green-700 bg-green-100';
                        break;
                    default: // for 'scheduled' but currently active
                        statusText = '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏õ‡∏¥‡∏î)';
                        statusColor = 'text-green-700 bg-green-100';
                }


                let scheduleInfo = '';
                const timeFormatOptions = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
                if (status === 'scheduled') {
                    if (quiz.startTime) {
                         scheduleInfo += `<p class="text-xs text-gray-500 mt-1">‡πÄ‡∏õ‡∏¥‡∏î: ${new Date(quiz.startTime).toLocaleString('th-TH', timeFormatOptions)}</p>`;
                    }
                    if (quiz.endTime) {
                         scheduleInfo += `<p class="text-xs text-gray-500 mt-1">‡∏õ‡∏¥‡∏î: ${new Date(quiz.endTime).toLocaleString('th-TH', timeFormatOptions)}</p>`;
                    }
                }

                html += `
                    <div class="p-4 border rounded-lg hover:bg-gray-50 flex flex-col">
                         <div class="flex justify-between items-start">
                             <div class="quiz-result-card cursor-pointer flex-grow" data-quiz-id="${quiz.id}">
                                 
                                 <p class="font-semibold text-indigo-700 pointer-events-none">${quiz.topic} <span class="text-xs text-gray-500 pointer-events-none ml-2">(${quiz.questions.length} ‡∏Ç‡πâ‡∏≠)</span></p>

                                 <p class="text-sm text-gray-500 pointer-events-none">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(quiz.createdAt).toLocaleString('th-TH')}</p>
                                 <div class="mt-1">
                                     <span class="font-semibold text-sm">${submissionCount}</span>
                                     <span class="text-xs text-gray-600"> ‡∏Ñ‡∏ô‡∏™‡πà‡∏á</span>
                                 </div>
                                 ${scheduleInfo}
                             </div>
                             <div class="flex flex-col items-end">
                                 <div class="flex items-center gap-2">
                                     <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                                     <button data-quiz-id="${quiz.id}" class="quiz-status-btn text-gray-600 hover:text-indigo-600 text-lg p-1" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><i class="fas fa-power-off"></i></button>
                                 </div>
                             </div>
                         </div>
                         <div class="flex items-center justify-end flex-wrap gap-2 mt-3 pt-3 border-t">
                             <button data-quiz-id="${quiz.id}" class="star-quiz-btn text-gray-400 hover:text-yellow-500 text-lg p-1" title="‡∏ï‡∏¥‡∏î‡∏î‡∏≤‡∏ß">
    <i class="${quiz.isStarred ? 'fas fa-star text-yellow-500' : 'far fa-star'}"></i>
</button>
                             <button data-quiz-id="${quiz.id}" class="start-live-race-btn text-orange-800 bg-orange-100 hover:bg-orange-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-flag-checkered"></i> ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏î</button>
                             <button data-quiz-id="${quiz.id}" data-topic="${quiz.topic}" class="rename-quiz-btn text-yellow-800 bg-yellow-100 hover:bg-yellow-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠</button>
							 <button data-quiz-id="${quiz.id}" class="edit-quiz-btn text-blue-800 bg-blue-100 hover:bg-blue-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
							 <button data-quiz-id="${quiz.id}" class="parallel-quiz-btn text-teal-800 bg-teal-100 hover:bg-teal-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-clone"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô</button>
                             <button data-quiz-id="${quiz.id}" class="quiz-settings-btn text-cyan-800 bg-cyan-100 hover:bg-cyan-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                             <button data-quiz-id="${quiz.id}" class="duplicate-quiz-btn text-gray-800 bg-gray-100 hover:bg-gray-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                             <button data-quiz-id="${quiz.id}" class="move-quiz-btn text-purple-800 bg-purple-100 hover:bg-purple-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-project-diagram"></i> ‡∏¢‡πâ‡∏≤‡∏¢</button>
                             <button data-quiz-id="${quiz.id}" class="copy-quiz-id-list-btn text-blue-800 bg-blue-100 hover:bg-blue-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-id-card"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID</button>
                             <button data-quiz-id="${quiz.id}" class="start-presentation-list-btn text-indigo-800 bg-indigo-100 hover:bg-indigo-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-chalkboard-teacher"></i> ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                             <button data-quiz-id="${quiz.id}" class="admin-try-quiz-list-btn text-teal-800 bg-teal-100 hover:bg-teal-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-vial"></i> ‡∏ó‡∏î‡∏•‡∏≠‡∏á</button>
                             <button data-quiz-id="${quiz.id}" data-topic="${quiz.topic}" class="delete-quiz-btn text-red-500 hover:text-red-700 text-lg p-1 ml-auto" title="‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö"><i class="fas fa-trash-alt"></i></button>
                         </div>
                    </div>
                `;
            });
            quizzesListContainer.innerHTML = html;
            
            document.querySelectorAll('.quiz-result-card').forEach(card => {
                card.addEventListener('click', () => {
                    const quizId = card.dataset.quizId;
                    showQuizDetailView(quizId);
                });
            });
        }
        
        async function handleDuplicateQuiz(quizId) {
            try {
                const originalQuizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const originalQuizSnap = await getDoc(originalQuizRef);

                if (originalQuizSnap.exists()) {
                    const originalData = originalQuizSnap.data();
                    const newData = {
                        ...originalData,
                        topic: `(‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å) ${originalData.topic}`,
                        createdAt: new Date().toISOString(),
                        // Submissions are not copied
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/quizzes`), newData);
                    showMessage("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                } else {
                    throw new Error("Original quiz not found");
                }
            } catch (error) {
                console.error("Error duplicating quiz:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
            }
        }


        async function handleDeleteQuiz(quizId, showSuccessMessage = true) {
             try {
                const batch = writeBatch(db);
                // 1. Delete all submissions in the subcollection
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`);
                const submissionsSnapshot = await getDocs(submissionsRef);
                submissionsSnapshot.forEach(subDoc => {
                    batch.delete(doc(submissionsRef, subDoc.id));
                });

                // 2. Delete the quiz document itself
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                batch.delete(quizRef);

                await batch.commit();

                if (showSuccessMessage) {
                    showMessage("‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
                }
            } catch (error) {
                console.error("Error deleting quiz:", error);
                if (showSuccessMessage) {
                    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                }
            }
        }

        async function showQuizDetailView(quizId) {
            if (unsubscribeSubmissionsListener) unsubscribeSubmissionsListener();
            switchQuizDetailTab('analytics');

            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const quizDoc = await getDoc(quizRef);

                if (!quizDoc.exists()) {
                    showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
                    return;
                }

                const quizData = { id: quizDoc.id, ...quizDoc.data() };
                currentQuizData = quizData;

                // --- [ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ] ---
                // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÅ‡∏°‡πà‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏™‡∏°‡∏≠
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (currentProjectData) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, quizData.projectId);
                const projectDoc = await getDoc(projectRef);
                if (projectDoc.exists()) {
                    currentProjectData = projectDoc.data();
                    currentProjectId = quizData.projectId; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ID ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠
                } else {
                    // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô)
                    // ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÜ ‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏û‡∏±‡∏á
                    currentProjectData = { students: [] };
                    currentProjectId = quizData.projectId;
                }
                // --- [ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ] ---

                // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞ ID ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                document.getElementById('results-quiz-title').textContent = quizData.topic;
                document.getElementById('results-quiz-id-display').textContent = quizId;

                // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes`, quizId, "submissions");
                unsubscribeSubmissionsListener = onSnapshot(submissionsRef, (snapshot) => {
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    currentSubmissions = submissions; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô state
                    
                    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ currentProjectData ‡∏à‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏°‡∏≠
                    renderAnalytics(quizData, submissions);
                    renderQuizResultsTable(currentProjectData.students, submissions, quizData);
                    renderQuizLeaderboard(submissions, quizData, 'quiz-leaderboard-table-body');
                });

                // 5. ‡πÅ‡∏™‡∏î‡∏á View
                showView('quiz-results');

            } catch (error) {
                console.error("Error showing quiz detail view:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
            }
        }

        function renderQuizResultsTable(students, submissions, quizData) {
    const submissionsByStudent = submissions.reduce((acc, sub) => {
        acc[sub.studentName] = sub;
        return acc;
    }, {});

    const tableBody = document.getElementById('quiz-results-table-body');
    if (!students || students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ</td></tr>';
        return;
    }
    
    // --- UPDATED: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏ã‡πà‡∏≠‡∏° ---
    const isRemedialQuiz = quizData.isRemedial === true;
    const passingScore = quizData.settings?.passingScore ?? -1; 

    let html = '';
    students.forEach(studentName => {
        const submission = submissionsByStudent[studentName];
        let resultHtml = '<td class="py-2 px-4 border-b">-</td>';
        let quizTypeHtml = `<td class="py-2 px-4 border-b"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${isRemedialQuiz ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'}">${isRemedialQuiz ? '‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°' : '‡∏™‡∏≠‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥'}</span></td>`;
        
        if (submission) {
            let isPass;
            if (isRemedialQuiz) {
                isPass = (submission.bestScore === submission.totalQuestions);
            } else {
                isPass = passingScore !== -1 && submission.bestScore >= passingScore;
            }

            if (isRemedialQuiz || passingScore !== -1) {
                const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const resultText = isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
                resultHtml = `<td class="py-2 px-4 border-b"><span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${resultClass}">${resultText}</span></td>`;
            }
            
            const statusCell = `<td class="py-2 px-4 border-b"><span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (${submission.attempts?.length || 1} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span></td>`;

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">${studentName}</td>
                    <td class="py-2 px-4 border-b text-green-600 font-bold">${submission.bestScore} / ${submission.totalQuestions}</td>
                    ${resultHtml}
                    ${quizTypeHtml}
                    <td class="py-2 px-4 border-b font-semibold">${submission.firstScore} / ${submission.totalQuestions}</td>
                    <td class="py-2 px-4 border-b font-semibold">${submission.latestScore}</td>
                    <td class="py-2 px-4 border-b font-semibold text-blue-600">${submission.points || 0}</td>
                    ${statusCell}
                    <td class="py-2 px-4 border-b text-sm text-gray-600">${new Date(submission.latestSubmittedAt).toLocaleString('th-TH')}</td>
                </tr>
            `;
        } else {
            const statusCell = `<td class="py-2 px-4 border-b"><span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á</span></td>`;
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">${studentName}</td>
                    <td class="py-2 px-4 border-b">-</td>
                    <td class="py-2 px-4 border-b">-</td>
                    ${quizTypeHtml}
                    <td class="py-2 px-4 border-b">-</td>
                    <td class="py-2 px-4 border-b">-</td>
                    <td class="py-2 px-4 border-b">-</td>
                    ${statusCell}
                    <td class="py-2 px-4 border-b">-</td>
                </tr>
            `;
        }
    });
    tableBody.innerHTML = html;
}
        
        // --- Quiz Action Functions (Rename, Move, Timer, Status) ---
        function handleRenameQuiz(quizId, currentTopic) {
            actionTargetId = quizId;
            document.getElementById('rename-quiz-input').value = currentTopic;
            renameQuizModal.classList.remove('hidden');
        }

        async function confirmRenameQuiz() {
            const newName = document.getElementById('rename-quiz-input').value.trim();
            if (!newName) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà");
                return;
            }
            if (!actionTargetId) return;

            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            try {
                await updateDoc(quizRef, { topic: newName });
                showMessage("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                renameQuizModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                console.error("Error renaming quiz:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠");
            }
        }
        
        async function handleMoveQuiz(quizId) {
            actionTargetId = quizId;
            const projectSelect = document.getElementById('move-quiz-project-select');
            projectSelect.innerHTML = '<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ...</option>';
            moveQuizModal.classList.remove('hidden');

            try {
                const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
                const snapshot = await getDocs(projectsRef);
                const projects = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const otherProjects = projects.filter(p => p.id !== currentProjectId);

                if (otherProjects.length === 0) {
                    projectSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ</option>';
                    document.getElementById('confirm-move-quiz-btn').disabled = true;
                    return;
                }

                projectSelect.innerHTML = otherProjects
                    .map(p => `<option value="${p.id}">${p.projectName}</option>`)
                    .join('');
                document.getElementById('confirm-move-quiz-btn').disabled = false;

            } catch (error) {
                console.error("Error fetching projects for move:", error);
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÑ‡∏î‡πâ");
                moveQuizModal.classList.add('hidden');
            }
        }

        async function confirmMoveQuiz() {
            const newProjectId = document.getElementById('move-quiz-project-select').value;
            if (!newProjectId) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á");
                return;
            }
            if (!actionTargetId) return;

            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            try {
                await updateDoc(quizRef, { projectId: newProjectId });
                showMessage("‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                moveQuizModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                console.error("Error moving quiz:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
            }
        }

        async function handleQuizSettings(quizId) {
    actionTargetId = quizId;
    const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
    try {
        const quizSnap = await getDoc(quizRef);
        if (quizSnap.exists()) {
            const quizData = quizSnap.data();
            const settings = quizData.settings || {};
            const totalQuestions = quizData.questions.length;
            
            document.getElementById('modal-shuffle-select').value = settings.shuffle || 'none';
            document.getElementById('modal-results-display-select').value = settings.resultsDisplay || 'show_results_and_answers';
            document.getElementById('modal-timer-mode-select').value = settings.timerMode || 'none';
            document.getElementById('modal-timer-duration-input').value = settings.timerDuration || 10;
            document.getElementById('modal-passing-score-input').value = settings.passingScore || Math.floor(totalQuestions / 2);
            document.getElementById('modal-passing-score-input').max = totalQuestions;
            
            // --- ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ---
            document.getElementById('modal-adaptive-quiz-checkbox').checked = settings.isAdaptive || false;
            
            document.getElementById('modal-timer-mode-select').dispatchEvent(new Event('change'));

            quizSettingsModal.classList.remove('hidden');
        } else {
            showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
        }
    } catch (error) {
        console.error("Error fetching quiz settings:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    }
}

        async function confirmQuizSettings() {
            if (!actionTargetId) return;
            
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            
            const newSettings = {
                shuffle: document.getElementById('modal-shuffle-select').value,
                resultsDisplay: document.getElementById('modal-results-display-select').value,
                timerMode: document.getElementById('modal-timer-mode-select').value,
                timerDuration: parseInt(document.getElementById('modal-timer-duration-input').value) || 10,
                passingScore: parseInt(document.getElementById('modal-passing-score-input').value) || 0,
            passingScore: parseInt(document.getElementById('modal-passing-score-input').value) || 0,
    isAdaptive: document.getElementById('modal-adaptive-quiz-checkbox').checked // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Checkbox ID ‡∏Ç‡∏≠‡∏á Modal
};

            try {
                await updateDoc(quizRef, {
                    settings: newSettings
                });
                showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                quizSettingsModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                console.error("Error updating quiz settings:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            }
        }

                async function handleQuizStatus(quizId) {
            actionTargetId = quizId;
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
            try {
                const quizSnap = await getDoc(quizRef);
                if (quizSnap.exists()) {
                    const data = quizSnap.data();
                    const status = data.status || 'active';
                    const optionsContainer = document.getElementById('quiz-status-options');
                    const startContainer = document.getElementById('quiz-schedule-start-container');
                    const endContainer = document.getElementById('quiz-schedule-end-container');
                    
                    let optionsHtml = `
                        <div><input type="radio" name="status-option" value="active" id="status-active" ${status === 'active' ? 'checked' : ''}> <label for="status-active">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active)</label></div>
                        <div><input type="radio" name="status-option" value="inactive" id="status-inactive" ${status === 'inactive' ? 'checked' : ''}> <label for="status-inactive">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Inactive)</label></div>
                        <div><input type="radio" name="status-option" value="schedule" id="status-schedule" ${status === 'scheduled' ? 'checked' : ''}> <label for="status-schedule">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î (Schedule)</label></div>
                    `;
                    
                    optionsContainer.innerHTML = optionsHtml;
                    
                    const showSchedule = status === 'scheduled';
                    startContainer.classList.toggle('hidden', !showSchedule);
                    endContainer.classList.toggle('hidden', !showSchedule);
                    document.getElementById('quiz-start-time').value = data.startTime ? data.startTime.substring(0, 16) : '';
                    document.getElementById('quiz-end-time').value = data.endTime ? data.endTime.substring(0, 16) : '';


                    optionsContainer.querySelectorAll('input[name="status-option"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            const show = e.target.value === 'schedule';
                            startContainer.classList.toggle('hidden', !show);
                            endContainer.classList.toggle('hidden', !show);
                        });
                    });

                    quizStatusModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching quiz status:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
            }
        }

        async function confirmQuizStatus() {
            if (!actionTargetId) return;
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            const selectedOption = document.querySelector('input[name="status-option"]:checked');
            
            if (!selectedOption) {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
                return;
            }

            const statusChoice = selectedOption.value;
            let dataToUpdate = {};

            if (statusChoice === 'active' || statusChoice === 'inactive') {
                dataToUpdate = { status: statusChoice, startTime: null, endTime: null };
            } else if (statusChoice === 'schedule') {
                const startTime = document.getElementById('quiz-start-time').value;
                const endTime = document.getElementById('quiz-end-time').value;
                if (!startTime && !endTime) {
                    showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á");
                    return;
                }
                dataToUpdate = { 
                    status: 'scheduled', 
                    startTime: startTime ? new Date(startTime).toISOString() : null,
                    endTime: endTime ? new Date(endTime).toISOString() : null
                };
            }

            try {
                await updateDoc(quizRef, dataToUpdate);
                showMessage("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                quizStatusModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                 console.error("Error updating quiz status:", error);
                 showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞");
            }
        }

        // --- Leaderboard ---
        function listenForStudentProfiles(projectId) {
            const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${projectId}/studentProfiles`);
            unsubscribeStudentProfilesListener = onSnapshot(profilesRef, (snapshot) => {
                const profiles = snapshot.docs.map(doc => doc.data());
                renderLeaderboard(profiles, 'leaderboard-table-body');
            }, (error) => {
                console.error("Error listening for student profiles:", error);
                document.getElementById('leaderboard-table-body').innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ô‡∏≥</td></tr>';
            });
        }

        function renderLeaderboard(profiles, tableBodyId) {
            const tableBody = document.getElementById(tableBodyId);
            if (!profiles || profiles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥</td></tr>';
                return;
            }

            // --- Advanced Ranking ---
            profiles.sort((a, b) => {
                // 1. Primary: Total Points
                const pointsDiff = (b.totalPoints || 0) - (a.totalPoints || 0);
                if (pointsDiff !== 0) return pointsDiff;

                // 2. Secondary: Number of Specialist (üë©‚ÄçüöÄ) badges
                const specialistDiff = (b.badgesCount?.specialist || 0) - (a.badgesCount?.specialist || 0);
                if (specialistDiff !== 0) return specialistDiff;

                // 3. Tertiary: Number of First Try Ace (üöÄ) badges
                const firstTryAceDiff = (b.badgesCount?.first_try_ace || 0) - (a.badgesCount?.first_try_ace || 0);
                if (firstTryAceDiff !== 0) return firstTryAceDiff;

                // 4. Quaternary: Number of Perfect Score (üëë) badges
                const perfectScoreDiff = (b.badgesCount?.perfect_score || 0) - (a.badgesCount?.perfect_score || 0);
                if (perfectScoreDiff !== 0) return perfectScoreDiff;
                
                // 5. Quinary: Number of Quick Thinker (‚ö°Ô∏è) badges
                const quickThinkerDiff = (b.badgesCount?.quick_thinker || 0) - (a.badgesCount?.quick_thinker || 0);
                if (quickThinkerDiff !== 0) return quickThinkerDiff;

                // 6. Final: Alphabetical by name
                return a.studentName.localeCompare(b.studentName, 'th');
            });

            let html = '';
            profiles.forEach((profile, index) => {
                const rank = index + 1;
                const badgesCount = profile.badgesCount || {};

                let badgesHTML = '';
                const badgeOrder = ['specialist', 'perfect_score', 'first_try_ace', 'quick_thinker'];

                badgeOrder.forEach(badgeId => {
                    if (badgesCount[badgeId] > 0) {
                        const badgeInfo = Object.values(BADGES).find(b => b.id === badgeId);
                        if (badgeInfo) {
                            if (badgeId === 'specialist') {
                                // For specialist, just show the icon
                                badgesHTML += `
                                    <span class="inline-flex items-center mx-1" title="${badgeInfo.name}">
                                        <i class="fas ${badgeInfo.icon} text-lg"></i>
                                    </span>
                                `;
                            } else {
                                // For others, show icon and count
                                badgesHTML += `
                                    <span class="inline-flex items-center mx-1" title="${badgeInfo.name} (${badgesCount[badgeId]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)">
                                        <i class="fas ${badgeInfo.icon} text-lg"></i>
                                        <span class="ml-1 text-sm font-semibold">${badgesCount[badgeId]}</span>
                                    </span>
                                `;
                            }
                        }
                    }
                });

                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-center font-bold">${rank}</td>
                        <td class="py-2 px-4 border-b">${profile.studentName}</td>
                        <td class="py-2 px-4 border-b text-center font-semibold text-indigo-600">${profile.totalPoints || 0}</td>
                        <td class="py-2 px-4 border-b">${badgesHTML || '-'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        // NEW: Render Quiz-specific Leaderboard
        // --- ‡∏ô‡∏≥‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderQuizLeaderboard ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
function renderQuizLeaderboard(submissions, quizData, tableBodyId) {
    const tableBody = document.getElementById(tableBodyId);
    const isStudentView = tableBodyId === 'student-quiz-leaderboard-table-body';
    const totalQuestions = quizData.questions.length;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ ---
    const table = document.getElementById(tableBodyId).closest('table');
    if (table && !isStudentView) {
        const thead = table.querySelector('thead');
        thead.innerHTML = `
            <tr class="bg-gray-100">
                <th class="py-2 px-4 border-b text-center w-16">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                <th class="py-2 px-4 border-b text-left sortable-header" data-sort="studentName" style="cursor: pointer;">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                <th class="py-2 px-4 border-b text-center sortable-header" data-sort="bestScore" style="cursor: pointer;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</th>
                <th class="py-2 px-4 border-b text-center">‡∏ú‡∏•</th>
                <th class="py-2 px-4 border-b text-center sortable-header" data-sort="points" style="cursor: pointer;">Points (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
                <th class="py-2 px-4 border-b text-center sortable-header" data-sort="attempts" style="cursor: pointer;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥</th>
                <th class="py-2 px-4 border-b text-left sortable-header" data-sort="latestSubmittedAt" style="cursor: pointer;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                <th class="py-2 px-4 border-b text-left">‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
            </tr>
        `;
    }

    if (!submissions || submissions.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${isStudentView ? 6 : 8}" class="text-center p-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</td></tr>`;
        return;
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô Logic ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ---
    const submissionsCopy = [...submissions]; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
    submissionsCopy.sort((a, b) => {
        let valA, valB;
        switch (quizLeaderboardSortBy) {
            case 'studentName':
                valA = a.studentName || '';
                valB = b.studentName || '';
                return quizLeaderboardSortOrder === 'asc' ? valA.localeCompare(valB, 'th') : valB.localeCompare(valA, 'th');
            case 'points':
                valA = a.points || 0;
                valB = b.points || 0;
                break;
            case 'attempts':
                valA = a.attempts?.length || 1;
                valB = b.attempts?.length || 1;
                break;
            case 'latestSubmittedAt':
                valA = new Date(a.latestSubmittedAt);
                valB = new Date(b.latestSubmittedAt);
                break;
            case 'bestScore':
            default:
                valA = a.bestScore;
                valB = b.bestScore;
                break;
        }
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (valA < valB) return quizLeaderboardSortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return quizLeaderboardSortOrder === 'asc' ? 1 : -1;
        return 0; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
    });


    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const isRemedialQuiz = quizData.isRemedial === true;
    const passingScore = quizData.settings?.passingScore ?? -1;
    let html = '';
    submissionsCopy.forEach((sub, index) => {
        const rank = index + 1;
        let resultHtml = '<td class="py-2 px-4 border-b text-center">-</td>';
        if (isRemedialQuiz || passingScore !== -1) {
            let isPass = isRemedialQuiz ? (sub.bestScore === totalQuestions) : (sub.bestScore >= passingScore);
            const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const resultText = isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
            resultHtml = `<td class="py-2 px-4 border-b text-center"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${resultClass}">${resultText}</span></td>`;
        }
        const latestAttempt = sub.attempts[sub.attempts.length - 1];
        const badgesHTML = (latestAttempt.badges || [])
            .map(badgeId => {
                const badgeInfo = Object.values(BADGES).find(b => b.id === badgeId);
                return badgeInfo ? `<span title="${badgeInfo.name}"><i class="fas ${badgeInfo.icon} mx-1 text-lg"></i></span>` : '';
            }).join('');
        html += `
            <tr class="hover:bg-gray-50">
                <td class="py-2 px-4 border-b text-center font-bold">${rank}</td>
                <td class="py-2 px-4 border-b">${sub.studentName}</td>
                <td class="py-2 px-4 border-b text-center font-bold text-green-600">${sub.bestScore} / ${totalQuestions}</td>
                ${resultHtml}
                <td class="py-2 px-4 border-b text-center font-semibold text-blue-600">${sub.points || 0}</td>
                ${isStudentView ? "" : `<td class="py-2 px-4 border-b text-center">${sub.attempts?.length || 1}</td>`}
                ${isStudentView ? "" : `<td class="py-2 px-4 border-b text-sm text-gray-600">${new Date(sub.latestSubmittedAt).toLocaleString('th-TH')}</td>`}
                <td class="py-2 px-4 border-b">${badgesHTML || '-'}</td>
            </tr>
        `;
    });
    tableBody.innerHTML = html;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ‚ñ≤ ‚ñº ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ---
    if (table && !isStudentView) {
        table.querySelectorAll('thead .sortable-header').forEach(th => {
            const indicator = th.querySelector('.sort-indicator');
            if (indicator) indicator.remove(); // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
            if (th.dataset.sort === quizLeaderboardSortBy) {
                th.innerHTML += `<span class="sort-indicator ml-2">${quizLeaderboardSortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>`;
            }
        });
    }
}

        // --- Student Flow ---
        async function handleLoadQuiz() {
    const quizIdInput = document.getElementById('quiz-id-input');
    const quizId = quizIdInput.value.trim();
    if (!quizId) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
        return;
    }

    loadQuizBtn.disabled = true;
    loadQuizBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

    try {
        const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
        const quizDocSnap = await getDoc(quizDocRef);

        if (!quizDocSnap.exists()) {
            showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ");
            return;
        }

        currentQuizData = { id: quizDocSnap.id, ...quizDocSnap.data() };

        // Check Quiz Status
        const status = currentQuizData.status || 'active';
        const now = new Date();
        if (status === 'inactive') {
            showMessage("‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà");
            return;
        }
        if (status === 'scheduled') {
            const startTime = currentQuizData.startTime ? new Date(currentQuizData.startTime) : null;
            const endTime = currentQuizData.endTime ? new Date(currentQuizData.endTime) : null;
            
            if (startTime && now < startTime) {
                showMessage(`‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${startTime.toLocaleString('th-TH', { hour12: false })}`);
                return;
            }
            if (endTime && now > endTime) {
                showMessage("‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }
        }
        
        const projectId = currentQuizData.projectId;
        currentProjectId = projectId;   // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
        const projectDocRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
        const projectDocSnap = await getDoc(projectDocRef);

        if (!projectDocSnap.exists()) {
            showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ");
            return;
        }
        
        const projectData = projectDocSnap.data();
        currentStudentProjectData = projectData; 
        displayStudentNameSelector(projectData.students, currentQuizData.topic);

    } catch (error) {
        console.error("Error loading quiz for student:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
    } finally {
        loadQuizBtn.disabled = false;
        loadQuizBtn.innerHTML = '<i class="fas fa-search mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö';
    }
}

async function handleJoinLiveGame() {
    const pinInput = document.getElementById('game-pin-input');
    const nicknameInput = document.getElementById('nickname-input');
    const joinBtn = document.getElementById('confirm-join-game-btn');

    const gamePin = pinInput.value.trim();
    const nickname = nicknameInput.value.trim();

    if (!gamePin || !nickname) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
    }

    joinBtn.disabled = true;
    joinBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...';

    try {
        // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢ PIN ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ status
        const gamesRef = collection(db, `artifacts/${appId}/public/data/liveGames`);
        const q = query(gamesRef, where("gamePin", "==", gamePin), where("status", "==", "lobby"));
        const gameSnapshot = await getDocs(q);

        if (gameSnapshot.empty) {
            showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            return;
        }

        const gameDoc = gameSnapshot.docs[0];
        const gameData = gameDoc.data();
        
        currentLiveGameId = gameDoc.id;
        
        // Pre-fetch the quiz data as soon as the student joins
        const quizId = gameData.quizId;
        const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
        const quizDocSnap = await getDoc(quizDocRef);
        if (!quizDocSnap.exists()) {
            showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ");
            return;
        }
        currentQuizData = { id: quizDocSnap.id, ...quizDocSnap.data() };

        // Check if nickname already exists
        if (gameData.players && gameData.players[nickname]) {
            showMessage("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô");
            return;
        }

        // Add player to the game
        const playerUpdate = {};
        playerUpdate[`players.${nickname}`] = {
            score: 0,
            answered: false,
            badges: [],
            correctStreak: 0
        };
        await updateDoc(doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId), playerUpdate);

        // Switch to waiting/game view for the student
        currentStudentName = nickname;
        listenForLiveGameUpdates();

    } catch (error) {
        console.error("Error joining live game:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°");
    } finally {
        joinBtn.disabled = false;
        joinBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°';
    }
}

        function displayStudentNameSelector(students, topic) {
            const studentNameSelect = document.getElementById('student-name-select');
            document.getElementById('student-quiz-topic').textContent = `‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${topic}`;
            
            if (!students || students.length === 0) {
                studentNameSelect.innerHTML = `<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ</option>`;
                startQuizBtn.disabled = true;
            } else {
                studentNameSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ --</option>';
                students.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    studentNameSelect.appendChild(option);
                });
                startQuizBtn.disabled = false;
            }

            studentInitialView.classList.add('hidden');
            studentNameSelectionView.classList.remove('hidden');
        }

        // Helper to shuffle arrays
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
		
		/**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
         * @param {object} originalQuizData - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
         * @returns {object} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
         */
        function getShuffledQuiz(originalQuizData) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
            let processedQuiz = JSON.parse(JSON.stringify(originalQuizData)); 
            const shuffleSetting = processedQuiz.settings?.shuffle || 'none';

            if (shuffleSetting === 'none') {
                return processedQuiz; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏•‡∏±‡∏ö ‡∏Å‡πá‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
            }

            // 1. ‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ)
            if (shuffleSetting === 'questions_only' || shuffleSetting === 'both') {
                shuffleArray(processedQuiz.questions);
            }

            // 2. ‡∏™‡∏•‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ)
            if (shuffleSetting === 'choices_only' || shuffleSetting === 'both') {
                processedQuiz.questions.forEach(q => {
                    const questionType = q.questionType || processedQuiz.quizType;
                    // ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Multiple Choice
                    if (q.options) { 
                        let optionsToShuffle = q.options.map((opt, index) => ({
                            text: opt,
                            isCorrect: index === q.correctAnswerIndex
                        }));
                        shuffleArray(optionsToShuffle);
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï options ‡πÅ‡∏•‡∏∞ correctAnswerIndex ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                        q.options = optionsToShuffle.map(opt => opt.text);
                        q.correctAnswerIndex = optionsToShuffle.findIndex(opt => opt.isCorrect);
                    }
                    // ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Matching
                    if (questionType === 'matching_item' && q.allResponses) {
                        shuffleArray(q.allResponses);
                    }
                });
            }
            
            return processedQuiz;
        }

        function displayQuizForStudent(quizData) {
            studentQuizArea.classList.remove('hidden');
            
            // --- ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
            currentDisplayedQuiz = getShuffledQuiz(quizData);

            // *** NEW: Timer Logic ***
            const timerMode = currentDisplayedQuiz.settings?.timerMode || 'none';
            if (timerMode === 'whole_quiz') {
                renderFullQuizForm();
                startWholeQuizTimer(currentDisplayedQuiz.settings.timerDuration);
            } else if (timerMode === 'per_question') {
                currentQuestionIndex = 0;
                studentAnswersPerQuestion = [];
                renderPerQuestionView();
            } else {
                renderFullQuizForm();
            }
        }
        
        function renderFullQuizForm() {
            let html = `
                 <div id="timer-container" class="mb-4"></div>
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xl font-bold">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${currentDisplayedQuiz.topic}</h3>
                     ${currentMode === 'admin-testing' ? '<button id="cancel-test-btn" class="text-sm text-gray-500 hover:text-red-600 font-semibold py-1 px-2 rounded-md hover:bg-red-50"><i class="fas fa-times-circle mr-1"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>' : ''}
                 </div>
                 <form id="quiz-form">
            `;
            currentDisplayedQuiz.questions.forEach((q, questionIndex) => {
                const questionType = q.questionType || currentDisplayedQuiz.quizType;
                html += `
                    <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <div class="font-semibold mb-3">
                `;

                // Adjust display for matching_item
                if (questionType === 'matching_item') {
                    // ... ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderFullQuizForm, ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á case 'matching_item'
html += `
    <div class="flex items-center gap-4">
        <div class="w-1/2">${questionIndex + 1}. ${q.stem}</div>
        <div class="w-1/2">
            <select name="question${questionIndex}" class="w-full p-2 border border-gray-300 rounded-lg" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö --</option>
                ${q.allResponses.map(resp => `<option value="${resp}">${resp}</option>`).join('')}
            </select>
        </div>
    </div>
`;
                } else {
                    html += `<p>${questionIndex + 1}. ${q.instructions || q.questionText}</p>`;
                    if (q.imageCode) {
                        html += `<div class="my-4 flex justify-center">${q.imageCode}</div>`;
                    }
                }
                
                html += `</div><div class="space-y-2">`;
                
                switch(questionType) {
                    case 'short_answer':
                        html += `<textarea name="question${questionIndex}" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" required></textarea>`;
                        break;
                    case 'true_false':
                        html += `<div><input type="radio" id="q${questionIndex}_opt0" name="question${questionIndex}" value="true" class="mr-2 accent-indigo-600" required><label for="q${questionIndex}_opt0">‡πÉ‡∏ä‡πà</label></div>`;
                        html += `<div><input type="radio" id="q${questionIndex}_opt1" name="question${questionIndex}" value="false" class="mr-2 accent-indigo-600" required><label for="q${questionIndex}_opt1">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</label></div>`;
                        break;
                    case 'matching_item':
                        // The HTML is already rendered above, so we do nothing here.
                        break;
                    case 'fill_in_the_blank':
                    case 'multiple_choice':
                    default:
                        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
html += q.options.map((opt, i) => `
    <div>
        <input type="radio" id="q${questionIndex}_opt${i}" name="question${questionIndex}" value="${i}" class="mr-2 accent-indigo-600" required>
        <label for="q${questionIndex}_opt${i}">${opt}</label>
    </div>
`).join('');
// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏≤‡∏Å q.options ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á input radio ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        break;
                }

                html += `
                        </div>
                    </div>
                `;
            });
            html += `<button type="submit" class="w-full mt-4 bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700">
                         <i class="fas fa-check-circle mr-2"></i>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                        </button>`;
            html += `</form>`;
            studentQuizArea.innerHTML = html;
            
            if (currentMode === 'admin-testing') {
                const cancelBtn = document.getElementById('cancel-test-btn');
                if(cancelBtn) cancelBtn.addEventListener('click', cancelAdminTest);
            }

            document.getElementById('quiz-form').addEventListener('submit', handleSubmitQuiz);
            if (window.MathJax) window.MathJax.typesetPromise([studentQuizArea]);
        }

        async function handleSubmitQuiz(event) {
            if(event) event.preventDefault();
            if(quizTimerInterval) clearInterval(quizTimerInterval); // Stop timer on manual submit
            
            const form = document.getElementById('quiz-form');
            if (!form) return; // Form might not exist if timer auto-submits
            
            const submitButton = form.querySelector('button[type="submit"]');
            const hasShortAnswer = currentDisplayedQuiz.questions.some(q => q.questionType === 'short_answer');

            if(submitButton) {
                submitButton.disabled = true;
                if(hasShortAnswer) {
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...';
                } else {
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...';
                }
            }
            
            const formData = new FormData(form);
            
            const userAnswers = currentDisplayedQuiz.questions.map((q, questionIndex) => {
                const questionType = q.questionType || currentDisplayedQuiz.quizType;
                const answer = formData.get(`question${questionIndex}`);
                if (answer !== null && answer !== undefined) {
                    if (questionType === 'multiple_choice' || questionType === 'fill_in_the_blank') return parseInt(answer);
                    return answer;
                }
                return null; // No answer provided
            });
            
            // Get previous submissions to calculate new badges
            const quizId = currentQuizData.id;
            const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, currentStudentName);
            const submissionSnap = await getDoc(submissionRef);
            const existingData = submissionSnap.exists() ? submissionSnap.data() : {};
            const previousAttempts = existingData.attempts || [];

            await processAndSubmitAnswers(userAnswers, previousAttempts);
        }
        
        async function gradeShortAnswerWithAI(userAnswer, idealAnswer) {
            if (!userAnswer || !idealAnswer) return false;
            try {
                const prompt = `Please evaluate if the user's answer is correct based on the ideal answer. The context is a simple quiz, so be lenient with phrasing but strict with the core concept. User Answer: "${userAnswer}". Ideal Answer: "${idealAnswer}". Respond with only "true" or "false".`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyBgBJ28OshxBTnqUzCKsv7nve2Xj899fwA"; // API key will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('API call failed');
                
                const result = await response.json();
                const textResponse = result.candidates[0].content.parts[0].text.trim().toLowerCase();
                return textResponse === 'true';

            } catch (error) {
                console.error("AI grading failed:", error);
                return false; // Default to incorrect if AI fails
            }
        }


        async function processAndSubmitAnswers(userAnswers, previousAttempts) {
    let score = 0;
    let points = 0;
    let earnedBadges = [];
    const detailedAnswers = [];
    const totalQuestions = currentDisplayedQuiz.questions.length;

    // --- Gamification Logic ---
    let correctStreak = 0;

    const questions = currentDisplayedQuiz.questions;
    for (let i = 0; i < questions.length; i++) {
        const q = questions[i];
        const userAnswer = userAnswers[i];
        const questionType = q.questionType || currentDisplayedQuiz.quizType;
        let isCorrect = false;

        if (userAnswer !== null && userAnswer !== "") {
            switch (questionType) {
                case 'matching_item':
                    isCorrect = userAnswer === q.correctResponse;
                    break;
                case 'true_false':
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô boolean ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
                    const userBool = (userAnswer === true || userAnswer === 'true');
                    isCorrect = (userBool === q.correctAnswer);
                    break;

                case 'fill_in_the_blank':
                case 'multiple_choice':
                default:
                    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ "1" vs 1
                    isCorrect = (Number(userAnswer) === q.correctAnswerIndex);
                    break;

                 case 'short_answer':
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
                    isCorrect = await gradeShortAnswer(userAnswer, q);
                    break;
            }
        }

        if (isCorrect) {
            score++;
            correctStreak++;
            if (correctStreak === 3) {
                earnedBadges.push(BADGES.ON_FIRE.id);
                correctStreak = 0;
            }
        } else {
            correctStreak = 0; // Reset streak on incorrect answer
        }
        
        // --- [‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ---
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° originalQuestionText ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠
        detailedAnswers.push({
            answer: userAnswer,
            isCorrect: isCorrect,
            originalQuestionText: q.stem || q.questionText
        });
    }

    points = score * 10; // Base points
    if (score === totalQuestions && totalQuestions > 0 && !currentDisplayedQuiz.isRemedial) {
        points += 50; // Perfect score bonus
        earnedBadges.push(BADGES.PERFECT_SCORE.id);
    }
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? Math.floor(totalQuestions / 2);
    // Check for speed bonus if it was a timed quiz
    const timerMode = currentDisplayedQuiz.settings?.timerMode;
    if (timerMode === 'whole_quiz' && quizStartTime) {
        const timeTaken = (new Date() - quizStartTime) / 1000; // in seconds
        const timeAllowed = currentDisplayedQuiz.settings.timerDuration * 60;
        if (score >= passingScore && timeTaken < timeAllowed / 2) {
            points += 20; // Speed bonus
            earnedBadges.push(BADGES.QUICK_THINKER.id);
        }
    }
    // --- Badge Logic for new badges ---

    // 1. First-Try Ace: Perfect score on the very first attempt.
    if (previousAttempts.length === 0 && score === totalQuestions && totalQuestions > 0) {
        earnedBadges.push(BADGES.FIRST_TRY_ACE.id);
    }

    // 2. Comeback King: Failed the first time, but passed this time.
    if (previousAttempts.length > 0) {
        const firstAttemptScore = previousAttempts[0].score;
        if (firstAttemptScore < passingScore && score >= passingScore) {
            // Check if they haven't earned this badge for this quiz before
            const hasComebackBadge = previousAttempts.some(attempt =>
                (attempt.badges || []).includes(BADGES.COMEBACK_KING.id)
            );
            if (!hasComebackBadge) {
                earnedBadges.push(BADGES.COMEBACK_KING.id);
            }
        }
    }
    // 3. Perseverance: Awarded on the 5th attempt
    if (previousAttempts.length === 4) { // This is the 5th attempt (0-indexed)
        earnedBadges.push(BADGES.PERSEVERANCE.id);
    }
    // In admin test mode, use the project's current settings for display
    const displaySetting = currentDisplayedQuiz.settings.resultsDisplay;

    if (currentMode === 'admin-testing') {
        handleResultDisplay(displaySetting, score, points, earnedBadges, detailedAnswers, totalQuestions);
        return;
    }

    const quizId = currentQuizData.id;
    const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, currentStudentName);

    try {
        const attempts = [...previousAttempts]; // Create a mutable copy
        const newAttempt = {
            score: score,
            points: points,
            badges: earnedBadges,
            submittedAt: new Date().toISOString(),
            answers: detailedAnswers
        };
        attempts.push(newAttempt);

        const firstScore = attempts[0].score;
        const bestScore = Math.max(...attempts.map(a => a.score));
        const latestScore = score;
        const latestSubmittedAt = newAttempt.submittedAt;

        await setDoc(submissionRef, {
            studentName: currentStudentName,
            totalQuestions: totalQuestions,
            attempts: attempts,
            firstScore: firstScore,
            bestScore: bestScore,
            latestScore: latestScore,
            points: points, // Store points from the latest attempt
            latestSubmittedAt: latestSubmittedAt
        });

        // Update the aggregated student profile for the leaderboard
        await updateStudentProfile(currentQuizData.projectId, currentStudentName);
        handleResultDisplay(displaySetting, score, points, earnedBadges, detailedAnswers, totalQuestions);
    } catch (error) {
        console.error("Error saving submission:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
    }
}
        
        async function updateStudentProfile(projectId, studentName) {
    const profileRef = doc(db, `artifacts/${appId}/public/data/projects/${projectId}/studentProfiles`, studentName);

    try {
        // 1. Get all quizzes in the project (outside the transaction is fine)
        const quizzesQuery = query(
            collection(db, `artifacts/${appId}/public/data/quizzes`),
            where("projectId", "==", projectId)
        );
        const quizzesSnapshot = await getDocs(quizzesQuery);
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô transaction
        const quizzesDataMap = new Map(quizzesSnapshot.docs.map(doc => [doc.id, doc.data()]));
        const quizIds = Array.from(quizzesDataMap.keys());

        // 2. Start a transaction to read all submissions and write the new profile
        await runTransaction(db, async (transaction) => {
            let calculatedTotalPoints = 0;
            const finalBadgesCount = {};
            let allQuizzesPerfect = true;
            let mainQuizzesSubmittedCount = 0;
            let totalMainQuizzes = 0;

            // 3. Loop through each quiz to aggregate points and badges
            for (const quizId of quizIds) {
                const quizData = quizzesDataMap.get(quizId);
                const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, studentName);
                const submissionDoc = await transaction.get(submissionRef);

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Total Points) ---
                if (submissionDoc.exists()) {
                    const submissionData = submissionDoc.data();
                    const attempts = submissionData.attempts || [];
                    if (attempts.length > 0) {
                        // ‡∏´‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Points
                        const bestAttempt = attempts.reduce((best, current) => {
                            if (current.score > best.score) return current;
                            if (current.score === best.score) {
                                return (current.points || 0) > (best.points || 0) ? current : best;
                            }
                            return best;
                        }, { score: -1, points: -1 });

                        if (bestAttempt.score > -1) {
                            calculatedTotalPoints += bestAttempt.points || 0;
                            (bestAttempt.badges || []).forEach(badgeId => {
                                finalBadgesCount[badgeId] = (finalBadgesCount[badgeId] || 0) + 1;
                            });
                        }
                    }
                }

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (Specialist Badge) ---
                // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°)
                 if (quizData.topic !== "‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°") {
                    totalMainQuizzes++; // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    if (submissionDoc.exists()) {
                        mainQuizzesSubmittedCount++;
                        const submissionData = submissionDoc.data();
                        if (submissionData.bestScore !== submissionData.totalQuestions) {
                            allQuizzesPerfect = false; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏°‡πâ‡πÅ‡∏ï‡πà‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ
                        }
                    } else {
                        allQuizzesPerfect = false; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ
                    }
                }
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç
            if (totalMainQuizzes > 0 && mainQuizzesSubmittedCount === totalMainQuizzes && allQuizzesPerfect) {
                finalBadgesCount['specialist'] = 1;
            } else {
                finalBadgesCount['specialist'] = 0;
            }
            
            // 4. Update the student's profile with the newly calculated totals
            transaction.set(profileRef, {
                studentName: studentName,
                totalPoints: calculatedTotalPoints,
                unlockedBadges: Object.keys(finalBadgesCount).filter(key => finalBadgesCount[key] > 0),
                badgesCount: finalBadgesCount
            }, { merge: true });
        });

    } catch (error) {
        console.error("Leaderboard update transaction failed: ", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ô‡∏≥");
    }
}


        function startAdminTest() {
            if (!currentQuizData) {
                showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á");
                return;
            }

            // Create a temporary, deep copy of the quiz data for the test.
            // This copy already contains the correct settings from the quiz itself.
            let testQuizData = JSON.parse(JSON.stringify(currentQuizData));
            
            currentMode = 'admin-testing';
            currentStudentName = '‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (‡∏ó‡∏î‡∏™‡∏≠‡∏ö)';

            adminView.classList.add('hidden');
            studentView.classList.remove('hidden');
            studentInitialView.classList.add('hidden');
            studentNameSelectionView.classList.add('hidden');
            studentResultArea.classList.add('hidden');
            studentQuizArea.classList.remove('hidden');
            
            quizStartTime = new Date(); // Record start time for admin test
            // Pass the quiz data to the display function.
            displayQuizForStudent(testQuizData);
        }

        function handleResultDisplay(displaySetting, score, points, earnedBadges, detailedAnswers, totalQuestions) {
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà
            const passingScore = currentDisplayedQuiz.settings?.passingScore ?? Math.floor(totalQuestions / 2);
            const isAdaptive = currentDisplayedQuiz.settings?.isAdaptive ?? false;

            // --- ‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isAdaptive && score < passingScore) {
                startAdaptiveFlow(detailedAnswers, score, totalQuestions); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°
                return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
            }

            // --- Logic ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° ---
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô ‡∏Å‡πá‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
            switch(displaySetting) {
                case 'show_results_and_answers':
                    displayResultsWithAnswers(score, points, earnedBadges, detailedAnswers, totalQuestions);
                    break;
                case 'show_results_only':
                    displayResultsScoreOnly(score, points, earnedBadges, totalQuestions);
                    break;
                case 'show_pass_fail_only':
                    displayPassFailOnly(score, totalQuestions);
                    break;
                case 'manual_release':
                default:
                    displaySubmissionConfirmation();
                    break;
            }
        }
		
async function startAdaptiveFlow(detailedAnswers, score, totalQuestions) {
    // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° "‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô" ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î
    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
    const weaknessExplanations = detailedAnswers
        .map((ans, index) => ({ ...ans, originalQuestion: currentDisplayedQuiz.questions[index] }))
        .filter(item => !item.isCorrect && item.originalQuestion.explanation) // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
        .map(item => `- ${item.originalQuestion.explanation}`)
        .join('\n');

    // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    if (!weaknessExplanations) {
        displayResultsScoreOnly(score, 0, [], totalQuestions);
        return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    studentQuizArea.classList.add('hidden');
    studentReadingArea.classList.remove('hidden');
    studentReadingArea.innerHTML = `
        <div class="text-center p-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞...</p>
        </div>
    `;

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°
    const remedialPrompt = `
        ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${currentDisplayedQuiz.topic}" ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
        ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î:
        ${weaknessExplanations}

        ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
        ‡πÉ‡∏´‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏à‡∏î‡∏µ
        ‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ

        ‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏°‡∏µ key ‡∏ä‡∏∑‡πà‡∏≠ "remedialContent" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    `;

    // 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Schema ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á AI
    const remedialSchema = {
        type: "OBJECT",
        properties: {
            remedialContent: { type: "STRING" }
        },
        required: ["remedialContent"]
    };

    try {
        // 4. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°
        const result = await callAnalysisApi(remedialPrompt, remedialSchema);
        const remedialContent = result.remedialContent;

        // 5. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°
        studentReadingArea.innerHTML = `
            <div class="p-6 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg">
                <h3 class="text-xl font-bold text-amber-800">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ô‡∏∞!</h3>
                <p class="mt-2 text-gray-700">${remedialContent.replace(/\n/g, '<br>')}</p>
                <button id="start-remedial-quiz-btn" class="mt-4 bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á!
                </button>
            </div>
        `;
        // 6. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        document.getElementById('start-remedial-quiz-btn').addEventListener('click', () => generateRemedialQuiz(weaknessExplanations));

    } catch (error) {
        console.error("Adaptive flow failed:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô");
        // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
        displayResultsScoreOnly(score, 0, [], totalQuestions);
    }
}

async function generateRemedialQuiz(weaknessExplanations) {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏≤‡∏ö
    studentReadingArea.innerHTML = `
        <div class="text-center p-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢! AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à...</p>
        </div>
    `;

    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°
    const remedialQuizPrompt = `
        ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à:
        ${weaknessExplanations}

        ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏ô‡∏±‡∏¢‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 2 ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 4 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å, ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á, ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ

        ‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
        - topic: (string) ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡πà‡∏≤ "‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°"
        - questions: (array of objects) ‡πÇ‡∏î‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞ object ‡∏°‡∏µ:
          - questionText: (string)
          - options: (array of 4 strings)
          - correctAnswerIndex: (number)
          - explanation: (string)
		  ${simpleMathPrompt}
    `;

    // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Schema ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (‡πÉ‡∏ä‡πâ mcqSchema ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ)
    const mcqSchema = {
        type: "OBJECT",
        properties: {
            questionText: { type: "STRING" },
            options: { type: "ARRAY", items: { type: "STRING" } },
            correctAnswerIndex: { type: "NUMBER" },
            explanation: { type: "STRING" }
        },
        required: ["questionText", "options", "correctAnswerIndex", "explanation"]
    };

    const remedialQuizSchema = {
        type: "OBJECT",
        properties: {
            topic: { type: "STRING" },
            questions: { type: "ARRAY", items: mcqSchema }
        },
        required: ["topic", "questions"]
    };

    try {
        // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleApiCall ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á Prompt ‡πÅ‡∏•‡∏∞ Schema ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        // ‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (admin) ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á
        const remedialQuizData = await callAnalysisApi(remedialQuizPrompt, remedialQuizSchema);
        remedialQuizData.isRemedial = true;

        // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≥
        studentReadingArea.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô
        
        // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ settings ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
        // ‡πÇ‡∏î‡∏¢‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å settings ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î adaptive ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥
        const newQuizSettings = {
            ...currentDisplayedQuiz.settings,
            isAdaptive: false, // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°
            resultsDisplay: 'show_results_and_answers' // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à
        };
        remedialQuizData.settings = newQuizSettings;
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°
        displayQuizForStudent(remedialQuizData);

    } catch (error) {
        console.error("Remedial quiz generation failed:", error);
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°");
        // ‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
        showView('student');
    }
}

function displayPassFailOnly(score, totalQuestions) {
            // Logic to determine pass/fail status
            const passingScore = currentDisplayedQuiz.settings?.passingScore ?? -1;
            const isRemedialQuiz = currentDisplayedQuiz.isRemedial === true;
            let passFailHTML = '';

            if (isRemedialQuiz || passingScore !== -1) {
                let isPass;
                if (isRemedialQuiz) {
                    isPass = (score === totalQuestions);
                } else {
                    isPass = score >= passingScore;
                }

                const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const resultText = isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
                
                passFailHTML = `<div class="my-4"><span class="text-4xl font-bold px-6 py-2 rounded-full inline-block ${resultClass}">${resultText}</span></div>`;
            } else {
                // Fallback if passing score is not set
                passFailHTML = `<p class="mt-4 text-gray-600">(‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ)</p>`;
            }

            // HTML for the result screen
            let resultHTML = `
                <div class="text-center p-8 bg-indigo-100 rounded-lg">
                    <i class="fas fa-award text-5xl text-indigo-500 mb-4"></i>
                    <p class="text-gray-600 mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö: <span class="font-semibold text-indigo-800">${currentStudentName}</span></p>
                    <h3 class="text-2xl font-bold text-indigo-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
                    <p class="text-gray-700 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:</p>
                    ${passFailHTML}
                </div>
            `;
            studentResultArea.innerHTML = resultHTML;
            studentResultArea.classList.remove('hidden');
            studentQuizArea.classList.add('hidden');
            
            const backButtonId = 'back-from-results-btn';
            const isTesting = currentMode === 'admin-testing';

            const buttonText = isTesting
                ? '<i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'
                : '<i class="fas fa-home mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å';
                
            const buttonHTML = `
                <div class="mt-6 pt-6 border-t flex items-center justify-center gap-4 w-full max-w-md mx-auto">
                    <button id="${backButtonId}" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                        ${buttonText}
                    </button>
                </div>
            `;
            
            studentResultArea.insertAdjacentHTML('beforeend', buttonHTML);

            document.getElementById(backButtonId).addEventListener('click', () => {
                if (isTesting) {
                    currentMode = 'admin';
                    studentView.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    showView('project-detail');
                } else {
                    showView('student');
                    document.getElementById('quiz-id-input').value = '';
                }
            });
        }

        function cancelAdminTest() {
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            
            currentMode = 'admin'; // Reset mode
            studentView.classList.add('hidden');
            adminView.classList.remove('hidden');
            showView('project-detail'); // Go back to where the admin was
        }

        function setupResultScreenBackButton() {
    const backButtonId = 'back-from-results-btn';
    const isTesting = currentMode === 'admin-testing';

    const buttonText = isTesting
        ? '<i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'
        : '<i class="fas fa-home mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å';

    // --- NEW: ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ---
    const buttonsHTML = `
        <div class="mt-6 pt-6 border-t flex flex-col sm:flex-row items-center justify-center gap-4 w-full max-w-md mx-auto">
            <button id="view-rankings-btn" class="w-full sm:w-auto flex-1 bg-yellow-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-yellow-600 flex items-center justify-center gap-2">
                <i class="fas fa-trophy"></i>‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
            </button>
            <button id="${backButtonId}" class="w-full sm:w-auto flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                ${buttonText}
            </button>
        </div>
    `;

    // --- NEW: ‡∏ô‡∏≥‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
    studentResultArea.insertAdjacentHTML('beforeend', buttonsHTML);

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
    studentResultArea.querySelector('#view-rankings-btn').addEventListener('click', handleShowStudentRankings);
    document.getElementById(backButtonId).addEventListener('click', () => {
        if (isTesting) {
            currentMode = 'admin';
            studentView.classList.add('hidden');
            adminView.classList.remove('hidden');
            showView('project-detail');
        } else {
            showView('student');
            document.getElementById('quiz-id-input').value = '';
        }
    });
}

        function displayResultsWithAnswers(score, points, earnedBadges, detailedAnswers, totalQuestions) {
    const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? -1;
    const isRemedialQuiz = currentDisplayedQuiz.isRemedial === true;
    let passFailHTML = '';

    if (isRemedialQuiz || passingScore !== -1) {
        let isPass = isRemedialQuiz ? (score === totalQuestions) : (score >= passingScore);
        const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const resultText = isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
        passFailHTML = `<p class="text-2xl font-bold mt-2 px-4 py-1 rounded-full inline-block ${resultClass}">${resultText}</p>`;
    }

    let resultHTML = `
        <div class="text-center p-6 bg-indigo-100 rounded-lg mb-6">
            <p class="text-gray-600 mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö: <span class="font-semibold text-indigo-800">${currentStudentName}</span></p>
            <h3 class="text-2xl font-bold text-purple-700 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
            <p class="text-4xl font-bold my-2">${score} <span class="text-xl font-normal text-gray-600">/ ${totalQuestions}</span></p>
            ${passFailHTML}
            <p class="text-lg font-semibold text-blue-600 mt-2">+${points} Points</p>
            <p class="text-md">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${percentage.toFixed(0)}%</p>
            <div id="earned-badges-container" class="mt-4 flex justify-center gap-4 flex-wrap"></div>
        </div>
        <h4 class="text-xl font-bold mb-4">‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</h4>
    `;

    currentDisplayedQuiz.questions.forEach((q, index) => {
        const detailedAnswer = detailedAnswers[index];
        const userAnswer = detailedAnswer.answer;
        const isCorrect = detailedAnswer.isCorrect;
        const questionType = q.questionType || currentDisplayedQuiz.quizType;

        resultHTML += `
            <div class="mb-4 p-4 border rounded-lg ${isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}">
                <p class="font-semibold">${index + 1}. ${q.stem || q.questionText}</p>
                <div class="mt-3 space-y-2 text-sm">
        `;
        
        switch(questionType) {
            case 'matching_item':
                const userResponseText = userAnswer || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö';
                const correctResponseText = q.correctResponse;
                resultHTML += `<p><strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</strong> <span class="${!isCorrect ? 'line-through text-red-700' : ''}">${userResponseText}</span></p>`;
                if (!isCorrect) {
                    resultHTML += `<p class="text-green-700"><strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</strong> ${correctResponseText}</p>`;
                }
                break;
            case 'short_answer':
                resultHTML += `<p><strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</strong> ${userAnswer || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö'}</p>`;
                resultHTML += `<p class="text-green-700"><strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°:</strong> ${q.idealAnswer}</p>`;
                break;
            case 'true_false':
                resultHTML += `<p class="${q.correctAnswer === true ? 'font-bold text-green-700' : ''} ${userAnswer === 'true' && !isCorrect ? 'line-through text-red-700' : ''}">‡πÉ‡∏ä‡πà</p>`;
                resultHTML += `<p class="${q.correctAnswer === false ? 'font-bold text-green-700' : ''} ${userAnswer === 'false' && !isCorrect ? 'line-through text-red-700' : ''}">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</p>`;
                break;
            case 'fill_in_the_blank':
            case 'multiple_choice':
            default:
                resultHTML += q.options.map((opt, i) => {
                    let style = '';
                    let icon = '';
                    if (i === q.correctAnswerIndex) {
                        style = 'font-bold text-green-700';
                        icon = '<i class="fas fa-check-circle mr-2 text-green-600"></i>';
                    } else if (i === userAnswer) {
                        style = 'font-bold text-red-700 line-through';
                        icon = '<i class="fas fa-times-circle mr-2 text-red-600"></i>';
                    }
                    return `<div class="${style}">${icon}${opt}</div>`;
                }).join('');
                break;
        }

        resultHTML += `
                </div>
                <div class="mt-3 p-3 bg-blue-50 border-l-4 border-blue-400 text-sm">
                    <strong class="text-blue-800">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> ${q.explanation || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}
                </div>
            </div>
        `;
    });
    
    studentResultArea.innerHTML = resultHTML;
    renderEarnedBadges(earnedBadges, 'earned-badges-container');
    studentResultArea.classList.remove('hidden');
    studentQuizArea.classList.add('hidden');
    
    setupResultScreenBackButton();

    if (window.MathJax) window.MathJax.typesetPromise([studentResultArea]);
}

function displayResultsScoreOnly(score, points, earnedBadges, totalQuestions) {
    const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ---
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? -1;
    const isRemedialQuiz = currentDisplayedQuiz.isRemedial === true;
    let passFailHTML = '';

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• "‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (isRemedialQuiz || passingScore !== -1) {
        let isPass;

        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô)
        if (isRemedialQuiz) {
            isPass = (score === totalQuestions);
        } else {
            // ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
            isPass = score >= passingScore;
        }

        const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const resultText = isPass ? '‡∏ú‡πà‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
        
        passFailHTML = `<p class="text-2xl font-bold mt-2 px-4 py-1 rounded-full inline-block ${resultClass}">${resultText}</p>`;
    }
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

    let resultHTML = `
        <div class="text-center p-8 bg-indigo-100 rounded-lg">
            <i class="fas fa-award text-5xl text-indigo-500 mb-4"></i>
            <p class="text-gray-600 mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö: <span class="font-semibold text-indigo-800">${currentStudentName}</span></p>
            <h3 class="text-2xl font-bold text-indigo-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
            <p class="text-gray-700 mb-2">‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</p>
            <p class="text-5xl font-bold my-2">${score} <span class="text-2xl font-normal text-gray-600">/ ${totalQuestions}</span></p>
            ${passFailHTML}
            <p class="text-lg font-semibold text-blue-600 mt-2">+${points} Points</p>
            <p class="text-xl">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô ${percentage.toFixed(0)}%</p>
            <div id="earned-badges-container" class="mt-4 flex justify-center gap-4 flex-wrap"></div>
        </div>
    `;
    studentResultArea.innerHTML = resultHTML;
    renderEarnedBadges(earnedBadges, 'earned-badges-container');
    studentResultArea.classList.remove('hidden');
    studentQuizArea.classList.add('hidden');
    
    setupResultScreenBackButton();
}

        function displaySubmissionConfirmation() {
    let resultHTML = `
        <div class="text-center p-8 bg-green-100 rounded-lg">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <p class="text-gray-600 mb-2">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö: <span class="font-semibold text-green-800">${currentStudentName}</span></p>
            <h3 class="text-2xl font-bold text-green-800 mb-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
            <p class="text-gray-600">‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>

            <div class="mt-6 pt-6 border-t flex justify-center">
                <button id="back-to-home-manual-release" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                    <i class="fas fa-home mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                </button>
            </div>
        </div>
    `;
    studentResultArea.innerHTML = resultHTML;
    studentResultArea.classList.remove('hidden');
    studentQuizArea.classList.add('hidden');

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
    document.getElementById('back-to-home-manual-release').addEventListener('click', () => {
        showView('student');
        document.getElementById('quiz-id-input').value = '';
    });
}

        function renderEarnedBadges(badgeIds, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !badgeIds || badgeIds.length === 0) return;

            let badgesHTML = '';
            badgeIds.forEach((badgeId, index) => {
                const badgeInfo = Object.values(BADGES).find(b => b.id === badgeId);
                if (badgeInfo) {
                    badgesHTML += `
                        <div class="badge-icon text-center p-2 bg-white rounded-lg shadow" style="animation-delay: ${index * 0.2}s;" title="${badgeInfo.description}">
                            <i class="fas ${badgeInfo.icon} text-3xl"></i>
                            <p class="text-xs font-semibold mt-1">${badgeInfo.name}</p>
                        </div>
                    `;
                }
            });
            container.innerHTML = badgesHTML;
        }

        // --- Presentation Mode Functions ---
        function startPresentation(quizData) {
            currentQuizData = getShuffledQuiz(quizData); // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô quizData
            currentPresentationSlide = 0;
            presentationModal.style.display = 'flex'; // Use style to show
            renderPresentationSlide(currentPresentationSlide);
        }

        function closePresentation() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            presentationModal.style.display = 'none';
        }

        function renderPresentationSlide(index) {
            const container = document.getElementById('presentation-slide-container');
            if (!currentQuizData || !currentQuizData.questions || !currentQuizData.questions[index]) {
                container.innerHTML = `<p class="text-2xl">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</p>`;
                return;
            }
            const question = currentQuizData.questions[index];
            const questionType = question.questionType || currentQuizData.quizType;
            
            container.innerHTML = ''; // Clear previous slide

            let slideHTML = `
                <div class="bg-white text-gray-800 p-6 md:p-12 rounded-2xl shadow-2xl w-full h-full max-h-[90vh] overflow-y-auto fade-in flex flex-col justify-center">
                    ${question.imageCode ? `<div class="my-4 flex justify-center">${question.imageCode}</div>` : ''}
                    <p class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-6 md:mb-12 leading-relaxed text-center">${index + 1}. ${question.stem || question.questionText}</p>
                    <div id="presentation-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 items-stretch justify-center">
            `;

            switch(questionType) {
                case 'matching_item':
                    slideHTML += question.allResponses.map((resp) => `
                        <button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center">
                            ${resp}
                        </button>
                    `).join('');
                    break;
                case 'true_false':
                    slideHTML += `<button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center" data-answer="true">‡πÉ‡∏ä‡πà</button>`;
                    slideHTML += `<button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center" data-answer="false">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</button>`;
                    break;
                case 'fill_in_no_choices':
                case 'short_answer':
                     slideHTML += `
                        <div class="w-full md:col-span-2">
                            <textarea id="presentation-short-answer-input" class="w-full p-4 text-2xl border-2 border-gray-300 rounded-lg bg-white text-gray-800" rows="2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                            <button id="check-presentation-answer-btn" class="mt-4 bg-blue-600 text-white py-3 px-6 rounded-lg text-xl hover:bg-blue-700">
                                <i class="fas fa-check"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                            </button>
                            <div id="presentation-ai-result" class="hidden mt-4 text-2xl font-bold"></div>
                        </div>
                    `;
                    break;
                case 'fill_in_the_blank':
                case 'multiple_choice':
                default:
                    slideHTML += question.options.map((opt, i) => `
                        <button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center" data-index="${i}">
                            ${opt}
                        </button>
                    `).join('');
                    break;
            }

            slideHTML += `
                    </div>
                    <div id="presentation-explanation" class="hidden mt-8 p-4 bg-blue-50 text-blue-800 rounded-lg text-left text-lg md:text-xl max-w-4xl mx-auto leading-relaxed">
                        <strong class="font-bold">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> ${question.explanation || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}
                    </div>
                </div>
            `;
            
            container.innerHTML = slideHTML;
            if (window.MathJax) window.MathJax.typesetPromise([container]);

            document.querySelectorAll('.presentation-option').forEach(btn => {
                btn.addEventListener('click', (e) => revealAnswerForPresentation(index, e.currentTarget));
            });
            
            const checkBtn = document.getElementById('check-presentation-answer-btn');
            if (checkBtn) {
                checkBtn.addEventListener('click', () => checkShortAnswerForPresentation(index));
            }

            document.getElementById('slide-counter').textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1} / ${currentQuizData.questions.length}`;
            document.getElementById('prev-question-btn').disabled = index === 0;
            document.getElementById('next-question-btn').disabled = index === currentQuizData.questions.length - 1;
        }
        
        async function checkShortAnswerForPresentation(questionIndex) {
    const question = currentQuizData.questions[questionIndex];
    const input = document.getElementById('presentation-short-answer-input');
    const checkBtn = document.getElementById('check-presentation-answer-btn');
    const resultContainer = document.getElementById('presentation-ai-result');
    const explanationContainer = document.getElementById('presentation-explanation');

    if (!input || !checkBtn || !resultContainer || !explanationContainer) return;

    const userAnswer = input.value.trim();
    if (userAnswer === '') {
        return;
    }

    checkBtn.disabled = true;
    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à...';
    input.disabled = true;

    // --- ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    const isCorrect = await gradeShortAnswer(userAnswer, question);
    // -------------------------

    if (isCorrect) {
        resultContainer.innerHTML = '<span class="text-green-500"><i class="fas fa-check-circle"></i> ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>';
    } else {
        resultContainer.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span> (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á: ${question.idealAnswer})`;
    }
    
    resultContainer.classList.remove('hidden');
    explanationContainer.classList.remove('hidden');
    checkBtn.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß
}

        function revealAnswerForPresentation(questionIndex, selectedButton) {
            const question = currentQuizData.questions[questionIndex];
            const questionType = question.questionType || currentQuizData.quizType;
            
            document.querySelectorAll('.presentation-option').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-indigo-100');
                
                let isCorrect = false;
                if(questionType === 'multiple_choice' || questionType === 'fill_in_the_blank') {
                    const optionIndex = parseInt(btn.dataset.index);
                    isCorrect = optionIndex === question.correctAnswerIndex;
                } else if (questionType === 'true_false') {
                    const optionAnswer = btn.dataset.answer === 'true';
                    isCorrect = optionAnswer === question.correctAnswer;
                } else if (questionType === 'matching_item') {
                    isCorrect = btn.textContent.trim() === question.correctResponse;
                }

                if (isCorrect) {
                    btn.classList.add('bg-green-500', 'text-white', 'border-green-700');
                } else {
                    btn.classList.add('opacity-50');
                }
            });
            
            selectedButton.classList.remove('opacity-50');

            let wasSelectionCorrect = false;
            if (questionType === 'multiple_choice') {
                wasSelectionCorrect = parseInt(selectedButton.dataset.index) === question.correctAnswerIndex;
            } else if (questionType === 'true_false') {
                wasSelectionCorrect = (selectedButton.dataset.answer === 'true') === question.correctAnswer;
            } else if (questionType === 'matching_item') {
                wasSelectionCorrect = selectedButton.textContent.trim() === question.correctResponse;
            }

            if (!wasSelectionCorrect) {
                selectedButton.classList.add('bg-red-500', 'text-white', 'border-red-700');
            }


            document.getElementById('presentation-explanation').classList.remove('hidden');
        }

        // --- Timer Functions ---
        function startWholeQuizTimer(durationInMinutes) {
            const timerContainer = document.getElementById('timer-container');
            if (!timerContainer) return;

            const endTime = Date.now() + durationInMinutes * 60 * 1000;
            timerContainer.innerHTML = `
                <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                    <span class="font-semibold text-indigo-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                    <span id="countdown-display" class="font-bold text-lg text-red-600">--:--</span>
                </div>
            `;
            const countdownDisplay = document.getElementById('countdown-display');

            quizTimerInterval = setInterval(() => {
                const remaining = endTime - Date.now();
                if (remaining <= 0) {
                    clearInterval(quizTimerInterval);
                    countdownDisplay.textContent = "00:00";
                    showMessage("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...");
                    handleSubmitQuiz(null); // Auto-submit
                } else {
                    const minutes = Math.floor((remaining / 1000 / 60) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((remaining / 1000) % 60).toString().padStart(2, '0');
                    countdownDisplay.textContent = `${minutes}:${seconds}`;
                }
            }, 1000);
        }

        function renderPerQuestionView() {
    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
    
    const q = currentDisplayedQuiz.questions[currentQuestionIndex];
    const questionType = q.questionType || currentDisplayedQuiz.quizType;

    let html = `
        <div class="flex justify-between items-center mb-2">
            <p class="text-sm text-gray-500">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentQuestionIndex + 1} ‡∏à‡∏≤‡∏Å ${currentDisplayedQuiz.questions.length}</p>
            ${currentMode === 'admin-testing' ? '<button id="cancel-test-btn" class="text-sm text-gray-500 hover:text-red-600 font-semibold py-1 px-2 rounded-md hover:bg-red-50"><i class="fas fa-times-circle mr-1"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>' : ''}
        </div>
        <h3 class="text-xl font-bold mb-2 text-center">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${currentDisplayedQuiz.topic}</h3>
        
        <div id="per-question-timer-container" class="mb-4"></div>

        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <div class="font-semibold mb-3" id="per-question-text">
            </div>
            <div class="space-y-2" id="per-question-options">
            </div>
        </div>
        <button id="next-question-timed-btn" class="w-full mt-4 bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700">
            <i class="fas fa-arrow-right mr-2"></i>
            ${currentQuestionIndex === currentDisplayedQuiz.questions.length - 1 ? '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö' : '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'}
        </button>
    `;
    studentQuizArea.innerHTML = html;
    
    let questionTextHTML = '';
    let optionsHTML = '';

    switch (questionType) {
        case 'matching_item':
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.stem}`;
            optionsHTML = `
               <select name="question_single" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö --</option>
                    ${q.allResponses.map(resp => `<option value="${resp}">${resp}</option>`).join('')}
                </select>
            `;
            break;
        case 'true_false':
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.questionText}`;
            optionsHTML = `
                <div><input type="radio" id="q_opt_true" name="question_single" value="true" class="mr-2 accent-indigo-600" required><label for="q_opt_true">‡πÉ‡∏ä‡πà</label></div>
                <div><input type="radio" id="q_opt_false" name="question_single" value="false" class="mr-2 accent-indigo-600" required><label for="q_opt_false">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</label></div>
            `;
            break;
        case 'short_answer':
        case 'fill_in_no_choices':
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.questionText}`;
            optionsHTML = `<textarea id="per-q-textarea" name="question_single_text" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>`;
            break;
        case 'multiple_choice':
        case 'fill_in_with_choices':
        default:
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.questionText}`;
            optionsHTML = q.options.map((opt, optionIndex) => `
                <div>
                    <input type="radio" id="q_opt${optionIndex}" name="question_single" value="${optionIndex}" class="mr-2 accent-indigo-600" required>
                    <label for="q_opt${optionIndex}">${opt}</label>
                </div>
            `).join('');
            break;
    }
    
    if (q.imageCode) {
        questionTextHTML += `<div class="my-4 flex justify-center">${q.imageCode}</div>`;
    }
    document.getElementById('per-question-text').innerHTML = questionTextHTML;
    document.getElementById('per-question-options').innerHTML = optionsHTML;

    if (currentMode === 'admin-testing') {
        const cancelBtn = document.getElementById('cancel-test-btn');
        if(cancelBtn) cancelBtn.addEventListener('click', cancelAdminTest);
    }

    document.getElementById('next-question-timed-btn').addEventListener('click', () => handleNextQuestionInTimedMode(false));
    if (window.MathJax) window.MathJax.typesetPromise([studentQuizArea]);

    startPerQuestionTimer();
}

        function startPerQuestionTimer() {
            const durationInSeconds = currentDisplayedQuiz.settings.timerDuration;
            const timerContainer = document.getElementById('per-question-timer-container');
            if (!timerContainer) return;

            let remainingTime = durationInSeconds;
            timerContainer.innerHTML = `
                <div id="timer-bar-container" class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="timer-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
                <p class="text-center text-sm text-gray-600 mt-1">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ <span id="per-q-countdown">${remainingTime}</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
            `;
            const timerBar = document.getElementById('timer-bar');
            const countdownDisplay = document.getElementById('per-q-countdown');

            perQuestionTimerInterval = setInterval(() => {
                remainingTime--;
                const percentage = (remainingTime / durationInSeconds) * 100;
                timerBar.style.width = `${percentage}%`;
                countdownDisplay.textContent = remainingTime;

                if (remainingTime <= 0) {
                    clearInterval(perQuestionTimerInterval);
                    showMessage("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ!");
                    handleNextQuestionInTimedMode(true); // Auto-advance, true means skipped
                }
            }, 1000);
        }
        
        function handleNextQuestionInTimedMode(wasSkipped = false) {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            let selectedAnswer = null;
            if (!wasSkipped) {
                const currentQuestion = currentDisplayedQuiz.questions[currentQuestionIndex];
                const questionType = currentQuestion.questionType || currentDisplayedQuiz.quizType;

                if (questionType === 'short_answer' || questionType === 'fill_in_no_choices') {
                    const textArea = document.querySelector('#per-question-options textarea');
                    selectedAnswer = textArea ? textArea.value.trim() : "";
                } else if (questionType === 'matching_item') {
                    const select = document.querySelector('#per-question-options select');
                    selectedAnswer = select ? select.value : "";
                }
                else {
                    const checkedRadio = document.querySelector('input[name="question_single"]:checked');
                    if (checkedRadio) {
                        const value = checkedRadio.value;
                        selectedAnswer = !isNaN(parseInt(value, 10)) && value.trim() !== '' ? parseInt(value, 10) : value;
                    }
                }
            }
            
            studentAnswersPerQuestion.push(selectedAnswer);

            currentQuestionIndex++;

            if (currentQuestionIndex >= currentDisplayedQuiz.questions.length) {
                // Quiz finished
                finalizePerQuestionQuiz();
            } else {
                // Next question
                renderPerQuestionView();
            }
        }

        async function finalizePerQuestionQuiz() {
            const hasShortAnswer = currentDisplayedQuiz.questions.some(q => q.questionType === 'short_answer');
            if (hasShortAnswer) {
                showMessage("‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡∏ô‡∏±‡∏¢...");
            } else {
                showMessage("‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...");
            }
            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ---
const quizId = currentQuizData.id;
const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, currentStudentName);
const submissionSnap = await getDoc(submissionRef);
const existingData = submissionSnap.exists() ? submissionSnap.data() : {};
const previousAttempts = existingData.attempts || [];

// --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ---
await processAndSubmitAnswers(studentAnswersPerQuestion, previousAttempts);
        }

        // --- Export Functions ---
        function getResultsFilename() {
            const quizTitle = document.getElementById('results-quiz-title').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            return `results_${quizTitle || 'quiz'}`;
        }

        function exportResultsAsImage() {
            const resultsTable = document.getElementById('results-table-container');
            showMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");
            html2canvas(resultsTable).then(canvas => {
                const link = document.createElement('a');
                link.download = `${getResultsFilename()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                messageModal.classList.add('hidden');
            });
        }

        function exportResultsAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Note: jsPDF has limited support for non-latin characters without custom fonts.
            // This will work for basic text but might not render Thai characters correctly.
            // For full Thai support, a font like 'Sarabun' would need to be embedded.
            doc.setFont('helvetica', 'normal'); 
            doc.autoTable({ html: '#results-table' });
            doc.save(`${getResultsFilename()}.pdf`);
        }

        function exportResultsAsWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + document.getElementById("results-table-container").innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = `${getResultsFilename()}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        function exportResultsAsExcel() {
            const table = document.getElementById('results-table');
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    // Escape double quotes and wrap in double quotes
                    row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
                }
                csv.push(row.join(','));
            }
            const csvFile = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv.join('\n')], {type: 'text/csv;charset=utf-8;'}); // Add BOM for Excel
            const link = document.createElement('a');
            link.href = URL.createObjectURL(csvFile);
            link.download = `${getResultsFilename()}.csv`;
            link.click();
        }
		
		// --- Export Functions ---
        // OLD FUNCTION: function getResultsFilename() { ... }
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ

        // REFACTORED exportResultsAsImage to exportTableAsImage
        function exportTableAsImage(containerId, filename) {
            const element = document.getElementById(containerId);
            if (!element) {
                showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export");
                return;
            }
            showMessage("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                messageModal.classList.add('hidden');
            });
        }

        // REFACTORED exportResultsAsPDF to exportTableAsPDF
        function exportTableAsPDF(tableId, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('helvetica', 'normal'); 
            doc.autoTable({ html: `#${tableId}` });
            doc.save(`${filename}.pdf`);
        }

        // REFACTORED exportResultsAsWord to exportTableAsWord
        function exportTableAsWord(containerId, filename) {
            const element = document.getElementById(containerId);
            if (!element) {
                showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export");
                return;
            }
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + element.innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = `${filename}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        // REFACTORED exportResultsAsExcel to exportTableAsExcel
        function exportTableAsExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export");
                return;
            }
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
                }
                csv.push(row.join(','));
            }
            const csvFile = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv.join('\n')], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(csvFile);
            link.download = `${filename}.csv`;
            link.click();
        }

        // --- Analytics Rendering ---
        function renderAnalytics(quizData, submissions) {
            const totalStudents = currentProjectData.students.length;
            const submittedCount = submissions.length;
            const notSubmittedCount = totalStudents - submittedCount;
            const submissionRate = totalStudents > 0 ? (submittedCount / totalStudents) * 100 : 0;
            
            const scores = submissions.map(s => s.latestScore);
            const averageScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            const totalQuestions = quizData.questions.length;
            const averagePercentage = totalQuestions > 0 ? (averageScore / totalQuestions) * 100 : 0;

            // Render summary cards
            const summaryContainer = document.getElementById('analytics-summary-cards');
            summaryContainer.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-blue-700 font-semibold">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</p>
                    <p class="text-2xl font-bold text-blue-900">${submissionRate.toFixed(0)}%</p>
                    <p class="text-xs text-blue-600">(${submittedCount}/${totalStudents} ‡∏Ñ‡∏ô)</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-green-700 font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                    <p class="text-2xl font-bold text-green-900">${averageScore.toFixed(2)}</p>
                    <p class="text-xs text-green-600">(${averagePercentage.toFixed(0)}%)</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-yellow-700 font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
                    <p class="text-2xl font-bold text-yellow-900">${scores.length > 0 ? Math.max(...scores) : 'N/A'}</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-red-700 font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</p>
                    <p class="text-2xl font-bold text-red-900">${scores.length > 0 ? Math.min(...scores) : 'N/A'}</p>
                </div>
            `;

            // Render charts
            const students = currentProjectData.students || [];
            renderSubmissionChart(submittedCount, notSubmittedCount, submissions, students);
            renderScoreDistributionChart(submissions, totalQuestions);
            renderQuestionAnalytics(quizData, submissions, students);
        }

        function renderSubmissionChart(submittedCount, notSubmittedCount, submissions, students) {
            const ctx = document.getElementById('submission-status-chart').getContext('2d');
            const submittedNames = submissions.map(s => s.studentName);
            const notSubmittedNames = students.filter(name => !submittedNames.includes(name));

            if (chartInstances.submission) {
                chartInstances.submission.destroy();
            }
            chartInstances.submission = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á'],
                    datasets: [{
                        data: [submittedCount, notSubmittedCount],
                        backgroundColor: ['#10B981', '#F59E0B'],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                },
                                afterLabel: function(context) {
                                    let names;
                                    if (context.dataIndex === 0) { // Submitted
                                        names = submittedNames;
                                    } else { // Not Submitted
                                        names = notSubmittedNames;
                                    }
                                    return names.length > 0 ? names.join('\n') : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderScoreDistributionChart(submissions, totalQuestions) {
            const ctx = document.getElementById('score-distribution-chart').getContext('2d');
            const scoreCounts = {};
            for (let i = 0; i <= totalQuestions; i++) {
                scoreCounts[i] = 0;
            }
            submissions.forEach(sub => {
                if (scoreCounts[sub.latestScore] !== undefined) {
                    scoreCounts[sub.latestScore]++;
                }
            });

            if (chartInstances.score) {
                chartInstances.score.destroy();
            }
            chartInstances.score = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(scoreCounts),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                        data: Object.values(scoreCounts),
                         backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            title: { display: true, text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const score = context.label;
                                    const studentsWithScore = submissions
                                        .filter(s => s.latestScore == score)
                                        .map(s => s.studentName);
                                    return studentsWithScore.length > 0 ? studentsWithScore.join('\n') : '';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderQuestionAnalytics(quizData, submissions, students) {
    const container = document.getElementById('question-analytics-container');
    if (students.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠</p>';
        return;
    }

    let html = '';
    const submittedNames = submissions.map(s => s.studentName);

    quizData.questions.forEach((q, index) => {
        let correctCount = 0;
        const correctStudents = [];
        const incorrectStudents = [];
        const questionDisplayText = q.stem || q.questionText || q.instructions;

        submissions.forEach(sub => {
            // Use the latest attempt for analytics
            const latestAttempt = sub.attempts[sub.attempts.length - 1];
            if (latestAttempt && latestAttempt.answers) {
                
                // --- [‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ---
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà (index)
                const studentAnswerForThisQuestion =
    latestAttempt.answers.find(ans => ans.originalQuestionText === questionDisplayText)
    ?? latestAttempt.answers[index] ?? null;

                if (studentAnswerForThisQuestion) {
                    if (studentAnswerForThisQuestion.isCorrect) {
                        correctCount++;
                        correctStudents.push(sub.studentName);
                    } else {
                        incorrectStudents.push(sub.studentName);
                    }
                }
            }
        });

        const unsubmittedStudents = students.filter(name => !submittedNames.includes(name));
        const correctRate = submissions.length > 0 ? (correctCount / submissions.length) * 100 : 0;

        html += `
            <details class="bg-gray-50 p-3 rounded-lg">
                <summary class="flex justify-between items-center cursor-pointer font-semibold">
                    <span class="w-3/4 truncate">‡∏Ç‡πâ‡∏≠ ${index + 1}: ${questionDisplayText}</span>
                     <div class="flex items-center gap-4">
                       <span class="text-sm font-normal px-2 py-1 rounded ${correctRate >= 70 ? 'bg-green-200 text-green-800' : correctRate >= 40 ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800'}">
                           ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å ${correctRate.toFixed(0)}%
                       </span>
                       <i class="fas fa-chevron-right details-marker"></i>
                    </div>
                </summary>
                <div class="mt-3 pt-3 border-t text-sm space-y-2">
                    <p><strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</strong> ${questionDisplayText}</p>
                    <p><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:</strong> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${correctCount} ‡∏à‡∏≤‡∏Å ${submissions.length} ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å</p>
                    <div class="mt-2">
                        <p class="font-semibold text-green-700">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å (${correctStudents.length} ‡∏Ñ‡∏ô):</p>
                        <p class="text-xs text-gray-600 pl-2">${correctStudents.length > 0 ? correctStudents.join(', ') : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                    </div>
                    <div class="mt-2">
                        <p class="font-semibold text-red-700">‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î (${incorrectStudents.length} ‡∏Ñ‡∏ô):</p>
                        <p class="text-xs text-gray-600 pl-2">${incorrectStudents.length > 0 ? incorrectStudents.join(', ') : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                    </div>
                    <div class="mt-2">
                        <p class="font-semibold text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á (${unsubmittedStudents.length} ‡∏Ñ‡∏ô):</p>
                        <p class="text-xs text-gray-600 pl-2">${unsubmittedStudents.length > 0 ? unsubmittedStudents.join(', ') : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                    </div>
                </div>
            </details>
        `;
    });
    container.innerHTML = html;
    // Re-render MathJax for dynamically injected analytics content
    try {
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise([container]);
        }
    } catch (e) {
        console.error('MathJax typeset error (analytics):', e);
    }
}

        async function handleAnalyzeClass() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!currentQuizData || !currentQuizData.id) {
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô");
        return;
    }

    const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${currentQuizData.id}/submissions`);
    const submissionsSnapshot = await getDocs(submissionsRef);
    const submissions = submissionsSnapshot.docs.map(doc => doc.data());

    if (submissions.length < 2) {
        showMessage("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ");
        return;
    }

    const analysisContainer = document.getElementById('strength-weakness-analysis-container');
    analysisContainer.innerHTML = `
        <div class="text-center py-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°... ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
    `;
    document.getElementById('analyze-strengths-btn').disabled = true;

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI
    const studentDataSummary = submissions.map((sub, index) => {
        const latestAttempt = sub.attempts[sub.attempts.length - 1];
        if (!latestAttempt) return ''; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
        return `
            ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${index + 1} (${sub.studentName}):
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${latestAttempt.score}/${sub.totalQuestions}
            ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠: ${JSON.stringify(latestAttempt.answers)}
        `;
    }).join('\n---\n');

    const analysisPrompt = `
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö

        ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: "${currentQuizData.topic}"
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${JSON.stringify(currentQuizData.questions)}

        ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á:
        ${studentDataSummary}

        ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
        - classStrengths: ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏õ‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (array ‡∏Ç‡∏≠‡∏á string)
        - classWeaknesses: ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (array ‡∏Ç‡∏≠‡∏á string)
        - teacherSuggestions: ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ 2-3 ‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ (array ‡∏Ç‡∏≠‡∏á string)

        ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    `;

    const analysisSchema = {
        type: "OBJECT",
        properties: {
            classStrengths: { type: "ARRAY", items: { type: "STRING" } },
            classWeaknesses: { type: "ARRAY", items: { type: "STRING" } },
            teacherSuggestions: { type: "ARRAY", items: { type: "STRING" } }
        },
        required: ["classStrengths", "classWeaknesses", "teacherSuggestions"]
    };

    try {
        const analysisResult = await callAnalysisApi(analysisPrompt, analysisSchema);
        displayClassAnalysis(analysisResult);
    } catch (error) {
        console.error("Error during class analysis:", error);
        analysisContainer.innerHTML = `<div class="text-red-500 text-center"><p>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}</p></div>`;
    } finally {
        document.getElementById('analyze-strengths-btn').disabled = false;
    }
}
function displayClassAnalysis(data) {
    const analysisContainer = document.getElementById('strength-weakness-analysis-container');
    if (!data) {
        analysisContainer.innerHTML = '<p class="text-center text-red-500">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI</p>';
        return;
    }
    analysisContainer.innerHTML = `
        <div class="fade-in space-y-4 mt-4 border-t pt-4">
            <div>
                <h4 class="text-lg font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-2"></i>‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                <ul class="list-disc list-inside space-y-1 bg-green-50 p-3 rounded-lg text-green-800">
                    ${data.classStrengths.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
             <div>
                <h4 class="text-lg font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô / ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢</h4>
                <ul class="list-disc list-inside space-y-1 bg-red-50 p-3 rounded-lg text-red-800">
                    ${data.classWeaknesses.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
             <div>
                <h4 class="text-lg font-semibold text-blue-700 mb-2"><i class="fas fa-chalkboard-teacher mr-2"></i>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h4>
                <ul class="list-disc list-inside space-y-1 bg-blue-50 p-3 rounded-lg text-blue-800">
                   ${data.teacherSuggestions.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
}
function formatAndPrintWorksheet(quizData, worksheetWindow) { 
    const worksheetHtml = `
        <!DOCTYPE html>
        <html lang="th">
        <head>
            <meta charset="UTF-8">
            <title>‡πÉ‡∏ö‡∏á‡∏≤‡∏ô: ${quizData.topic}</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Sarabun', sans-serif; }
                @media print {
                    body { -webkit-print-color-adjust: exact; }
                    .no-print { display: none; }
                }
                .question-item { page-break-inside: avoid; }
                .answer-line {
                    border-bottom: 1px dotted black;
                    display: inline-block;
                    width: 80%;
                    margin-left: 1rem;
                }
            </style>
        </head>
        <body class="p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${quizData.topic}</h1>
            </div>
            <div class="flex justify-between mb-8 text-lg">
                <p>‡∏ä‡∏∑‡πà‡∏≠: ....................................................................</p>
                <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ......./......./.........</p>
                <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: .................</p>
            </div>
            <div class="space-y-6">
                ${quizData.questions.map((q, index) => `
                    <div class="question-item">
                        <p class="text-lg font-semibold mb-2">${index + 1}. ${q.questionText}</p>
                        ${q.imageCode ? `<div class="my-2 flex justify-center">${q.imageCode}</div>` : ''}
                        <div class="mt-4">
                            <p><strong>‡∏ï‡∏≠‡∏ö:</strong> <span class="answer-line"></span></p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </body>
        </html>
    `;
    worksheetWindow.document.write(worksheetHtml);
    worksheetWindow.document.close();
    worksheetWindow.onload = function() {
        worksheetWindow.print();
    };
}
async function generateWorksheet() {
    const topic = document.getElementById('worksheet-topic-input').value.trim();
    if (!topic) {
        showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô");
        return;
    }

    // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤] ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Checkbox ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á ---
    // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞)
const isNormalTopic = document.getElementById('force-math-checkbox').checked;
const subjectPrefix = isNormalTopic ? "" : "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå";
    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ---

    const worksheetWindow = window.open('', '_blank');
    worksheetWindow.document.write('<h1></h1>');
    
    const numQuestions = parseInt(document.getElementById('num-questions').value);
    const includeImages = document.getElementById('include-images-checkbox').checked;
    const imageInstruction = includeImages ? `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏Ç‡πâ‡∏≠ ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏î‡πâ‡∏ß‡∏¢` : '';

    // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° subjectPrefix ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô prompt ---
    const prompt = `
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô${subjectPrefix}‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${numQuestions} ‡∏Ç‡πâ‡∏≠ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${topic}". 
        ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡∏¥‡∏î, ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ 
        ${imageInstruction}

        ‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
        - topic: ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô
        - questions: array ‡∏Ç‡∏≠‡∏á object ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÇ‡∏î‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞ object ‡∏°‡∏µ:
          - questionText: (string) ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
          - imageCode: (string, optional) ‡πÇ‡∏Ñ‡πâ‡∏î SVG ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    `;

    const schema = {
        type: "OBJECT",
        properties: {
            topic: { type: "STRING" },
            questions: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        questionText: { type: "STRING" },
                        imageCode: { type: "STRING" }
                    },
                    required: ["questionText"]
                }
            }
        },
        required: ["topic", "questions"]
    };

    document.getElementById('loader-text').textContent = '';
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    generateWorksheetBtn.disabled = true;

    try {
        const worksheetData = await callAnalysisApi(prompt, schema);
        
        formatAndPrintWorksheet(worksheetData, worksheetWindow);
    } catch (error) {
        console.error("Error generating worksheet:", error);
        if (worksheetWindow) worksheetWindow.close();
        showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô");
    } finally {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('quiz-generation-area').classList.add('hidden');
        generateWorksheetBtn.disabled = false;
    }
}

async function callAnalysisApi(prompt, schema) {
    const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: schema
        }
    };
    const apiKey = "AIzaSyBgBJ28OshxBTnqUzCKsv7nve2Xj899fwA"; // Provided by environment
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!response.ok) {
        throw new Error(`API call failed with status: ${response.status}`);
    }
    const result = await response.json();
    
    if (result.candidates?.[0]?.content?.parts?.[0]) {
        return JSON.parse(result.candidates[0].content.parts[0].text);
    } else {
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà AI ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Error ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
        let detailedError = "Invalid response structure from AI.";
        
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà Prompt ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        if (result.promptFeedback?.blockReason) {
            detailedError = `AI request was blocked. Reason: ${result.promptFeedback.blockReason}.`;
        
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)
        } else if (result.candidates?.[0]?.finishReason && result.candidates[0].finishReason !== "STOP") {
            detailedError = `AI generation finished with an issue. Reason: ${result.candidates[0].finishReason}.`;
        }
        
        console.error(detailedError, JSON.stringify(result));
        throw new Error(detailedError);
        // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
    }
}
        // --- Init ---
        initialize();

    </script>
</body>
</html>